<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="ga.certificate">
	<select id="selectCertificateList" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			SELECT A.SEQ_NO SEQ_NO,
			       GET_DEPT_NAME(A.DEPTID) DEPTNAME,
			       A.CERTIFICATE_ID CERTIFICATE_ID,
			       TO_CHAR(A.ISSUE_DATE, 'YYYY-MM-DD') ISSUE_DATE,
			       A.ISSUING_AUTHORITY ISSUING_AUTHORITY,
			       TO_CHAR(NVL(DECODE(C.PERIOD_UNIT,
			                          'checkUnit001',
			                          (C.NOVATION_DATE + C.PERIOD_NUM),
			                          'checkUnit002',
			                          (C.NOVATION_DATE + (C.PERIOD_NUM * 7)),
			                          'checkUnit003',
			                          ADD_MONTHS(C.NOVATION_DATE, C.PERIOD_NUM),
			                          'checkUnit004',
			                          ADD_MONTHS(C.NOVATION_DATE, (C.PERIOD_NUM * 12))),
			                   A.NOVATION_DATE),
			               'YYYY-MM-DD') NOVATION_DATE,
			       GET_EMP_NAME(A.SUPERINTEND) SUPERINTEND,
			       A.REMARK REMARK,
			       C.PERIOD_NUM PERIOD_NUM,
			       C.PERIOD_UNIT PERIOD_UNIT,
			       GET_CODE_NAME(C.PERIOD_UNIT) PERIOD_UNIT_NAME,
			       NVL(TO_CHAR(C.NOVATION_DATE, 'YYYY-MM-DD'),
			           TO_CHAR(A.ISSUE_DATE, 'YYYY-MM-DD')) ISSUED_DATE,
			       TO_CHAR(C.NOVATION_DATE, 'YYYY-MM-DD') NOVATIONED_DATE
			  FROM GA_CERTIFICATE A,
			       (SELECT DISTINCT B.CERTIFICATE_NO CERTIFICATE_NO,
			                        B.PERIOD_NUM     PERIOD_NUM,
			                        B.PERIOD_UNIT    PERIOD_UNIT,
			                        B.NOVATION_DATE  NOVATION_DATE
			          FROM GA_CERTIFICATE_NOVATION B
			         WHERE B.CREATE_DATE =
			               (SELECT MAX(Z.CREATE_DATE)
			                  FROM GA_CERTIFICATE_NOVATION Z
			                 WHERE Z.CERTIFICATE_NO = B.CERTIFICATE_NO)) C
			 WHERE A.ACTIVITY = 1
			   AND A.SEQ_NO = C.CERTIFICATE_NO
	  	]]>
		<isNotEmpty prepend="" property="startDate">
			<isNotEmpty prepend="AND" property="endDate">
				<![CDATA[		   
				 		NVL(DECODE(C.PERIOD_UNIT,
			                       'checkUnit001',
			                       (C.NOVATION_DATE + C.PERIOD_NUM),
			                       'checkUnit002',
			                       (C.NOVATION_DATE + (C.PERIOD_NUM * 7)),
			                       'checkUnit003',
			                       ADD_MONTHS(C.NOVATION_DATE, C.PERIOD_NUM),
			                       'checkUnit004',
			                       ADD_MONTHS(C.NOVATION_DATE, (C.PERIOD_NUM * 12))),
			            A.NOVATION_DATE) BETWEEN TO_DATE(#startDate:VARCHAR#,'YYYY-MM-DD') AND TO_DATE(#endDate:VARCHAR#,'YYYY-MM-DD')+1
				]]>	
			</isNotEmpty>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="seqNo">
				<![CDATA[		   
				 	A.SEQ_NO = #seqNo:VARCHAR#
				]]>	
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="cpnyId">
				<![CDATA[		   
				 	A.CPNY_ID = #cpnyId:VARCHAR#
				]]>	
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="deptId">
				<![CDATA[		   
				 	A.DEPTID = #deptId:VARCHAR#
				]]>	
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="certName">
				<![CDATA[		   
				 	A.CERTIFICATE_ID = #certName:VARCHAR#
				]]>	
		</isNotEmpty>
	</select>
	
	<select id="selectCertificateCount" parameterClass="SimpleMap" resultClass="int">
		<![CDATA[
			SELECT COUNT(*) CUT
			  FROM GA_CERTIFICATE A,
			       (SELECT DISTINCT B.CERTIFICATE_NO CERTIFICATE_NO,
			                        B.PERIOD_NUM     PERIOD_NUM,
			                        B.PERIOD_UNIT    PERIOD_UNIT,
			                        B.NOVATION_DATE  NOVATION_DATE
			          FROM GA_CERTIFICATE_NOVATION B
			         WHERE B.CREATE_DATE =
			               (SELECT MAX(Z.CREATE_DATE)
			                  FROM GA_CERTIFICATE_NOVATION Z
			                 WHERE Z.CERTIFICATE_NO = B.CERTIFICATE_NO)) C
			 WHERE A.ACTIVITY = 1
			   AND A.SEQ_NO = C.CERTIFICATE_NO
	  	]]>
		<isNotEmpty prepend="" property="startDate">
			<isNotEmpty prepend="AND" property="endDate">
				<![CDATA[		   
				 		NVL(DECODE(C.PERIOD_UNIT,
			                       'checkUnit001',
			                       (C.NOVATION_DATE + C.PERIOD_NUM),
			                       'checkUnit002',
			                       (C.NOVATION_DATE + (C.PERIOD_NUM * 7)),
			                       'checkUnit003',
			                       ADD_MONTHS(C.NOVATION_DATE, C.PERIOD_NUM),
			                       'checkUnit004',
			                       ADD_MONTHS(C.NOVATION_DATE, (C.PERIOD_NUM * 12))),
			            A.NOVATION_DATE) BETWEEN TO_DATE(#startDate:VARCHAR#,'YYYY-MM-DD') AND TO_DATE(#endDate:VARCHAR#,'YYYY-MM-DD')+1
				]]>	
			</isNotEmpty>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="seqNo">
				<![CDATA[		   
				 	A.SEQ_NO = #seqNo:VARCHAR#
				]]>	
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="cpnyId">
				<![CDATA[		   
				 	A.CPNY_ID = #cpnyId:VARCHAR#
				]]>	
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="deptId">
				<![CDATA[		   
				 	A.DEPTID = #deptId#
				]]>	
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="certName">
				<![CDATA[		   
				 	A.CERTIFICATE_ID = #certName:VARCHAR#
				]]>	
		</isNotEmpty>
	</select>
	
	<select id="getCertificateName" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			SELECT DISTINCT
			       A.CERTIFICATE_ID ID,
			       A.CERTIFICATE_ID NAME
			  FROM GA_CERTIFICATE A
			 WHERE A.ACTIVITY = 1
			   AND A.CPNY_ID = #cpnyId#
		]]>	
	</select>
	
	<select id="getCertificateUpdateHistory" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			SELECT GET_DEPT_NAME(B.DEPTID) DEPTNAME,
			       B.CERTIFICATE_ID CERTIFICATE_ID,
			       B.ISSUE_DATE ISSUE_DATE,
			       B.ISSUING_AUTHORITY ISSUING_AUTHORITY,
			       B.NOVATION_DATE NOVATION_DATE,
			       GET_EMP_NAME(B.SUPERINTEND) SUPERINTEND,
			       B.REMARK REMARK,
			       A.NOVATION_DATE NOVATIONED_DATE,
			       A.PERIOD_NUM PERIOD_NUM,
			       GET_CODE_NAME(A.PERIOD_UNIT) PERIOD_UNIT,
			       GET_EMP_NAME(A.CREATED_BY) UPDATED_BY
			FROM GA_CERTIFICATE_NOVATION A,
			     GA_CERTIFICATE B
			WHERE A.CERTIFICATE_NO = B.SEQ_NO
			AND   A.NOVATION_DATE IS NOT NULL
			AND   A.ACTIVITY = 1
			AND   A.CERTIFICATE_NO = #seqNo#
		]]>	
	</select>
	
	
	<insert id="insertCertificate" parameterClass="SimpleMap">
		<![CDATA[
			INSERT INTO GA_CERTIFICATE A
				  (A.SEQ_NO,
				   A.CERTIFICATE_ID,
				   A.ISSUE_DATE,
				   A.ISSUING_AUTHORITY,
				   A.NOVATION_DATE,
				   A.SUPERINTEND,
				   A.REMARK,
				   A.CREATE_DATE,
				   A.CREATED_BY,
				   A.ACTIVITY,
				   A.CPNY_ID,
				   A.DEPTID)
				VALUES
				   (GA_CERTIFICATE_SEQ.NEXTVAL,
				    #certificateId:VARCHAR#,
				    TO_DATE(#issueDate:VARCHAR#,'YYYY-MM-DD'),
				    #issuingAuthority:VARCHAR#,
				    TO_DATE(#novationDate:VARCHAR#,'YYYY-MM-DD'),
				    #personId:VARCHAR#,
				    #remark:VARCHAR#,
				    SYSDATE,
				    #adminId:VARCHAR#,
				    1,
				    #cpnyId:VARCHAR#,
				    #deptId:VARCHAR#)
		]]>
	</insert>
	
	<insert id="insertCertificateNovation" parameterClass="SimpleMap">
		<![CDATA[
			INSERT INTO GA_CERTIFICATE_NOVATION A
			  (A.SEQ_NO,
			   A.CERTIFICATE_NO,
			   A.PERIOD_NUM,
			   A.PERIOD_UNIT,
			   A.CREATE_DATE,
			   A.CREATED_BY,
			   A.ACTIVITY)
			VALUES
			  (GA_CERTIFICATE_NOVATION_SEQ.NEXTVAL,
			   GA_CERTIFICATE_SEQ.CURRVAL,
			   #periodNum:NUMERIC#,
			   #periodUnit:VARCHAR#,
			   SYSDATE,
			   #adminId:VARCHAR#,
			   1)
		]]>
	</insert>
	
	<insert id="insertCertificateNovationForUpdate" parameterClass="SimpleMap">
		<![CDATA[
			INSERT INTO GA_CERTIFICATE_NOVATION A
			  (A.SEQ_NO,
			   A.CERTIFICATE_NO,
			   A.NOVATION_DATE,
			   A.PERIOD_NUM,
			   A.PERIOD_UNIT,
			   A.CREATE_DATE,
			   A.CREATED_BY,
			   A.ACTIVITY)
			VALUES
			  (GA_CERTIFICATE_NOVATION_SEQ.NEXTVAL,
			   #seqNo:VARCAHR#,
			   TO_DATE(#updateDate:VARCHAR#,'YYYY-MM-DD'),
			   #periodNum:NUMERIC#,
			   #periodUnit:VARCHAR#,
			   SYSDATE,
			   #adminId:VARCHAR#,
			   1)
		]]>
	</insert>
	
	<update id="updateCertificate" parameterClass="SimpleMap">
		<![CDATA[
			UPDATE GA_CERTIFICATE A
   			SET A.UPDATE_DATE = SYSDATE, 
   				A.UPDATED_BY = #personId:VARCHAR#
   			WHERE A.SEQ_NO = #seqNo#
		]]>
	</update>
	
	<update id="deleteCertificate" parameterClass="SimpleMap">
		<![CDATA[
			UPDATE GA_CERTIFICATE A
			SET A.ACTIVITY = 0
			WHERE A.SEQ_NO = #seqNo#
		]]>
	</update>
	
	<update id="deleteCertificateHistroy" parameterClass="SimpleMap">
		<![CDATA[
			UPDATE GA_CERTIFICATE_NOVATION A 
			SET    A.ACTIVITY = 0 
			WHERE A.CERTIFICATE_NO = #seqNo#
		]]>
	</update>
	
</sqlMap>