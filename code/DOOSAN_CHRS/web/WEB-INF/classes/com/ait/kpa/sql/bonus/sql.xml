<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="kpa.bonus">
	<!-- retrieve RetrievePaBonus_paramList -->
	<select id="RetrievePaBonus_paramList" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			     SELECT PB.PARAM_NO,
				        PB.PARAM_NAME,
                		PB.PARAM_EN_NAME,
                		PB.PARAM_KOR_NAME,
				        PB.PARAM_ID,
				        PB.DISTINCT_FIELD,
				        PB.DISTINCT_FIELD_2ND,
				        PB.DATA_TYPE,
				        PB.DESCR,
				        PD.FIELD_NAME AS DISTINCT_NAME,
				        DECODE(PB.DISTINCT_FIELD, 'EMPID', PD3.FIELD_NAME, NVL(PD2.FIELD_NAME, '')) AS DISTINCT_NAME_2ND
				   FROM KPA_BONUS_PARAM_ITEM PB, KPA_DISTINCT_LIST PD, KPA_DISTINCT_LIST PD2,
				        (SELECT T.FIELD_NAME FROM KPA_DISTINCT_LIST T WHERE T.DISTINCT_FIELD = 'CHINESENAME') PD3
				  WHERE PB.DISTINCT_FIELD = PD.DISTINCT_FIELD
				    AND PB.DISTINCT_FIELD_2ND = PD2.DISTINCT_FIELD(+)
		]]>
		
		<isNotEmpty prepend="AND" property="param_no">
		<![CDATA[	 
		 	PB.PARAM_NO = #param_no:NUMERIC#
	    ]]>
		</isNotEmpty>
		
		<![CDATA[	     
			   ORDER BY PB.PARAM_NO
		]]>	
		
	</select>
	
	<!-- retrieve ValidatePaBonusParamItemId -->
	<select id="ValidatePaBonusParamItemId" parameterClass="SimpleMap" resultClass="int">
		<![CDATA[
			     SELECT COUNT(PB.PARAM_NO)
			       FROM KPA_BONUS_PARAM_ITEM PB
                  WHERE (PB.PARAM_ID = #param_id:VARCHAR# 
                     OR PB.PARAM_NAME = #param_name:VARCHAR# 
                     OR INSTR(PB.PARAM_NAME,#param_name:VARCHAR#) = 1 
                     OR INSTR(#param_name:VARCHAR#,PB.PARAM_NAME) = 1
                     ) 
		]]>	
		<isNotEmpty prepend="AND" property="param_no">
			<![CDATA[	 
			 	PB.PARAM_NO <> #param_no:NUMERIC#
		    ]]>
		</isNotEmpty>
		
	</select>
	
	<!-- insert Pa Bonus Param Item -->
	<insert id="insertPaBonusParam" parameterClass="SimpleMap">
		<![CDATA[
			     INSERT INTO KPA_BONUS_PARAM_ITEM PB 
			      			   (PARAM_NO, PARAM_NAME, 
			      			    DISTINCT_FIELD, DISTINCT_FIELD_2ND, 
			      			    DATA_TYPE, DESCR, 
			      			    PARAM_EN_NAME,PARAM_KOR_NAME,PARAM_ID)
			     		VALUES (KPA_BONUS_PARAM_ITEM_SEQ.NEXTVAL, #param_name:VARCHAR#, 
			     				#distinct_field:VARCHAR#, #distinct_field_2nd:VARCHAR#, 
			     				#data_type:VARCHAR#, #descr:VARCHAR#, 
			     				#param_en_name:VARCHAR#,#param_kor_name:VARCHAR#,#param_id:VARCHAR#)
		]]>	
		
	</insert>
	
	<!-- update Pa Bonus Param Item -->
	<update id="updatePaBonusParam" parameterClass="SimpleMap">
		<![CDATA[
			     UPDATE KPA_BONUS_PARAM_ITEM PB SET  
			     		 PARAM_NAME = #param_name:VARCHAR#,
			     		 PARAM_EN_NAME = #param_en_name:VARCHAR#,
			     		 PARAM_KOR_NAME = #param_kor_name:VARCHAR#,
			     		 DISTINCT_FIELD = #distinct_field:VARCHAR#, 
			     		 DISTINCT_FIELD_2ND = #distinct_field_2nd:VARCHAR#, 
			     		 DATA_TYPE = #data_type:VARCHAR#, 
			     		 DESCR = #descr:VARCHAR#, 
			     		 PARAM_ID = #param_id:VARCHAR# 
			       WHERE PARAM_NO = #param_no:NUMERIC# 
		]]>	
		
	</update>
	
	<!-- delete pa bonus param -->
	<delete id="deletePaBonusParam" parameterClass="SimpleMap" >
		<![CDATA[
				   DELETE KPA_BONUS_PARAM_ITEM PB WHERE PB.PARAM_NO = #param_no:NUMERIC# 
		]]>
	</delete>
	
	<!-- delete pa bonus param date -->
	<delete id="deletePaBonusParamDate" parameterClass="SimpleMap" >
		<![CDATA[
				   DELETE KPA_BONUS_PARAM_DATA PB WHERE PB.PARAM_NO = #param_no:NUMERIC# 
		]]>
	</delete>

	<!-- retrieve RetrievePaBonusParamDataList -->
	<select id="RetrievePaBonusParamDataList" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			     SELECT HR.group_emp_id GROUPID,
			            PB.PARAM_DATA_NO,
				        PB.PARAM_NO,
				        PB.FIELD1_VALUE,
				        PB.RETURN_VALUE,
				        PB.FIELD2_VALUE,
				        PB.START_MONTH,
				        PB.SD_ED_VALUE,
				        PB.END_MONTH,
				        HR.EMPID,
				        HR.CHINESENAME, 
				        HR.EMPID, 
				        HR.CHINESENAME
				   FROM KPA_BONUS_PARAM_DATA PB, HR_EMPLOYEE HR
				  WHERE PB.FIELD1_VALUE = HR.EMPID(+)
				    AND KO_CALC_FLAG = 'Y' 
				    AND JOIN_TYPE_CODE = 'C_12009_1330064'
				   
		]]>
		
		<isNotEmpty prepend="AND" property="param_no">
		<![CDATA[	 
		 	PB.PARAM_NO = #param_no:NUMERIC#
	    ]]>
	    </isNotEmpty>
		
		<isNotEmpty prepend="AND" property="deptid">
		<![CDATA[	 
		 	 EXISTS ( SELECT HD.DEPTID FROM HR_DEPARTMENT HD WHERE HD.DEPTID = HR.DEPTID START WITH DEPTID = #deptid:VARCHAR#
				                CONNECT BY PRIOR DEPTID = PARENT_DEPT_ID
				    )
	    ]]>
		</isNotEmpty>
		
		<isNotEmpty prepend="AND" property="key">
		<![CDATA[	 
		 	(
		          UPPER(HR.EMPID) LIKE '%' || UPPER(#key:VARCHAR#) || '%'
		       OR HR.CHINESENAME LIKE '%' || #key:VARCHAR# || '%'
		       OR UPPER(HR.CHINESE_PINYIN) LIKE '%' || UPPER(#key:VARCHAR#) || '%'
		       
		    )
	    ]]>
		</isNotEmpty>

		<![CDATA[	     
			   ORDER BY PB.PARAM_NO
		]]>	
		
	</select>
	
	<!-- call PR_BONUS_PARAM_LIST  -->
	<procedure id="callPrBonusParamList" parameterClass="SimpleMap" >
		<![CDATA[
			{call KPR_BONUS_PARAM_LIST(#param_no:NUMERIC#)}
		]]>
	</procedure>
	
	<!-- retrieve Retrieve Pa Bonus Param Data List -->
	<select id="RetrievePaBonusParamDataForInsertList" parameterClass="SimpleMap" resultClass="SimpleMap" >
		<![CDATA[
			SELECT HR.group_emp_id GROUPID,P.FIELD1,P.FIELD2 FROM KPA_BONUS_PARAM_DATA_LIST P,HR_EMPLOYEE HR WHERE P.FIELD1 = HR.EMPID AND HR.join_type_code= 'C_12009_1330064' 
		]]>
		
		<isNotEmpty prepend="AND" property="deptid">
		<![CDATA[	 
		 	 EXISTS ( SELECT HD.DEPTID FROM HR_DEPARTMENT HD WHERE HD.DEPTID = HR.DEPTID START WITH DEPTID = #deptid:VARCHAR#
				                CONNECT BY PRIOR DEPTID = PARENT_DEPT_ID
				    )
	    ]]>
		</isNotEmpty>
		
		<isNotEmpty prepend="AND" property="key">
		<![CDATA[	 
		 	(
		          UPPER(HR.EMPID) LIKE '%' || UPPER(#key:VARCHAR#) || '%'
		       OR HR.CHINESENAME LIKE '%' || #key:VARCHAR# || '%'
		       OR UPPER(HR.CHINESE_PINYIN) LIKE '%' || UPPER(#key:VARCHAR#) || '%'
		       
		    )
	    ]]>
		</isNotEmpty>
		<![CDATA[	     
			   order by field1, field2
		]]>	
	</select>
	
	<!-- insert Pa Bonus Param item -->
	<insert id="insertPrBonusParamData" parameterClass="SimpleMap" >
		<![CDATA[
			INSERT INTO 
				KPA_BONUS_PARAM_DATA (
					PARAM_DATA_NO,
					PARAM_NO,
					FIELD1_VALUE,
					RETURN_VALUE,
					FIELD2_VALUE,
					START_MONTH,
					END_MONTH,
					SD_ED_VALUE
				)
				VALUES(
					KPA_BONUS_PARAM_DATA_SEQ.NEXTVAL,
					#param_no:NUMERIC#,
					#field1:VARCHAR#,
					#return_value:VARCHAR#,
					#field2:VARCHAR#,
					#startMonth:VARCHAR#,
					#endMonth:VARCHAR#,
					#sdEdValue:VARCHAR#
				)
			
		]]>
	</insert>
	
	<!-- retrieve Retrieve Pa Bonus Param Data List -->
	<update id="updatePrBonusParamData" parameterClass="SimpleMap" >
		<![CDATA[
			UPDATE
				KPA_BONUS_PARAM_DATA SET 
					RETURN_VALUE = #return_value:VARCHAR#,
					START_MONTH = #startMonth:VARCHAR#,
					END_MONTH = #endMonth:VARCHAR#,
					SD_ED_VALUE = #sdEdValue:VARCHAR#
			WHERE PARAM_DATA_NO = #param_data_no:NUMERIC#
		]]>
	</update>
	
	<!-- delete Pa Bonus Param Data -->
	<delete id="deletePrBonusParamData" parameterClass="SimpleMap" >
		<![CDATA[
			DELETE KPA_BONUS_PARAM_DATA 
		]]>	
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="param_no">
				PARAM_NO = #param_no:NUMERIC#
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="param_data_no">
				PARAM_DATA_NO = #param_data_no:NUMERIC#
			</isNotEmpty>
		</dynamic>
	</delete>
	
	<!-- retrieve PaBonusItemList -->
	<select id="RetrievePaBonusItemList" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			     SELECT PB.ITEM_NO,
				        PB.ITEM_NAME,
				        PB.ITEM_EN_NAME,
				        PB.ITEM_KOR_NAME,
				        PB.ITEM_TYPE,
				        ITEM_TYPE_CODE.CODE_NAME AS ITEM_TYPE_NAME,
				        PB.ITEM_ID,
				        PB.DESCR,
				        PB.CALCU_ORDER,
				        PB.PRICISION,
				        PB.CARRY_BIT,
				        PB.DATATYPE,
				        DATA_TYPE_CODE.CODE_NAME AS DATATYPE_NAME
				   FROM KPA_BONUS_ITEM PB , 
				   		SY_CODE ITEM_TYPE_CODE ,
				   		SY_CODE DATA_TYPE_CODE
				  WHERE PB.ITEM_TYPE= ITEM_TYPE_CODE.CODE_ID(+)
				    AND PB.DATATYPE= DATA_TYPE_CODE.CODE_ID(+)
		]]>
		

		<isNotEmpty prepend="AND" property="item_no">
			PB.ITEM_NO = #item_no:NUMERIC# 
		</isNotEmpty>
		
		<isNotEmpty prepend="AND" property="search">
			(PB.ITEM_NAME LIKE '%' ||  #search:VARCHAR# || '%' OR PB.ITEM_ID LIKE '%' || UPPER(#search:VARCHAR#) || '%')
		</isNotEmpty>

		<![CDATA[	     
			   ORDER BY PB.CALCU_ORDER
		]]>	
		
	</select>
	
	<!-- retrieve PaBonusItemListCnt -->
	<select id="RetrievePaBonusItemListCnt" parameterClass="SimpleMap" resultClass="int">
		<![CDATA[
			     SELECT COUNT(PB.ITEM_NO)
				   FROM KPA_BONUS_ITEM PB , 
				   		SY_CODE ITEM_TYPE_CODE ,
				   		SY_CODE DATA_TYPE_CODE
				  WHERE PB.ITEM_TYPE= ITEM_TYPE_CODE.CODE_ID(+)
				    AND PB.DATATYPE= DATA_TYPE_CODE.CODE_ID(+)
		]]>
		
		<isNotEmpty prepend="AND" property="search">
			(PB.ITEM_NAME LIKE '%' ||  #search:VARCHAR# || '%' OR PB.ITEM_ID LIKE '%' || UPPER(#search:VARCHAR#) || '%')
		</isNotEmpty>

		
	</select>
	
	<!-- Validate Pa Bonus Item Id -->
	<select id="ValidatePaBonusItemId" parameterClass="SimpleMap" resultClass="int">
		<![CDATA[
			     SELECT COUNT(PB.ITEM_NO)
			       FROM KPA_BONUS_ITEM PB
                  WHERE (PB.ITEM_ID = #item_id:VARCHAR#
                     OR PB.ITEM_NAME = #item_name:VARCHAR# 
                     OR INSTR(PB.ITEM_NAME, #item_name:VARCHAR#) = 1 
                     OR INSTR(#item_name:VARCHAR#, PB.ITEM_NAME) = 1)
		]]>	
		<isNotEmpty prepend="AND" property="item_no">
			<![CDATA[	 
			 	PB.ITEM_NO <> #item_no:NUMERIC#
		    ]]>
		</isNotEmpty>
		
	</select>
	
	<!-- insert Pa Bonus item -->
	<insert id="insertPaBonusItem" parameterClass="SimpleMap" >
		<![CDATA[
			INSERT INTO 
				KPA_BONUS_ITEM (
					ITEM_NO ,
					ITEM_NAME ,
					ITEM_EN_NAME ,
					ITEM_KOR_NAME ,
					DESCR ,
					DATATYPE ,
					CALCU_ORDER ,
					ITEM_TYPE ,
					PRICISION ,
					CARRY_BIT ,
					ITEM_ID
				)
				VALUES(
					KPA_BONUS_ITEM_SEQ.NEXTVAL,
					#item_name:VARCHAR#,
					#item_en_name:VARCHAR#,
					#item_kor_name:VARCHAR#,
					#descr:VARCHAR#,
					#datatype:VARCHAR#,
					NVL((SELECT MAX(CALCU_ORDER) FROM KPA_BONUS_ITEM),0) + 1,
					#item_type:VARCHAR#,
					#pricision:NUMERIC#,
					#carry_bit:NUMERIC#,
					#item_id:VARCHAR#
				)
			
		]]>
	</insert>
	
	<!-- update Pa Bonus item -->
	<update id="updatePaBonusItem" parameterClass="SimpleMap" >
		<![CDATA[
			UPDATE KPA_BONUS_ITEM SET
					ITEM_NAME = #item_name:VARCHAR#,
					ITEM_EN_NAME = #item_en_name:VARCHAR#,
					ITEM_KOR_NAME = #item_kor_name:VARCHAR#,
					DESCR = #descr:VARCHAR#,
					DATATYPE = #datatype:VARCHAR#,
					ITEM_TYPE = #item_type:VARCHAR#,
					PRICISION = #pricision:NUMERIC#,
					CARRY_BIT = #carry_bit:NUMERIC# ,
					ITEM_ID = #item_id:VARCHAR#
				WHERE ITEM_NO = #item_no:NUMERIC#		
		]]>
	</update>
	
	<!-- delete pa bonus item -->
	<delete id="deletePaBonusItem" parameterClass="SimpleMap" >
		<![CDATA[
				   DELETE KPA_BONUS_ITEM PB WHERE PB.ITEM_NO = #item_no:NUMERIC# 
		]]>
	</delete>
	
	<!-- delete pa bonus formular date -->
	<delete id="deletePaBonusFormular" parameterClass="SimpleMap" >
		<![CDATA[
				   DELETE KPA_BONUS_FORMULAR PB
		]]>
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="item_no">
				PB.PA_ITEM_NO = #item_no:NUMERIC# 
			</isNotEmpty>
			
			<isNotEmpty prepend="AND" property="formular_no">
				PB.FORMULAR_NO = #formular_no:NUMERIC# 
			</isNotEmpty>
		</dynamic>
	</delete>
	
	<!-- retrieve PaBonusFormularList -->
	<select id="RetrievePaBonusFormularList" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			     SELECT PB.FORMULAR_NO,
				        PB.PA_ITEM_NO,
				        PB.CONDITION,
				        PB.FORMULAR,
				        PB.CONDITION_SEQ,
				        PB.CONDITION_CN,
				        PB.FORMULAR_CN
				   FROM KPA_BONUS_FORMULAR PB
		]]>
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="pa_item_no">
				PB.PA_ITEM_NO = #pa_item_no:NUMERIC# 
			</isNotEmpty>
			
			<isNotEmpty prepend="AND" property="formular_no">
				PB.FORMULAR_NO = #formular_no:NUMERIC# 
			</isNotEmpty>
		</dynamic>

		<![CDATA[	     
			   ORDER BY PB.CONDITION_SEQ DESC
		]]>	
		
	</select>
	
	<!-- insert Pa Bonus formular -->
	<insert id="insertPaBonusFormular" parameterClass="SimpleMap" >
		<![CDATA[
			INSERT INTO 
				KPA_BONUS_FORMULAR (
					FORMULAR_NO,
					PA_ITEM_NO,
					CONDITION,
					FORMULAR,
					CONDITION_SEQ,
					CONDITION_CN,
					FORMULAR_CN
				)
				VALUES(
					KPA_BONUS_FORMULAR_SEQ.NEXTVAL,
					#pa_item_no:NUMERIC#,
					#condition:VARCHAR#,
					#formular:VARCHAR#,
					NVL((SELECT MAX(CONDITION_SEQ) FROM KPA_BONUS_FORMULAR WHERE PA_ITEM_NO = #pa_item_no:NUMERIC#),0) + 1,
					#condition_cn:VARCHAR#,
					#formular_cn:VARCHAR#
				)
			
		]]>
	</insert>
	
	<!-- update Pa Bonus formular -->
	<insert id="updatePaBonusFormular" parameterClass="SimpleMap" >
		<![CDATA[
			UPDATE 
				KPA_BONUS_FORMULAR SET
					CONDITION = #condition:VARCHAR#,
					FORMULAR = #formular:VARCHAR#,
					CONDITION_CN = #condition_cn:VARCHAR#,
					FORMULAR_CN = #formular_cn:VARCHAR#
				WHERE FORMULAR_NO = #formular_no:NUMERIC#
		]]>
	</insert>
	
	<!--retrieve Pa Bonus item calcu_order -->
	<select id="RetrievePaBonusItemCaluOrder" parameterClass="SimpleMap" resultClass="int">
		<![CDATA[
			     SELECT CALCU_ORDER
     	  		FROM KPA_BONUS_ITEM
    		   WHERE ITEM_NO = #item_no:NUMERIC#
		]]>
		
	</select>
	
	<!-- update Pa Bonus item calcu_order do up one -->
	<update id="UpdatePaBonusItemCaluOrderUpOne" parameterClass="SimpleMap" >
		<![CDATA[
			     UPDATE KPA_BONUS_ITEM SET CALCU_ORDER = (SELECT CALCU_ORDER FROM KPA_BONUS_ITEM WHERE ITEM_NO = #item_no:NUMERIC#)
       					WHERE CALCU_ORDER = (SELECT CALCU_ORDER - 1 FROM KPA_BONUS_ITEM WHERE ITEM_NO = #item_no:NUMERIC#)   
		]]>
	</update>
	
	<!-- update Pa Bonus item calcu_order do up  two -->
	<update id="UpdatePaBonusItemCaluOrderUpTwo" parameterClass="SimpleMap" >
		<![CDATA[
			     UPDATE KPA_BONUS_ITEM SET CALCU_ORDER = CASE WHEN CALCU_ORDER > 1 THEN CALCU_ORDER -1 ELSE CALCU_ORDER END
       				WHERE ITEM_NO = #item_no:NUMERIC# 
		]]>
	</update>
	
	<!-- update Pa Bonus item calcu_order do down one-->
	<update id="UpdatePaBonusItemCaluOrderDownOne" parameterClass="SimpleMap" >
		<![CDATA[
			     UPDATE KPA_BONUS_ITEM SET CALCU_ORDER = #CALCU_ORDER:NUMERIC# WHERE CALCU_ORDER = #CALCU_ORDER:NUMERIC# + 1 
		]]>
	</update>
	
	<!-- update Pa Bonus item calcu_order do down two-->
	<update id="UpdatePaBonusItemCaluOrderDownTwo" parameterClass="SimpleMap" >
		<![CDATA[
			UPDATE KPA_BONUS_ITEM SET CALCU_ORDER = 
       				CASE WHEN (SELECT COUNT(ITEM_NO) FROM KPA_BONUS_ITEM WHERE CALCU_ORDER = #CALCU_ORDER:numeric# ) = 2 THEN CALCU_ORDER + 1 ELSE CALCU_ORDER END 
       				WHERE ITEM_NO = #item_no:NUMERIC# 
		]]>
	</update>
	
	<!-- call PA_BONUS_CONFIRM -->
	<procedure id="callPaBonusConfirm" parameterClass="SimpleMap" >
		<![CDATA[
			{call KPA_BONUS_CONFIRM(#message,jdbcType=VARCHAR,mode=OUT#)}
		]]>
		
	</procedure>
	
	 <!-- retrieve export pa bonus Param Data  -->
	 <select id="retrieveExportPaBonusParamDataList" parameterClass="SimpleMap" resultClass="SimpleMap" >
		<![CDATA[	
			     SELECT HR.GROUP_EMP_ID,
			            HR.EMPID,
			     		HR.CHINESENAME,
			     		HD.DEPTNAME,
                		PARAM_DATA_NO,
                		PARAM_NO,
                		FIELD1_VALUE ,
                		FIELD2_VALUE ,
                		RETURN_VALUE ,
                		START_MONTH ,
                		END_MONTH ,
                		SD_ED_VALUE
                   FROM KPA_BONUS_PARAM_DATA,
                   		HR_EMPLOYEE HR,
                   		HR_DEPARTMENT HD
                  WHERE PARAM_NO = #param_no:NUMERIC# 
                  	AND FIELD1_VALUE = HR.EMPID(+)
                  	AND HR.DEPTID = HD.DEPTID
		]]>
		<isNotEmpty prepend="AND" property="deptid">
			<![CDATA[				
				 EXISTS( SELECT HD.DEPTID FROM HR_DEPARTMENT HD WHERE HR.DEPTID = HD.DEPTID  START WITH DEPTID = #deptid:VARCHAR2# CONNECT BY PRIOR DEPTID = PARENT_DEPT_ID ) 
		  ]]>	 
	   </isNotEmpty>
	   <isNotEmpty prepend="AND" property="key">
			<![CDATA[				
				 (HR.CHINESENAME LIKE '%' || #key:VARCHAR2# || '%' OR UPPER(HR.EMPID) LIKE '%' || UPPER(#key:VARCHAR2#) || '%' OR UPPER(HR.CHINESE_PINYIN) LIKE '%' || UPPER(#key:VARCHAR2#) || '%')
		  ]]>	 
	   </isNotEmpty>	        
	 </select>
	
</sqlMap>
