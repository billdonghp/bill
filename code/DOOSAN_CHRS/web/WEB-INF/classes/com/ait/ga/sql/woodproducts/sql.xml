<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="ga.woodproducts">
<select id="getapplyemail" parameterClass="SimpleMap" resultClass="string">
  <![CDATA[	
select email from hr_employee where empid=#applerId:VARCHAR#
    ]]>
</select>

<select id="getapplyemail2" parameterClass="SimpleMap" resultClass="string">
  <![CDATA[	
		select email from hr_employee where person_id=#applerId:VARCHAR#
    ]]>
</select>

<select id="getupaffrimemail" parameterClass="SimpleMap" resultClass="string">
  <![CDATA[	
          select  hr.email
		 from ga_products_affirm t, hr_employee hr
		 where t.apply_no =#applyNo:NUMERIC#
		 and t.affirmor_id = hr.person_id(+)
		 and t.affirm_level = (select t.affirm_level
		                       from ga_products_affirm t
		                       where t.ga_affirm_no = #affirmNo:NUMERIC#)+1
    ]]>
</select>
<select id="getUpAffrimNumber" parameterClass="SimpleMap" resultClass="int">
  <![CDATA[	
select count(*) 
from ga_products_affirm t
where  t.apply_no=#applyno:VARCHAR#
and t.affirm_level = #affrimlevel:VARCHAR# + 1 
order by t.affirm_level
    ]]>
</select>
<select id="woodProductsAffirmList" parameterClass="SimpleMap" resultClass="SimpleMap">
  <![CDATA[		  
		select t.apply_no,
       t.wp_applyerid,
       apply.empid,
       apply.chinesename,
       apply.deptid,
       de.deptname,
       TO_CHAR(t.hope_completed_date,'YYYY-MM-DD') hope_completed_date,
       TO_CHAR(T.APPLY_DATE,'YYYY-MM-DD') APPLY_DATE,
       t.note,
       t.confirm_flag,
       t.active,
       t.confirmoridea,
       type.code_name applytype, 
       apply.email,
       t.active,
       AFFIRM.GA_AFFIRM_NO,
       AFFIRM.AFFIRM_FLAG,
       NVL(AFFIRM.affirmoridea, '') AFFIRMOR_IDEA,
       AFFIRM.AFFIRM_LEVEL,
       AFFIRM.AFFIRMOR_ID,
       NVL(AFFIRM.UP_AFFIRM_FLAG, 1) UP_AFFIRM_FLAG,
       AFFIRM.MAX_AFFIRM_FLAG

  from ga_products_apply t,
       sy_code type,     
       hr_employee apply,
       hr_department de,
       (SELECT ga_products_affirm.*,
               UP_AFFIRM.AFFIRMOR_ID UP_AFFIRMOR_ID,
               UP_AFFIRM.AFFIRM_FLAG UP_AFFIRM_FLAG,
               CASE
                 WHEN ga_products_affirm.AFFIRM_LEVEL =
                      MAX_AFFIRM.MAX_LEVEL THEN
                  1
                 ELSE
                  0
               END AS MAX_AFFIRM_FLAG
          FROM (SELECT ga_products_affirm.*,
                       ga_products_affirm.AFFIRM_LEVEL - 1 UP_LEVEL
                  FROM ga_products_affirm) ga_products_affirm,
               (SELECT ga_products_affirm.APPLY_NO,
                       ga_products_affirm.AFFIRM_LEVEL,
                       ga_products_affirm.AFFIRMOR_ID,
                       ga_products_affirm.AFFIRM_FLAG
                  FROM ga_products_affirm) UP_AFFIRM,
               (SELECT ga_products_affirm.APPLY_NO,
                       MAX(ga_products_affirm.AFFIRM_LEVEL) MAX_LEVEL
                  FROM ga_products_affirm
                 GROUP BY ga_products_affirm.APPLY_NO) MAX_AFFIRM
        
         WHERE ga_products_affirm.APPLY_NO = UP_AFFIRM.APPLY_NO(+)
           AND ga_products_affirm.UP_LEVEL =
               UP_AFFIRM.AFFIRM_LEVEL(+)
           AND ga_products_affirm.APPLY_NO = MAX_AFFIRM.APPLY_NO(+)
           and ga_products_affirm.AFFIRMOR_ID =#adminId:VARCHAR#) AFFIRM
 where t.apply_type = type.code_id(+)  
   and t.wp_applyerid = apply.person_id(+)
   and apply.deptid = de.deptid(+)  
   and NVL(AFFIRM.UP_AFFIRM_FLAG, 1) = 1
   AND T.APPLY_NO = AFFIRM.APPLY_NO
   and t.cpny_id=#cpnyId:VARCHAR#
   AND T.APPLY_TYPE=AFFIRM.APPLY_TYPE
]]>
 <isNotEqual prepend="" property="qryType" compareValue="3">
   <isEqual prepend="AND" property="qryType" compareValue="0"> <!-- 未决裁过的 -->
		<![CDATA[
				 AFFIRM.AFFIRM_FLAG=0
	]]>
	</isEqual>
	<isEqual prepend="AND" property="qryType" compareValue="1"> <!-- 决裁通过的 -->
		<![CDATA[
				 AFFIRM.AFFIRM_FLAG =1
	]]>
	</isEqual>
	<isEqual prepend="AND" property="qryType" compareValue="2"> <!-- 决裁否决的 -->
		<![CDATA[
				 AFFIRM.AFFIRM_FLAG =2
	]]>
	</isEqual>
 </isNotEqual>
	<isNotEmpty prepend="AND" property="key">
		<![CDATA[		   
		 (apply.Chinesename LIKE  '%'||#key:VARCHAR# || '%' or apply.empid  LIKE  '%'||#key:VARCHAR# || '%' )
		]]>	
	</isNotEmpty>	
	<isNotEmpty prepend="AND" property="deptid">
		<![CDATA[		   
		 apply.deptid=#deptid:VARCHAR#
		]]>	
	</isNotEmpty>	
	<isNotEmpty prepend="AND" property="startDate">
		<![CDATA[		   
		 t.apply_date >=to_date(#startDate:VARCHAR#,'yyyy-mm-dd') 
		]]>	
	</isNotEmpty>
	<isNotEmpty prepend="AND" property="endDate">
		<![CDATA[		   
		t.apply_date <=to_date(#endDate:VARCHAR#,'yyyy-mm-dd') 
		]]>	
	</isNotEmpty>
	<![CDATA[	
     order by t.apply_date desc
    ]]>
</select>
<select id="woodProductsAffirmListNumber" parameterClass="SimpleMap" resultClass="int">
  <![CDATA[		  
		select count(*)
     from ga_products_apply t,      
         hr_employee apply,
       (SELECT ga_products_affirm.*,
               UP_AFFIRM.AFFIRMOR_ID UP_AFFIRMOR_ID,
               UP_AFFIRM.AFFIRM_FLAG UP_AFFIRM_FLAG,
               CASE
                 WHEN ga_products_affirm.AFFIRM_LEVEL =
                      MAX_AFFIRM.MAX_LEVEL THEN
                  1
                 ELSE
                  0
               END AS MAX_AFFIRM_FLAG
          FROM (SELECT ga_products_affirm.*,
                       ga_products_affirm.AFFIRM_LEVEL - 1 UP_LEVEL
                  FROM ga_products_affirm) ga_products_affirm,
               (SELECT ga_products_affirm.APPLY_NO,
                       ga_products_affirm.AFFIRM_LEVEL,
                       ga_products_affirm.AFFIRMOR_ID,
                       ga_products_affirm.AFFIRM_FLAG
                  FROM ga_products_affirm) UP_AFFIRM,
               (SELECT ga_products_affirm.APPLY_NO,
                       MAX(ga_products_affirm.AFFIRM_LEVEL) MAX_LEVEL
                  FROM ga_products_affirm
                 GROUP BY ga_products_affirm.APPLY_NO) MAX_AFFIRM
        
         WHERE ga_products_affirm.APPLY_NO = UP_AFFIRM.APPLY_NO(+)
           AND ga_products_affirm.UP_LEVEL =
               UP_AFFIRM.AFFIRM_LEVEL(+)
           AND ga_products_affirm.APPLY_NO = MAX_AFFIRM.APPLY_NO(+)
           and ga_products_affirm.AFFIRMOR_ID =#adminId:VARCHAR#) AFFIRM
 where  NVL(AFFIRM.UP_AFFIRM_FLAG, 1) = 1
   AND T.APPLY_NO = AFFIRM.APPLY_NO
   and t.cpny_id=#cpnyId:VARCHAR#
   AND t.wp_applyerid = apply.person_id(+)
   AND T.APPLY_TYPE=AFFIRM.APPLY_TYPE
  

]]>
 <isNotEqual prepend="" property="qryType" compareValue="3">
   <isEqual prepend="AND" property="qryType" compareValue="0"> <!-- 未决裁过的 -->
		<![CDATA[
				 AFFIRM.AFFIRM_FLAG=0
	]]>
	</isEqual>
	<isEqual prepend="AND" property="qryType" compareValue="1"> <!-- 决裁通过的 -->
		<![CDATA[
				 AFFIRM.AFFIRM_FLAG =1
	]]>
	</isEqual>
	<isEqual prepend="AND" property="qryType" compareValue="2"> <!-- 决裁否决的 -->
		<![CDATA[
				 AFFIRM.AFFIRM_FLAG =2
	]]>
	</isEqual>
 </isNotEqual>
	<isNotEmpty prepend="AND" property="key">
		<![CDATA[		   
		 (apply.Chinesename LIKE  '%'||#key:VARCHAR# || '%' or apply.empid  LIKE  '%'||#key:VARCHAR# || '%' )
		]]>	
	</isNotEmpty>	
	<isNotEmpty prepend="AND" property="deptid">
		<![CDATA[		   
		 apply.deptid=#deptid:VARCHAR#
		]]>	
	</isNotEmpty>	
	<isNotEmpty prepend="AND" property="startDate">
		<![CDATA[		   
		 t.apply_date >=to_date(#startDate:VARCHAR#,'yyyy-mm-dd') 
		]]>	
	</isNotEmpty>
	<isNotEmpty prepend="AND" property="endDate">
		<![CDATA[		   
		t.apply_date <=to_date(#endDate:VARCHAR#,'yyyy-mm-dd') 
		]]>	
	</isNotEmpty>
	<![CDATA[	
     order by t.apply_date desc
    ]]>
</select>
<select id="woodProductsAffirmInfoList" parameterClass="SimpleMap" resultClass="SimpleMap" remapResults="true">
  <![CDATA[	
		select t.apply_no,
	       t.wp_applyerid,
	       apply.empid,
	       apply.chinesename,
	       apply.deptid,
	       get_dept_name(de.PARENT_DEPT_ID) deptname,
	       TO_CHAR(t.hope_completed_date,'YYYY-MM-DD') hope_completed_date,
	       t.note,
	       t.confirm_flag,
	       t.active,
	       t.confirmoridea,
	       type.code_name applytype, 
	       TO_CHAR(T.APPLY_DATE,'YYYY-MM-DD') APPLY_DATE,
	       apply.email,
	       t.active,
	       t.confirmoridea,
	       confirm.chinesename confirmor,
	       t.confirm_flag,
	       AFFIRM.AFFIRM_FLAG firstAffirmFlag	
	  from ga_products_apply t,
	       sy_code type,
	       hr_employee apply,
	       hr_employee confirm,
	       hr_dept_tree_v de,
	       (SELECT apply_no, affirm_flag, affirm_level
	          FROM ga_products_affirm
	         WHERE affirm_level = 1) AFFIRM
	 where t.wp_applyerid=apply.person_id(+)
	   and t.confirm_confirmorid=confirm.person_id(+)
	   and t.apply_type=type.code_id(+)
	   and apply.deptid=de.deptid(+)   
	   AND T.APPLY_NO = AFFIRM.APPLY_NO
	   and t.cpny_id=#cpnyId:VARCHAR#
	]]>	
	<isNotEmpty prepend="AND" property="applerId">
		<![CDATA[		   
		 t.wp_applyerid=#applerId:VARCHAR#   
		]]>	
	</isNotEmpty>
	<isNotEmpty prepend="AND" property="ADMIN_ID">
		<![CDATA[
			EXISTS ( SELECT SAD.ADMIN_DEPTID
				   FROM SY_ADMIN_DEPTID SAD, SY_ADMIN SA
				  WHERE SAD.ADMIN_NO = SA.ADMINNO
				    AND SA.ADMINID = #ADMIN_ID:VARCHAR2#
				    AND SAD.ADMIN_DEPTID = apply.deptid
			   ) 
		]]>
	</isNotEmpty>
	<isNotEmpty prepend="AND" property="active">
		<![CDATA[		   
		 t.active=#active:VARCHAR#   
		]]>	
	</isNotEmpty>
	<isNotEmpty prepend="AND" property="applyNoExcel">
		<![CDATA[		   
		 t.apply_no=#applyNoExcel:VARCHAR#   
		]]>	
	</isNotEmpty>
	<isNotEmpty prepend="AND" property="codeType">
		t.apply_type in ($codeType$)
	</isNotEmpty>
	 <isNotEmpty prepend="AND" property="confirmorId">
		<![CDATA[		   
		EXISTS (SELECT SAD.ADMIN_DEPTID
				          FROM SY_ADMIN_DEPTID SAD, SY_ADMIN SA
				         WHERE SAD.ADMIN_NO = SA.ADMINNO
				           AND SA.ADMINID = #confirmorId:VARCHAR#
				           AND SAD.ADMIN_DEPTID = apply.deptid)	 
		]]>	
	</isNotEmpty>		
  <isNotEqual prepend="" property="qryType" compareValue="3">
	   <isEqual prepend="AND" property="qryType" compareValue="0"> <!-- 未通过的 -->
			<![CDATA[
					 t.active<2 	and t.confirm_flag=0
		]]>
		</isEqual>
		<isEqual prepend="AND" property="qryType" compareValue="1"> <!-- 决裁通过的 -->
			<![CDATA[
					 t.active=1 	and (t.confirm_flag=1 or t.confirm_flag=3)
		]]>
		</isEqual>
		<isEqual prepend="AND" property="qryType" compareValue="2"> <!-- 决裁否决的 -->
			<![CDATA[
					  (t.active=2 	or  t.confirm_flag=2)
		]]>
		</isEqual>
 </isNotEqual>
 <isNotEqual prepend="" property="status" compareValue="4">
        <isEqual prepend="AND" property="status" compareValue="0"> <!-- 未确认 -->
			<![CDATA[
					 t.confirm_flag=0
		]]>
		</isEqual>
	   <isEqual prepend="AND" property="status" compareValue="1"> <!-- 进行中 -->
			<![CDATA[
					 t.confirm_flag=1
		]]>
		</isEqual>
		<isEqual prepend="AND" property="status" compareValue="2"> <!-- 已否决 -->
			<![CDATA[
					 t.confirm_flag=2
		]]>
		</isEqual>
		<isEqual prepend="AND" property="status" compareValue="3"> <!-- 已完成 -->
			<![CDATA[
					  t.confirm_flag=3
		]]>
		</isEqual>
 </isNotEqual>
	<isNotEmpty prepend="AND" property="key">
		<![CDATA[		   
		 (apply.Chinesename LIKE  '%'||#key:VARCHAR# || '%' or apply.empid  LIKE  '%'||#key:VARCHAR# || '%' )
		]]>	
	</isNotEmpty>	
	<isNotEmpty prepend="AND" property="deptid">
		<![CDATA[		   
		 apply.deptid=#deptid:VARCHAR#
		]]>	
	</isNotEmpty>	
	<isNotEmpty prepend="AND" property="startDate">
		<![CDATA[		   
		 t.apply_date between to_date(#startDate:VARCHAR#,'yyyy-mm-dd')  and to_date(#endDate:VARCHAR#,'yyyy-mm-dd') + 1 
		]]>	
	</isNotEmpty>	
	<![CDATA[	
     order by t.apply_date desc
    ]]>
</select>
<select id="woodProductsAffirmInfoListNumber" parameterClass="SimpleMap" resultClass="int" remapResults="true">
  <![CDATA[		  
	select count(*) 
	     from ga_products_apply t ,hr_employee apply,hr_employee e
		where t.wp_applyerid=apply.person_id(+)	
		and t.cpny_id=#cpnyId:VARCHAR#
		and e.person_id(+) = t.wp_applyerid
                          ]]>
    <isNotEmpty prepend="AND" property="applerId">
		<![CDATA[		   
		 t.wp_applyerid=#applerId:VARCHAR#   
		]]>	
	</isNotEmpty>
	<isNotEmpty prepend="AND" property="ADMIN_ID">
		<![CDATA[
			EXISTS ( SELECT SAD.ADMIN_DEPTID
				   FROM SY_ADMIN_DEPTID SAD, SY_ADMIN SA
				  WHERE SAD.ADMIN_NO = SA.ADMINNO
				    AND SA.ADMINID = #ADMIN_ID:VARCHAR2#
				    AND SAD.ADMIN_DEPTID = e.deptid
			   ) 
		]]>
	</isNotEmpty>
	<isNotEmpty prepend="AND" property="active">
		<![CDATA[		   
		 t.active=#active:VARCHAR#   
		]]>	
	</isNotEmpty>
	<isNotEmpty prepend="AND" property="applyNoExcel">
		<![CDATA[		   
		 t.apply_no=#applyNoExcel:VARCHAR#   
		]]>	
	</isNotEmpty>
	<isNotEmpty prepend="AND" property="codeType">
		t.apply_type in ($codeType$)
	</isNotEmpty>
	 <isNotEmpty prepend="AND" property="confirmorId">
		<![CDATA[		   
		EXISTS (SELECT SAD.ADMIN_DEPTID
				          FROM SY_ADMIN_DEPTID SAD, SY_ADMIN SA
				         WHERE SAD.ADMIN_NO = SA.ADMINNO
				           AND SA.ADMINID = #confirmorId:VARCHAR#
				           AND SAD.ADMIN_DEPTID = apply.deptid)	 
		]]>	
	</isNotEmpty>		
   <isNotEqual prepend="" property="qryType" compareValue="3">
	   <isEqual prepend="AND" property="qryType" compareValue="0"> <!-- 未通过的 -->
			<![CDATA[
					 t.active<2 	and t.confirm_flag=0
		]]>
		</isEqual>
		<isEqual prepend="AND" property="qryType" compareValue="1"> <!-- 决裁通过的 -->
			<![CDATA[
					 t.active=1 	and (t.confirm_flag=1 or t.confirm_flag=3)
		]]>
		</isEqual>
		<isEqual prepend="AND" property="qryType" compareValue="2"> <!-- 决裁否决的 -->
			<![CDATA[
					  (t.active=2 	or  t.confirm_flag=2)
		]]>
		</isEqual>
 </isNotEqual>
 <isNotEqual prepend="" property="status" compareValue="4">
        <isEqual prepend="AND" property="status" compareValue="0"> <!-- 未确认 -->
			<![CDATA[
					 t.confirm_flag=0
		]]>
		</isEqual>
	   <isEqual prepend="AND" property="status" compareValue="1"> <!-- 进行中 -->
			<![CDATA[
					 t.confirm_flag=1
		]]>
		</isEqual>
		<isEqual prepend="AND" property="status" compareValue="2"> <!-- 已否决 -->
			<![CDATA[
					 t.confirm_flag=2
		]]>
		</isEqual>
		<isEqual prepend="AND" property="status" compareValue="3"> <!-- 已完成 -->
			<![CDATA[
					  t.confirm_flag=3
		]]>
		</isEqual>
 </isNotEqual>
	<isNotEmpty prepend="AND" property="key">
		<![CDATA[		   
		 (apply.Chinesename LIKE  '%'||#key:VARCHAR# || '%' or apply.empid  LIKE  '%'||#key:VARCHAR# || '%' )
		]]>	
	</isNotEmpty>	
	<isNotEmpty prepend="AND" property="deptid">
		<![CDATA[		   
		 apply.deptid=#deptid:VARCHAR#
		]]>	
	</isNotEmpty>	
    <isNotEmpty prepend="AND" property="startDate">
		<![CDATA[		   
		 t.apply_date between to_date(#startDate:VARCHAR#,'yyyy-mm-dd')  and to_date(#endDate:VARCHAR#,'yyyy-mm-dd')  + 1 
		]]>	
	</isNotEmpty>
</select>
<select id="woodProductsAffirmorList" parameterClass="SimpleMap" resultClass="SimpleMap">
  <![CDATA[	
		  select t.ga_affirm_no,
		       t.affirm_flag,
		       t.affirm_level,
		       t.affirmor_id,
		       hr.chinesename affirmor_name,
		       t.apply_no,
		       hr.email,
		       t.affirmoridea
		  from ga_products_affirm t, hr_employee hr
		 where t.affirmor_id = hr.person_id
		   and t.apply_no = #applyNo:VARCHAR#
		 order by t.affirm_level
    ]]>
</select>
<select id="woodProductsList" parameterClass="SimpleMap" resultClass="SimpleMap">
  <![CDATA[	
			select t.wpname,
		       t.wpnumber,
		       t.wp_l,
		       t.wp_w,
		       t.wp_h,
		       t.wp_sumarea,
		       t.wp_sumprice,
		       decode(t.seal_type,'newSeal','新章','旧章') seal_type,
		       t.wp_type,
		       wset.measurement_unit_price,
		       t.filename,
               t.filepath
		from ga_products_detail t,ga_sealproducts_set wset
		where t.apply_no=#applyNo:VARCHAR#
		and t.wpid=TO_CHAR(wset.woodproducts_id(+))
		
    ]]>
</select>
<update id="oingAffirm" parameterClass="SimpleMap">
	
	  update ga_products_affirm t
			set t.affirm_flag=#affirmFlag:NUMERIC#,
			t.update_date=SYSDATE,
			t.updated_by=#adminId:VARCHAR#,
			t.affirmoridea=#affirmorIdea:VARCHAR#
			where t.ga_affirm_no=#affirmNo:NUMERIC#	
</update>
	
<update id="updateApplyInfo" parameterClass="SimpleMap">
	
	 update ga_products_apply t
        set t.active=#affirmFlag:NUMERIC#
	 where t.apply_no=#applyNo:NUMERIC#	
</update>
</sqlMap>