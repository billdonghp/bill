<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="ga.food">
	<select id="selectFoodProduct" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			SELECT A.SEQ_NO SEQ_NO,
			       A.FOOD_ID FOOD_NAME,
			       A.BRAND BRAND,
			       A.UNIT_PRICE PRICE,
			       A.UNIT UNIT_CODE,
			       GET_CODE_NAME(A.UNIT) UNIT,
			       A.SPECIFIC SPECIFIC,
			       A.PURCHASE_CPNY PURCHASE_CPNY,
			       A.REMARK REMARK,
			       TO_CHAR(A.CREATE_DATE,'YYYY-MM-DD') CREATE_DATE,
			       GET_EMP_NAME(A.CREATED_BY) CREATED_BY
			FROM GA_FOOD_PRODUCT A
			WHERE A.CPNY_ID = #cpnyId#
			  AND A.ACTIVITY = 1
	  	]]>
	  	<isNotEmpty prepend="AND" property="seqNo">
			<![CDATA[		   
				A.SEQ_NO = #seqNo#
			]]>	
		</isNotEmpty>		
	</select>
	
	<select id="selectFoodProductCut" parameterClass="SimpleMap" resultClass="int">
		<![CDATA[
			SELECT COUNT(*) CUT
			FROM GA_FOOD_PRODUCT A
			WHERE A.CPNY_ID = #cpnyId#
			 AND A.ACTIVITY = 1
	  	]]>
		<isNotEmpty prepend="AND" property="seqNo">
			<![CDATA[		   
				A.SEQ_NO = #seqNo#
			]]>	
		</isNotEmpty>
	</select>
	
	<insert id="insertFoodProduct" parameterClass="SimpleMap">
		<![CDATA[
			INSERT INTO GA_FOOD_PRODUCT A
			       (A.SEQ_NO,
			        A.FOOD_ID,
			        A.BRAND,
			        A.UNIT_PRICE,
			        A.UNIT,
			        A.SPECIFIC,
			        A.PURCHASE_CPNY,
			        A.REMARK,
			        A.CREATE_DATE,
			        A.CREATED_BY,
			        A.ACTIVITY,
			        A.CPNY_ID)
			VALUES( GA_FOOD_PRODUCT_SEQ.NEXTVAL,
			        #foodName:VARCHAR#,
			        #brand:VARCHAR#,
			        #price:NUMERIC#,
			        #unit:VARCAHR#,
			        #specific:VARCHAR#,
			        #purchaseCpny:VARCHAR#,
			        #remark:VARCHAR#,
			        SYSDATE,
			        #adminId:VARCHAR#,
			        1,
			        #cpnyId:VARCHAR#)
		]]>
	</insert>
	
	<update id="updateFoodProduct" parameterClass="SimpleMap">
		<![CDATA[
			UPDATE GA_FOOD_PRODUCT A
			   SET  A.REMARK        = #remark:VARCHAR#, 
			        A.UPDATE_DATE   = SYSDATE, 
			        A.UPDATED_BY    = #adminId:VARCHAR#
			 WHERE A.SEQ_NO = #seqNo#	
		]]>
	</update>
	
	<delete id="deleteFoodProduct" parameterClass="SimpleMap">
		<![CDATA[
			UPDATE GA_FOOD_PRODUCT A 
			SET	   A.ACTIVITY=0
			WHERE A.SEQ_NO = #seqNo#
		]]>
	</delete>
	
	
	<select id="selectFoodScheme" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			SELECT DISTINCT
				   A.FOOD_SCHEME_ID SEQ_NO,
			       A.FOOD_SCHEME_ID SCHEME_NAME,
			       TO_CHAR(A.CREATE_DATE,'YYYY-MM-DD') CREATE_DATE,
			       GET_EMP_NAME(A.CREATED_BY) CREATED_BY,
			       A.REMARK REMARK
			  FROM GA_FOOD_SCHEME_DETAIL A
			 WHERE A.ACTIVITY = 1
			 AND   A.CPNY_ID = #cpnyId:VARCHAR#
	  	]]>
	  	<isNotEmpty prepend="AND" property="schemeName">
			<![CDATA[		   
				A.FOOD_SCHEME_ID = #schemeName#
			]]>	
		</isNotEmpty>		
	</select>
	
	<select id="selectFoodSchemeCut" parameterClass="SimpleMap" resultClass="int">
		<![CDATA[
			SELECT COUNT(*) CUT
			  FROM (SELECT DISTINCT A.FOOD_SCHEME_ID FOOD_SCHEME_ID
			          FROM GA_FOOD_SCHEME_DETAIL A
			         WHERE A.ACTIVITY = 1
			           AND A.CPNY_ID = #cpnyId:VARCHAR#) B
	  	]]>
	  	<isNotEmpty prepend="AND" property="schemeName">
			<![CDATA[		   
				B.FOOD_SCHEME_ID = #schemeName#
			]]>	
		</isNotEmpty>		
	</select>
	
	<select id="selectFoodDetail" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			SELECT A.FOOD_SCHEME_ID SCHEME_NAME,
				   A.FOOD_SCHEME_ID FOOD_SCHEME_ID,
				   A.FOOD_NO FOOD_NO,
			       A.QUENTITY QUENTITY,
			       B.FOOD_ID FOOD_NAME,
			       B.BRAND BRAND,
			       GET_CODE_NAME(B.UNIT) UNIT,
			       B.UNIT_PRICE PRICE,
			       B.SPECIFIC SPECIFIC,
			       B.PURCHASE_CPNY PURCHASE_CPNY,
			       B.REMARK REMARK
			FROM GA_FOOD_SCHEME_DETAIL A,
			     GA_FOOD_PRODUCT B
			WHERE A.FOOD_NO = B.SEQ_NO
			AND   A.ACTIVITY = 1
			AND   B.CPNY_ID = #cpnyId:VARCHAR#
	  	]]>
	  	<isNotEmpty prepend="AND" property="schemeName">
			<![CDATA[		   
				A.FOOD_SCHEME_ID = #schemeName#
			]]>	
		</isNotEmpty>	
	</select>
	
	<select id="getFoodProductList" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			SELECT A.SEQ_NO ID,
			       A.FOOD_ID NAME
			FROM GA_FOOD_PRODUCT A
			WHERE A.ACTIVITY = 1
			AND   A.CPNY_ID = #cpnyId:VARCHAR#
	  	]]>
	</select>
	
	<select id="getFoodSchemeList" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			SELECT DISTINCT
				   A.FOOD_SCHEME_ID ID,
			       A.FOOD_SCHEME_ID NAME
			FROM GA_FOOD_SCHEME_DETAIL A
			WHERE A.ACTIVITY = 1
			AND   A.CPNY_ID = #cpnyId:VARCHAR#
	  	]]>
	</select>
	
	<insert id="insertFoodScheme" parameterClass="SimpleMap">
		<![CDATA[
			INSERT INTO GA_FOOD_SCHEME_DETAIL A
			       (A.SEQ_NO,
			        A.FOOD_SCHEME_ID,
			        A.FOOD_NO,
			        A.QUENTITY,
			        A.REMARK,
			        A.CREATE_DATE,
			        A.CREATED_BY,
			        A.ACTIVITY,
			        A.CPNY_ID)
			VALUES (GA_FOOD_SCHEME_DETAIL_SEQ.NEXTVAL,
			        #schemeName:VARCHAR#,
			        #foodNo:NUMERIC#,
			        #quentity:NUMERIC#,
			        #remark:VARCHAR#,
			        SYSDATE,
			        #adminId:VARCHAR#,
			        1,
			        #cpnyId:VARCHAR#)
		]]>
	</insert>
	
	<update id="updateFoodScheme" parameterClass="SimpleMap">
		<![CDATA[
			UPDATE GA_FOOD_SCHEME_DETAIL A
			SET    A.REMARK         = #remark:VARCHAR#,
			       A.UPDATE_DATE    = SYSDATE,
			       A.UPDATED_BY     = #adminId:VARCHAR#
			WHERE  A.FOOD_SCHEME_ID = #schemeName#
		]]>
	</update>
	
	<delete id="deleteFoodScheme" parameterClass="SimpleMap">
		<![CDATA[
			UPDATE  GA_FOOD_SCHEME_DETAIL A
			SET	   A.ACTIVITY=0
			WHERE A.FOOD_SCHEME_ID = #seqNo#
		]]>
	</delete>
	
	<insert id="insertDataForApplyFood" parameterClass="SimpleMap">
		<![CDATA[
			INSERT INTO GA_FOOD_APPLY A
			       (A.SEQ_NO,
			        A.DEPTID,
			        A.FOOD_SCHEME_ID,
			        A.QUENTITY,
			        A.REMARK,
			        A.CREATE_DATE,
			        A.CREATED_BY,
			        A.ACTIVITY,
			        A.CPNY_ID)
			VALUES (GA_FOOD_APPLY_SEQ.NEXTVAL,
			        #deptId:VARCHAR#,
			        #schemeName:VARCHAR#,
			        #quentity:NUMERIC#,
			        #remark:VARCHAR#,
			        TO_DATE(#applyDate:VARCHAR#,'YYYY-MM-DD'),
			        #adminId:VARCHAR#,
			        1,
			        #cpnyId:VARCHAR#)
		]]>
	</insert>
	
	<select id="selectFoodApply" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			SELECT GET_DEPT_NAME(A.DEPTID) DEPTNAME,
			       A.FOOD_SCHEME_ID FOOD_SCHEME_ID,
			       A.FOOD_SCHEME_ID FOOD_SCHEME_NAME,
			       A.QUENTITY QUENTITY,
			       A.REMARK REMARK,
			       TO_CHAR(A.CREATE_DATE,'YYYY-MM-DD') APPLY_DATE,
			       GET_EMP_NAME(A.CREATED_BY) APPLY_BY
			FROM GA_FOOD_APPLY A
			WHERE A.ACTIVITY = 1
	  	]]>
	  	<isNotEmpty prepend="AND" property="apply_date">
	  		TO_CHAR(A.CREATE_DATE,'YYYY-MM-DD') = #apply_date:VARCHAR#
	  	</isNotEmpty>
	  	<isNotEmpty prepend="AND" property="DeptId">
	  		<![CDATA[
	  			A.DEPTID = #DeptId:VARCHAR#
	  		]]>
	  	</isNotEmpty>
	  	<![CDATA[
	  		ORDER BY A.DEPTID
	  	]]>
	</select>
	
	<select id="selectFoodApplyCut" parameterClass="SimpleMap" resultClass="int">
		<![CDATA[
			SELECT COUNT(*) CUT
			FROM GA_FOOD_APPLY A
			WHERE A.ACTIVITY = 1
	  	]]>
	  	<isNotEmpty prepend="AND" property="apply_date">
	  		<![CDATA[
	  			TO_CHAR(A.CREATE_DATE,'YYYY-MM-DD') = #apply_date:VARCHAR#
	  		]]>
	  	</isNotEmpty>
	  	<isNotEmpty prepend="AND" property="DeptId">
	  		<![CDATA[
	  			A.DEPTID = #DeptId:VARCHAR#
	  		]]>
	  	</isNotEmpty>
	</select>
	
	<select id="selectFoodDeptReport" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			SELECT GET_DEPT_NAME(A.DEPTID) DEPTNAME,
			       A.FOOD_SCHEME_ID FOOD_SCHEME_ID,
			       A.FOOD_SCHEME_ID FOOD_SCHEME_NAME,
			       SUM(A.QUENTITY) QUENTITY
			  FROM GA_FOOD_APPLY A
			 WHERE A.ACTIVITY = 1
			 AND   A.CPNY_ID = #cpnyId:VARCHAR#
	  	]]>
	  	<isNotEmpty prepend="" property="foodStartDate">
	  		<isNotEmpty prepend="AND" property="foodEndDate">
	  			<![CDATA[
	  				A.CREATE_DATE BETWEEN TO_DATE(#foodStartDate:VARCHAR#,'YYYY-MM-DD') AND  TO_DATE(#foodEndDate:VARCHAR#,'YYYY-MM-DD')
	  			]]>
	  		</isNotEmpty>
	  	</isNotEmpty>
	  	<![CDATA[
			 GROUP BY A.FOOD_SCHEME_ID,A.DEPTID
	  	]]>
	</select>
	
	<select id="selectSchemeReport" parameterClass="SimpleMap" resultClass="SimpleMap" remapResults="true">
		<![CDATA[
			SELECT $sql1$
				   DECODE(GROUPING(A.CREATE_DATE),1,'合计',TO_CHAR(A.CREATE_DATE,'DY')) WEEK,
       			   DECODE(GROUPING(A.CREATE_DATE),1,'&nbsp;', TO_CHAR(A.CREATE_DATE,'YYYY-MM-DD')) APPLY_DATE
			FROM GA_FOOD_APPLY A
			WHERE   A.ACTIVITY = 1
			AND   A.CPNY_ID = #cpnyId:VARCHAR#
	  	]]>
	  	<isNotEmpty prepend="" property="foodYear">
	  		<isNotEmpty prepend="AND" property="foodMonth">
		  		<![CDATA[
		  			TO_CHAR(A.CREATE_DATE,'YYYY-MM') = #foodYear:VARCHAR#||'-'||#foodMonth:VARCHAR#
		  		]]>
	  		</isNotEmpty>
	  	</isNotEmpty>
	  	<![CDATA[
			  GROUP BY ROLLUP(A.CREATE_DATE)
	  	]]>
	</select>
	
	<select id="selectFoodReport" parameterClass="SimpleMap" resultClass="SimpleMap" remapResults="true">
		<![CDATA[
			SELECT $sql2$
			        SUM(B.QUENTITY*C.UNIT_PRICE) PRICE
			FROM GA_FOOD_APPLY A,
			     GA_FOOD_SCHEME_DETAIL B,
			     GA_FOOD_PRODUCT C
			WHERE A.FOOD_SCHEME_ID = B.FOOD_SCHEME_ID
			AND   B.FOOD_NO = C.SEQ_NO
			AND   A.ACTIVITY = 1
      		AND   B.CPNY_ID = #cpnyId:VARCHAR#
			
	  	]]>
	  	<isNotEmpty prepend="" property="foodYear">
	  		<isNotEmpty prepend="AND" property="foodMonth">
		  		<![CDATA[
		  			TO_CHAR(A.CREATE_DATE,'YYYY-MM') = #foodYear:VARCHAR#||'-'||#foodMonth:VARCHAR#
		  		]]>
	  		</isNotEmpty>
	  	</isNotEmpty>
	  	<![CDATA[
			  GROUP BY ROLLUP(A.CREATE_DATE)
	  	]]>
	</select>
	
	<select id="getFoodApplyQuentity" parameterClass="SimpleMap" resultClass="int">
		<![CDATA[
			SELECT SUM(A.QUENTITY)
			FROM GA_FOOD_APPLY A
	  	]]>
	  	<isEqual property="flag" compareValue="1">
		  	<isNotEmpty prepend="" property="foodYear">
		  		<isNotEmpty prepend="WHERE" property="foodMonth">
			  		<![CDATA[
			  			TO_CHAR(A.CREATE_DATE,'YYYY-MM') = #foodYear:VARCHAR#||'-'||#foodMonth:VARCHAR#
			  		]]>
		  		</isNotEmpty>
		  	</isNotEmpty>
		</isEqual>
		<isEqual property="flag" compareValue="2">
		    <isNotEmpty prepend="" property="foodStartDate">
		  		<isNotEmpty prepend="WHERE" property="foodEndDate">
			  		<![CDATA[
			  			TO_CHAR(A.CREATE_DATE,'YYYY-MM-DD') BETWEEN #foodStartDate:VARCHAR# AND #foodEndDate:VARCHAR#
			  		]]>
		  		</isNotEmpty>
		  	</isNotEmpty>
		</isEqual>
	</select>
	
	<select id="getFoodApplyPrice" parameterClass="SimpleMap" resultClass="float">
		<![CDATA[
			SELECT SUM((C.UNIT_PRICE*B.QUENTITY)*A.QUENTITY) PRICE
			FROM GA_FOOD_APPLY A,
			     GA_FOOD_SCHEME_DETAIL B,
			     GA_FOOD_PRODUCT C
			WHERE A.FOOD_SCHEME_ID = B.FOOD_SCHEME_ID
			AND   B.FOOD_NO = C.SEQ_NO
			AND   A.ACTIVITY = 1
			AND   B.CPNY_ID = #cpnyId:VARCHAR#
			AND   C.CPNY_ID = #cpnyId:VARCHAR#
	  	]]>
	  	<isEqual property="flag" compareValue="1">
		  	<isNotEmpty prepend="" property="foodYear">
		  		<isNotEmpty prepend="AND" property="foodMonth">
			  		<![CDATA[
			  			TO_CHAR(A.CREATE_DATE,'YYYY-MM') = #foodYear:VARCHAR#||'-'||#foodMonth:VARCHAR#
			  		]]>
		  		</isNotEmpty>
		  	</isNotEmpty>
		</isEqual>
		<isEqual property="flag" compareValue="2">
		    <isNotEmpty prepend="" property="foodStartDate">
		  		<isNotEmpty prepend="AND" property="foodEndDate">
			  		<![CDATA[
			  			TO_CHAR(A.CREATE_DATE,'YYYY-MM-DD') BETWEEN #foodStartDate:VARCHAR# AND #foodEndDate:VARCHAR#
			  		]]>
		  		</isNotEmpty>
		  	</isNotEmpty>
		</isEqual>
	</select>
	
</sqlMap>