<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="ga.festivalpresent">
	<select id="selectFestivalPresent" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			SELECT A.SEQ_NO       SEQ_NO,
			       A.PRESENT_NAME PRESENT_NAME,
			       A.BRAND        BRAND,
			       A.UNIT_PRICE   UNIT_PRICE,
			       A.UNIT         UNIT_CODE,
			       GET_CODE_NAME(A.UNIT) UNIT,
			       A.SPECIFIC     SPECIFIC,
			       A.REMARK       REMARK,
			       TO_CHAR(A.CREATE_DATE,'YYYY-MM-DD') CREATE_DATE,
			       GET_EMP_NAME(A.CREATED_BY)   CREATED_BY
			  FROM GA_FESTIVAL_PRESENT A
			 WHERE A.ACTIVITY = 1
	  	]]>
	  	<isNotEmpty prepend="AND" property="seqNo">
				<![CDATA[		   
				 	 A.SEQ_NO = #seqNo#
				]]>	
		</isNotEmpty>
	  	<isNotEmpty prepend="AND" property="cpnyId">
				<![CDATA[		   
				 	 A.CPNY_ID = #cpnyId#
				]]>	
		</isNotEmpty>				
	</select>
	
	<select id="selectFestivalPresentCut" parameterClass="SimpleMap" resultClass="int">
		<![CDATA[
	 		SELECT COUNT(*) CUT
			  FROM GA_FESTIVAL_PRESENT A
			 WHERE A.ACTIVITY = 1
	  	]]>
	  	<isNotEmpty prepend="AND" property="cpnyId">
				<![CDATA[		   
				 	 A.CPNY_ID = #cpnyId#
				]]>	
		</isNotEmpty>				
	</select>
	
	<insert id="insertFestivalPresent" parameterClass="SimpleMap">
		<![CDATA[	
			INSERT INTO GA_FESTIVAL_PRESENT A
			     ( A.SEQ_NO,
			       A.PRESENT_NAME,
			       A.BRAND,
			       A.UNIT_PRICE,
			       A.UNIT,
			       A.SPECIFIC,
			       A.REMARK,
			       A.CREATE_DATE,
			       A.CREATED_BY,
			       A.ACTIVITY,
			       A.CPNY_ID)
			 VALUES
			 	 ( GA_FESTIVAL_PRESENT_SEQ.NEXTVAL,
			 	   #presentName:VARCHAR#,
			 	   #brand:VARCHAR#,
			 	   #unitPrice:NUMERIC#,
			 	   #unit:VARCHAR#,
			 	   #specific:VARCHAR#,
			 	   #remark:VARCHAR#,
			 	   SYSDATE,
			 	   #personId:VARCHAR#,
			 	   1,
			 	   #cpnyId:VARCHAR#)
		]]>
	</insert>
	
	<update id="updateFestivalPresent" parameterClass="SimpleMap">
		<![CDATA[
				UPDATE GA_FESTIVAL_PRESENT A
				SET    A.PRESENT_NAME = #presentName:VARCHAR#,
			           A.BRAND        = #brand:VARCHAR#,
			           A.UNIT_PRICE   = #unitPrice:NUMERIC#,
			           A.UNIT         = #unit:VARCHAR#,
			           A.SPECIFIC     = #specific:VARCHAR#,
			           A.REMARK       = #remark:VARCHAR#,
			           A.UPDATE_DATE  = SYSDATE,
			           A.UPDATED_BY   = #personId:VARCHAR#
				WHERE 	A.SEQ_NO = #seqNo:VARCHAR#
		]]>
	</update>
	
	<update id="deleteFestivalPresent" parameterClass="SimpleMap">
		<![CDATA[
			UPDATE GA_FESTIVAL_PRESENT A
			SET	   A.ACTIVITY=0
			WHERE A.SEQ_NO = #seqNo:VARCHAR#
		]]>
	</update>
	
	<select id="selectFestivalScheme" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			SELECT A.SEQ_NO SEQ_NO,
			       A.SCHEME_NAME SCHEME_NAME,
			       A.REMARK SCHEME_REMARK,
			       TO_CHAR(A.CREATE_DATE, 'YYYY-MM-DD') CREATE_DATE,
			       GET_EMP_NAME(A.CREATED_BY) CREATED_BY,
			       S.TOTALSUM TOTALSUM,
			       A.ACTIVITY ACTIVITY
			  FROM GA_FESTIVAL_SCHEME A,
			       (SELECT B.SEQ_NO SEQ_NO, SUM(C.UNIT_PRICE * A.QUENTITY) TOTALSUM
			          FROM GA_FESTIVAL_SCHEME_DETAIL A,
			               GA_FESTIVAL_SCHEME        B,
			               GA_FESTIVAL_PRESENT       C
			         WHERE A.SCHEME_NO = B.SEQ_NO
			           AND A.PRESENT_NO = C.SEQ_NO
			         GROUP BY B.SEQ_NO) S
			 WHERE A.SEQ_NO = S.SEQ_NO(+)
			  AND (A.ACTIVITY = 1 OR A.ACTIVITY = 2)
	  	]]>
	  	<isNotEmpty prepend="AND" property="seqNo">
				<![CDATA[		   
				 	 A.SEQ_NO = #seqNo:VARCHAR#
				]]>	
		</isNotEmpty>
	  	<isNotEmpty prepend="AND" property="cpnyId">
				<![CDATA[		   
				 	 A.CPNY_ID = #cpnyId:VARCHAR#
				]]>	
		</isNotEmpty>				
	</select>
	
	<select id="selectFestivalSchemeDetail" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			SELECT A.SEQ_NO SEQ_NO,
				   A.SCHEME_NO SCHEME_NO,
				   A.QUENTITY QUENTITY,
				   B.SEQ_NO PRESENT_NO,
			       B.PRESENT_NAME PRESENT_NAME,
			       B.BRAND BRAND,
			       B.UNIT_PRICE UNIT_PRICE,
			       GET_CODE_NAME(B.UNIT) UNIT,
			       B.SPECIFIC SPECIFIC,
			       (A.QUENTITY*B.UNIT_PRICE) TOTAL_PRICE
			FROM GA_FESTIVAL_SCHEME_DETAIL A,
			     GA_FESTIVAL_PRESENT B
			WHERE B.SEQ_NO = A.PRESENT_NO
	  	]]>				
	</select>

	<select id="selectFestivalSchemeCut" parameterClass="SimpleMap" resultClass="int">
		<![CDATA[
	 		SELECT COUNT(*) CUT
			FROM GA_FESTIVAL_SCHEME A
			WHERE (A.ACTIVITY = 1 OR A.ACTIVITY = 2)
	  	]]>
	  	<isNotEmpty prepend="AND" property="seqNo">
				<![CDATA[		   
				 	 A.SEQ_NO = #seqNo#
				]]>	
		</isNotEmpty>
	  	<isNotEmpty prepend="AND" property="cpnyId">
				<![CDATA[		   
				 	 A.CPNY_ID = #cpnyId#
				]]>	
		</isNotEmpty>					
	</select>
	
	<insert id="insertFestivalSchemeDetail" parameterClass="SimpleMap">
		<![CDATA[	
			INSERT INTO GA_FESTIVAL_SCHEME_DETAIL A
			     ( A.SEQ_NO,
			       A.SCHEME_NO,
			       A.PRESENT_NO,
			       A.QUENTITY,
			       A.CREATE_DATE,
			       A.CREATED_BY,
			       A.ACTIVITY)
			 VALUES
			 	 ( GA_FESTIVAL_SCHEME_DETAIL_SEQ.NEXTVAL,
			 	   GA_FESTIVAL_SCHEME_SEQ.CURRVAL,
			 	   #presentNo:VARCHAR#,
			 	   #quentity:NUMERIC#,
			 	   SYSDATE,
			 	   #personId:VARCHAR#,
			 	   1)
		]]>
	</insert>
	
	<insert id="insertFestivalScheme" parameterClass="SimpleMap">
		<![CDATA[	
			INSERT INTO GA_FESTIVAL_SCHEME A
			       ( A.SEQ_NO,
		             A.SCHEME_NAME,
		             A.REMARK,
		             A.CREATE_DATE,
		             A.CREATED_BY,
		             A.ACTIVITY,
		             A.CPNY_ID)
			 VALUES
			 	 ( GA_FESTIVAL_SCHEME_SEQ.NEXTVAL,
			 	   #schemeName:VARCHAR#,
			 	   #schemeRemark:VARCHAR#,
			 	   SYSDATE,
			 	   #personId:VARCHAR#,
			 	   1,
			 	   #cpnyId:VARCHAR#)
		]]>
	</insert>
	
	<update id="updateFestivalScheme" parameterClass="SimpleMap">
		<![CDATA[
				UPDATE GA_FESTIVAL_SCHEME A
				SET    A.REMARK = #schemeRemark:VARCHAR#
				WHERE  A.SEQ_NO = #seqNo#
		]]>
	</update>
	
	<update id="deleteFestivalScheme" parameterClass="SimpleMap">
		<![CDATA[
			UPDATE GA_FESTIVAL_SCHEME A
			SET	   A.ACTIVITY=0
			WHERE A.SEQ_NO = #seqNo#
		]]>
	</update>
	
	<update id="deleteFestivalSchemeDetial" parameterClass="SimpleMap">
		<![CDATA[
			UPDATE GA_FESTIVAL_SCHEME_DETAIL A
			SET    A.ACTIVITY = 0
			WHERE  A.SCHEME_NO = #seqNo#
		]]>
	</update>
	
	<select id="getFestivalPresentName" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			SELECT A.SEQ_NO ID,
			       A.PRESENT_NAME NAME
			FROM GA_FESTIVAL_PRESENT A
			WHERE A.CPNY_ID = #cpnyId#
		]]>
	</select>
	
	<select id="selectFestivalPresentApply" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			SELECT A.EMPID EMPID,
			       A.PERSON_ID PERSON_ID,
			       A.CHINESENAME CHINESENAME,
			       GET_CODE_NAME(A.STATUS_CODE) STATUS_CODE,
			       B.DEPTID DEPTID,
			       B.DEPTNAME DEPTNAME,
			       GET_DEPT_NAME(B.FOURTHDEPT) FOURTHDEPTNAME
			  FROM HR_EMPLOYEE A, HR_DEPARTMENT B
			 WHERE A.DEPTID = B.DEPTID
			   AND (A.DATE_LEFT > SYSDATE OR A.DATE_LEFT IS NULL)
			   AND A.ACTIVITY = 1
			   AND ((EXISTS (SELECT SAD.ADMIN_DEPTID
			          FROM SY_ADMIN_DEPTID SAD, SY_ADMIN SA
			         WHERE SAD.ADMIN_NO = SA.ADMINNO
			           AND SA.ADMINID = #adminId#
			           AND SAD.ADMIN_DEPTID = B.DEPTID)) OR A.PERSON_ID = #adminId#)
	  	]]>
	  	<isNotEmpty prepend="AND" property="empId">
				<![CDATA[
				 	A.EMPID = #empId:VARCHAR#
			    ]]>
		</isNotEmpty>
	  	<isNotEmpty prepend="AND" property="personId">
				<![CDATA[		   
				 	 A.PERSON_ID = #personId#
				]]>	
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="DeptId">
				<![CDATA[
					B.DEPTID = #DeptId#
				]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="empStatus">
				<![CDATA[
					A.STATUS_CODE = #empStatus#
				]]>
		</isNotEmpty>
	  	<isNotEmpty prepend="AND" property="cpnyId">
				<![CDATA[		   
				 	 A.CPNY_ID = #cpnyId#
				]]>	
		</isNotEmpty>
		<isEqual property="division" compareValue="Diff002">
				<![CDATA[		   
				 	AND B.DEPTNAME LIKE '%'||'支社'||'%'
				]]>	
		</isEqual>	
		<isEqual property="division" compareValue="Diff001">
				<![CDATA[		   
				 	AND B.DEPTNAME NOT LIKE '%'||'支社'||'%'
				]]>	
		</isEqual>				
	</select>

	<select id="selectFestivalPresentApplyCut" parameterClass="SimpleMap" resultClass="int">
		<![CDATA[
			SELECT COUNT(*) CUT
			  FROM HR_EMPLOYEE A, HR_DEPARTMENT B
			 WHERE A.DEPTID = B.DEPTID
			   AND (A.DATE_LEFT > SYSDATE OR A.DATE_LEFT IS NULL)
			   AND A.ACTIVITY = 1
			   AND ((EXISTS (SELECT SAD.ADMIN_DEPTID
			          FROM SY_ADMIN_DEPTID SAD, SY_ADMIN SA
			         WHERE SAD.ADMIN_NO = SA.ADMINNO
			           AND SA.ADMINID = #adminId#
			           AND SAD.ADMIN_DEPTID = B.DEPTID)) OR A.PERSON_ID = #adminId#)
	  	]]>
	  	<isNotEmpty prepend="AND" property="empId">
				<![CDATA[
				 	A.EMPID = #empId:VARCHAR#
			    ]]>
		</isNotEmpty>
	  	<isNotEmpty prepend="AND" property="personId">
				<![CDATA[		   
				 	 A.PERSON_ID = #personId#
				]]>	
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="DeptId">
				<![CDATA[
					B.DEPTID = #DeptId#
				]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="empStatus">
				<![CDATA[
					A.STATUS_CODE = #empStatus#
				]]>
		</isNotEmpty>
	  	<isNotEmpty prepend="AND" property="cpnyId">
				<![CDATA[		   
				 	 A.CPNY_ID = #cpnyId#
				]]>	
		</isNotEmpty>
		<isEqual property="division" compareValue="Diff002">
				<![CDATA[		   
				 	AND B.DEPTNAME LIKE '%'||'支社'||'%'
				]]>	
		</isEqual>	
		<isEqual property="division" compareValue="Diff001">
				<![CDATA[		   
				 	AND B.DEPTNAME NOT LIKE '%'||'支社'||'%'
				]]>	
		</isEqual>							
	</select>
	
	<select id="getSchemeName" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			SELECT A.SEQ_NO ID,
			       A.SCHEME_NAME NAME
			FROM GA_FESTIVAL_SCHEME A
			WHERE A.ACTIVITY = 1
			AND A.CPNY_ID = #cpnyId#
	 	]]>				
	</select>
	
	<select id="getSchemeDetail" resultClass="SimpleMap">
		<![CDATA[
			SELECT A.SEQ_NO SEQ_NO,
			       A.SCHEME_NO SCHEME_NO,
			       A.QUENTITY QUENTITY,
			       B.SEQ_NO PRESENT_NO,
			       B.PRESENT_NAME PRESENT_NAME,
			       B.BRAND BRAND,
			       B.UNIT_PRICE UNIT_PRICE,
			       GET_CODE_NAME(B.UNIT) UNIT,
			       B.SPECIFIC SPECIFIC,
			       (A.QUENTITY * B.UNIT_PRICE) TOTAL_PRICE,
			       C.SEQ_NO SCHEME_SEQ_NO
			  FROM GA_FESTIVAL_SCHEME_DETAIL A,
			       GA_FESTIVAL_PRESENT B,
			       GA_FESTIVAL_SCHEME C
			 WHERE B.SEQ_NO = A.PRESENT_NO
			   AND A.SCHEME_NO = C.SEQ_NO
			   AND A.ACTIVITY = 1
			   AND C.ACTIVITY = 1
			   AND B.ACTIVITY = 1	
	 	]]>				
	 	<isNotEmpty prepend="AND" property="schemeNo">
				<![CDATA[		   
				   C.SEQ_NO =  #schemeNo#
				]]>	
		</isNotEmpty>		
	</select>

	<insert id="insertApplyFestivalPresent" parameterClass="SimpleMap">
		<![CDATA[
			INSERT INTO GA_FESTIVAL_PRESENT_APPLY A
				  (A.SEQ_NO,
				   A.AFFIRM_FLAG,
				   A.CONFIRM_FLAG,
				   A.PRESENT_OBJECT,
				   A.SCHEME_NO,
				   A.CREATE_DATE,
				   A.CREATED_BY,
				   A.ACTIVITY)
				VALUES
				  (GA_FESTIVAL_PRESENT_APPLY_SEQ.NEXTVAL,
				   1,
				   0,
				   #presentObj:VARCHAR#,
				   #schemeNo:VARCHAR#,
				   SYSDATE,
				   #personId:VARCHAR#,
				   1)
		]]>
	</insert>
	<!-- 
	<insert id="insertFestivalPresentAffirm" parameterClass="SimpleMap">
		<![CDATA[	
			INSERT INTO GA_FESTIVAL_PRESENT_AFFIRM A
			       (A.SEQ_NO,
			        A.APPLY_NO,
			        A.AFFIRM_FLAG,
			        A.AFFIRM_LEVEL,
			        A.AFFIRMOR_ID,
			        A.CREATE_DATE,
			        A.CREATED_BY,
			        A.ACTIVITY)
			VALUES(GA_FESTIVAL_PRESENT_AFFIRM_SEQ.NEXTVAL,
			       GA_FESTIVAL_PRESENT_APPLY_SEQ.CURRVAL,
			       0,
			       #affirmLevel#,
			       #affirmId#,
			       SYSDATE,
			       #personId#,
			       1)     
		]]>
	</insert>
	-->
	
	<select id="selectFestivalConfrimView" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			SELECT A.SEQ_NO SEQ_NO,
			       A.AFFIRM_FLAG AFFIRM_FLAG,
			       A.CONFIRM_FLAG CONFIRM_FLAG,
			       A.CONFIRM_OPITION CONFIRM_OPITION,
			       B.EMPID EMPID,
			       B.PERSON_ID PERSON_ID,
			       B.CHINESENAME CHINESENAME,
			       GET_CODE_NAME(B.STATUS_CODE) STATUS_NAME,
			       C.DEPTID DEPTID,
			       GET_DEPT_NAME(C.DEPTID) DEPTNAME,
			       GET_DEPT_NAME(C.FOURTHDEPT) FOURTHDEPTNAME,
			       A.SCHEME_NO SCHEME_NO,
			       D.SCHEME_NAME SCHEME_NAME,
			       TO_CHAR(A.CREATE_DATE, 'YYYY-MM-DD') APPLY_DATE,
			       GET_EMP_NAME(A.CREATED_BY) APPLY_PERSON,
			       a.CREATED_BY,
			       GET_EMP_NAME(A.UPDATED_BY) CONFIRMOR_NAME
			     
			  FROM GA_FESTIVAL_PRESENT_APPLY A,HR_EMPLOYEE e,
			       HR_EMPLOYEE               B,
			       HR_DEPARTMENT             C,
			       GA_FESTIVAL_SCHEME        D
			 WHERE A.PRESENT_OBJECT = B.PERSON_ID
			   AND C.DEPTID = B.DEPTID
			   AND A.SCHEME_NO = D.SEQ_NO
			   AND A.ACTIVITY = 1
			   and a.CREATED_BY = e.person_id
			     
	  	]]>
		<isNotEmpty prepend="AND" property="ADMIN_ID">
		<![CDATA[
			EXISTS ( SELECT SAD.ADMIN_DEPTID
				   FROM SY_ADMIN_DEPTID SAD, SY_ADMIN SA
				  WHERE SAD.ADMIN_NO = SA.ADMINNO
				    AND SA.ADMINID = #ADMIN_ID:VARCHAR2#
				    AND SAD.ADMIN_DEPTID = e.deptid	
			   ) 
		]]>
	</isNotEmpty>
	  	<isNotEmpty prepend="AND" property="affirmViewId">
				<![CDATA[		   
				 	 A.CREATED_BY = #affirmViewId#
				]]>	
		</isNotEmpty>
	  	<isNotEmpty prepend="AND" property="seqNo">
				<![CDATA[		   
				 	 A.SEQ_NO = #seqNo#
				]]>	
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="empId">
				<![CDATA[
				 		B.EMPID = #empId:VARCHAR#
			    ]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="personId">
				<![CDATA[		   
				 	 B.PERSON_ID = #personId#
				]]>	
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="DeptId">
				<![CDATA[
					C.FOURTHDEPT = #DeptId#
				]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="empStatus">
				<![CDATA[
					B.STATUS_CODE = #empStatus#
				]]>
		</isNotEmpty>
	  	<isNotEmpty prepend="AND" property="cpnyId">
				<![CDATA[		   
				 	B.CPNY_ID = #cpnyId#
				]]>	
		</isNotEmpty>
		<isEqual property="affirmType" compareValue="">
				<![CDATA[		   
				 	AND A.SEQ_NO IN(SELECT T.APPLY_NO
							            FROM GA_FESTIVAL_PRESENT_AFFIRM T
							           WHERE T.AFFIRMOR_ID = #affirmId#)
				]]>	
		</isEqual>
		<isEqual property="affirmType" compareValue="AffirmType001">
				<![CDATA[		   
				 	AND A.AFFIRM_FLAG = 0
				 	AND A.SEQ_NO IN (	SELECT T.APPLY_NO
								          FROM GA_FESTIVAL_PRESENT_AFFIRM T
								         WHERE T.AFFIRMOR_ID = #affirmId#
								           AND T.AFFIRM_FLAG = 0
								           AND (T.APPLY_NO IN (SELECT TT.APPLY_NO
									                             FROM GA_FESTIVAL_PRESENT_AFFIRM TT
									                            WHERE TT.APPLY_NO = T.APPLY_NO
									                              AND TT.AFFIRMOR_ID <> T.AFFIRMOR_ID
									                              AND TT.AFFIRM_FLAG = 1
									                              AND TT.AFFIRM_LEVEL = T.AFFIRM_LEVEL - 1)
								                OR T.AFFIRM_LEVEL = '1'
								               )
				  					    )
				]]>	
		</isEqual>
		<isEqual  property="affirmType" compareValue="AffirmType002">
				<![CDATA[		   
				 	AND A.SEQ_NO IN(SELECT T.APPLY_NO
							            FROM GA_FESTIVAL_PRESENT_AFFIRM T
							           WHERE T.AFFIRM_FLAG = 1
									     AND T.AFFIRMOR_ID = #affirmId#)
				]]>	
		</isEqual>	
		<isEqual  property="affirmType" compareValue="AffirmType003">
				<![CDATA[		   
				 	AND A.SEQ_NO IN(SELECT T.APPLY_NO
							            FROM GA_FESTIVAL_PRESENT_AFFIRM T
							           WHERE T.AFFIRM_FLAG = 2
									     AND T.AFFIRMOR_ID = #affirmId#)
				]]>	
		</isEqual>
		<isEqual property="flag" compareValue="ConfirmType001">
				<![CDATA[		   
				 	AND A.CONFIRM_FLAG = 0
				]]>	
		</isEqual>
		<isEqual  property="flag" compareValue="ConfirmType002">
				<![CDATA[		   
				 	AND A.CONFIRM_FLAG = 1
				]]>	
		</isEqual>	
		<isEqual  property="flag" compareValue="ConfirmType003">
				<![CDATA[		   
				 	AND A.CONFIRM_FLAG = 2
				]]>	
		</isEqual>												
	</select>
	
	<select id="selectFestivalConfrimViewCut" parameterClass="SimpleMap" resultClass="int">
		<![CDATA[
			SELECT COUNT(*) CUT
			  FROM GA_FESTIVAL_PRESENT_APPLY A,HR_EMPLOYEE e,
			       HR_EMPLOYEE               B,
			       HR_DEPARTMENT             C,
			       GA_FESTIVAL_SCHEME        D
			 WHERE A.PRESENT_OBJECT = B.PERSON_ID
			   AND C.DEPTID = B.DEPTID
			   AND A.SCHEME_NO = D.SEQ_NO
			   AND A.ACTIVITY = 1
			   and a.CREATED_BY = e.person_id
			     
	  	]]>
	  	<isNotEmpty prepend="AND" property="affirmViewId">
				<![CDATA[		   
				 	 A.CREATED_BY = #affirmViewId#
				]]>	
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="ADMIN_ID">
		<![CDATA[
			EXISTS ( SELECT SAD.ADMIN_DEPTID
				   FROM SY_ADMIN_DEPTID SAD, SY_ADMIN SA
				  WHERE SAD.ADMIN_NO = SA.ADMINNO
				    AND SA.ADMINID = #ADMIN_ID:VARCHAR2#
				    AND SAD.ADMIN_DEPTID = e.deptid	
			   ) 
		]]>
	</isNotEmpty>
	  	<isNotEmpty prepend="AND" property="seqNo">
				<![CDATA[		   
				 	 A.SEQ_NO = #seqNo#
				]]>	
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="empId">
				<![CDATA[
				 		B.EMPID = #empId:VARCHAR#
			    ]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="personId">
				<![CDATA[		   
				 	 B.PERSON_ID = #personId#
				]]>	
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="DeptId">
				<![CDATA[
					C.FOURTHDEPT = #DeptId#
				]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="empStatus">
				<![CDATA[
					B.STATUS_CODE = #empStatus#
				]]>
		</isNotEmpty>
	  	<isNotEmpty prepend="AND" property="cpnyId">
				<![CDATA[		   
				 	B.CPNY_ID = #cpnyId#
				]]>	
		</isNotEmpty>
		<isEqual property="affirmType" compareValue="">
				<![CDATA[		   
				 	AND A.SEQ_NO IN(SELECT T.APPLY_NO
							            FROM GA_FESTIVAL_PRESENT_AFFIRM T
							           WHERE T.AFFIRMOR_ID = #affirmId#)
				]]>	
		</isEqual>
		<isEqual property="affirmType" compareValue="AffirmType001">
				<![CDATA[		   
				 	AND A.AFFIRM_FLAG = 0
				 	AND A.SEQ_NO IN (	SELECT T.APPLY_NO
								          FROM GA_FESTIVAL_PRESENT_AFFIRM T
								         WHERE T.AFFIRMOR_ID = #affirmId#
								           AND T.AFFIRM_FLAG = 0
								           AND (T.APPLY_NO IN (SELECT TT.APPLY_NO
									                             FROM GA_FESTIVAL_PRESENT_AFFIRM TT
									                            WHERE TT.APPLY_NO = T.APPLY_NO
									                              AND TT.AFFIRMOR_ID <> T.AFFIRMOR_ID
									                              AND TT.AFFIRM_FLAG = 1
									                              AND TT.AFFIRM_LEVEL = T.AFFIRM_LEVEL - 1)
								                OR T.AFFIRM_LEVEL = '1'
								               )
				  					    )
				]]>	
		</isEqual>
		<isEqual  property="affirmType" compareValue="AffirmType002">
				<![CDATA[		   
				 	AND A.SEQ_NO IN(SELECT T.APPLY_NO
							            FROM GA_FESTIVAL_PRESENT_AFFIRM T
							           WHERE T.AFFIRM_FLAG = 1
									     AND T.AFFIRMOR_ID = #affirmId#)
				]]>	
		</isEqual>	
		<isEqual  property="affirmType" compareValue="AffirmType003">
				<![CDATA[		   
				 	AND A.SEQ_NO IN(SELECT T.APPLY_NO
							            FROM GA_FESTIVAL_PRESENT_AFFIRM T
							           WHERE T.AFFIRM_FLAG = 2
									     AND T.AFFIRMOR_ID = #affirmId#)
				]]>	
		</isEqual>
		<isEqual property="flag" compareValue="ConfirmType001">
				<![CDATA[		   
				 	AND A.CONFIRM_FLAG = 0
				]]>	
		</isEqual>
		<isEqual  property="flag" compareValue="ConfirmType002">
				<![CDATA[		   
				 	AND A.CONFIRM_FLAG = 1
				]]>	
		</isEqual>	
		<isEqual  property="flag" compareValue="ConfirmType003">
				<![CDATA[		   
				 	AND A.CONFIRM_FLAG = 2
				]]>	
		</isEqual>												
	</select>
	
	<select id="getSchemeTotalPrice" resultClass="SimpleMap">
		<![CDATA[
			SELECT  A.SCHEME_NO SCHEME_NO,
			        SUM(B.UNIT_PRICE*A.QUENTITY) SCHEME_TOTAL
			FROM GA_FESTIVAL_SCHEME_DETAIL A,
			     GA_FESTIVAL_PRESENT B
			WHERE A.PRESENT_NO = B.SEQ_NO
			GROUP BY A.SCHEME_NO
		]]>
	</select>
	
	<update id="deleteFestivalPresentApply" parameterClass="SimpleMap">
		<![CDATA[
			UPDATE GA_FESTIVAL_PRESENT_APPLY A
			SET    A.ACTIVITY = 0
			WHERE A.SEQ_NO = #seqNo#
		]]>
	</update>
	
	<update id="deleteFestivalPresentAffirm" parameterClass="SimpleMap">
		<![CDATA[
			UPDATE GA_FESTIVAL_PRESENT_AFFIRM A
			SET    A.ACTIVITY = 0
			WHERE A.APPLY_NO = #seqNo#
		]]>
	</update>
	
	<select id="getFestivalPresentApplyAffirmor" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			SELECT A.SEQ_NO AFFIRM_NO,
			       A.APPLY_NO APPLY_NO,
			       A.AFFIRM_FLAG AFFIRM_FLAG,
			       A.AFFIRM_LEVEL AFFIRM_LEVEL,
			       GET_EMP_NAME(A.AFFIRMOR_ID) AFFIRMOR_NAME,
			       A.AFFIRM_OPITION AFFIRM_OPITION,
			       A.AFFIRMOR_ID AFFIRMOR_ID
			  FROM GA_FESTIVAL_PRESENT_AFFIRM A
		]]>
		<isNotEmpty prepend="WHERE" property="applyNo">
				<![CDATA[
					A.APPLY_NO = #applyNo#
				]]>
		</isNotEmpty>
		<![CDATA[
			ORDER BY A.AFFIRM_LEVEL
		]]>
	</select>
	
	<update id="updateFestivalPresentAffirm" parameterClass="SimpleMap">
		<![CDATA[
			UPDATE GA_FESTIVAL_PRESENT_AFFIRM A
			   SET A.AFFIRM_FLAG = #affirmFlag:NUMERIC#, 
			        A.AFFIRM_OPITION = #AFFIRM_OPITION:VARCHAR#, 
			        A.UPDATE_DATE = SYSDATE,
			        A.UPDATED_BY = #personId:VARCHAR#
			 WHERE A.APPLY_NO = #applyNo:VARCHAR#
			   AND A.AFFIRMOR_ID = #personId:VARCHAR#
		]]>
		<isNotEmpty prepend="AND" property="affirmNo">
				<![CDATA[
					A.SEQ_NO = #affirmNo#
				]]>
		</isNotEmpty>
	</update>
	
	<update id="updateFestivalPresentApplyForAffirm" parameterClass="SimpleMap">
		<![CDATA[
			UPDATE GA_FESTIVAL_PRESENT_APPLY A
			   SET A.AFFIRM_FLAG = #applyFlag:NUMERIC#
			 WHERE A.SEQ_NO = #applyNo:VARCHAR#
			   AND (SELECT DISTINCT B.AFFIRMOR_ID
			          FROM GA_FESTIVAL_PRESENT_AFFIRM B
			         WHERE B.APPLY_NO = #applyNo:VARCHAR#) = #personId:VARCHAR#
		]]>
	</update>
	
	<update id="updateFestivalPresentApplyForConfirm" parameterClass="SimpleMap">
		<![CDATA[
			UPDATE GA_FESTIVAL_PRESENT_APPLY A
			   SET A.CONFIRM_FLAG = #confirmFlag:NUMERIC#, 
			       A.CONFIRM_OPITION = #AFFIRM_OPITION:VARCHAR#,
			       A.UPDATE_DATE = SYSDATE,
			       A.UPDATED_BY = #personId:VARCHAR#
			 WHERE A.SEQ_NO = #applyNo:VARCHAR#
		]]>
	</update>
	
	<select id="getFestivalPresentProvideReportList" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			SELECT ROWNUM SEQ_NO,
			       G.PRESENT_NAME PRESENT_NAME,
			       G.BRAND BRAND,
			       G.SPECIFIC SPECIFIC,
			       GET_CODE_NAME(G.UNIT) UNIT,
			       G.UNIT_PRICE UNIT_PRICE,
			       QUE.QUENTITY QUENTITY,
			       (G.UNIT_PRICE * QUE.QUENTITY) TOTALSUM
			  FROM GA_FESTIVAL_PRESENT G,
			       (SELECT DISTINCT B.SEQ_NO PRESENT_NO, D.QUENTITY QUENTITY
			          FROM GA_FESTIVAL_PRESENT_APPLY A,
			               GA_FESTIVAL_PRESENT B,
			               GA_FESTIVAL_SCHEME_DETAIL C,
			               (SELECT A1.PRESENT_NO PRESENT_NO, SUM(A1.QUENTITY) QUENTITY
			                  FROM GA_FESTIVAL_PRESENT_APPLY A,
			                       GA_FESTIVAL_SCHEME_DETAIL A1
			                 WHERE A1.SCHEME_NO = A.SCHEME_NO
			                   AND A.CONFIRM_FLAG = 1
			                 GROUP BY A1.PRESENT_NO) D,
			               HR_EMPLOYEE E,
			               HR_DEPARTMENT H
			         WHERE A.CONFIRM_FLAG = 1
			           AND A.SCHEME_NO = C.SCHEME_NO
			           AND C.PRESENT_NO = B.SEQ_NO
			           AND D.PRESENT_NO = C.PRESENT_NO
			           AND A.PRESENT_OBJECT = E.PERSON_ID
			           AND E.DEPTID = H.DEPTID
			           AND A.ACTIVITY = 1
			           AND A.CREATE_DATE BETWEEN
			               TO_DATE(#provideStartDate#, 'YYYY-MM-DD')-1 AND
			               TO_DATE(#provideEndDate#, 'YYYY-MM-DD')+1) QUE
			 WHERE G.SEQ_NO = QUE.PRESENT_NO
			 AND   G.ACTIVITY = 1
		]]>
		<isNotEmpty prepend="AND" property="cpnyId">
		<![CDATA[
			G.CPNY_ID = #cpnyId#
		]]>
	</isNotEmpty>
	</select>

	<select id="getFestivalPresentSchemeReportList" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			SELECT DECODE(GROUPING(E.DEPTID),1,'合计',GET_DEPT_NAME(E.DEPTID)) DEPTID,
			       DECODE(GROUPING(E.DEPTID),1,'',MAX(A.SCHEME_NAME)) SCHEME_NAME,
			       DECODE(GROUPING(E.DEPTID),1,'',MAX(E.SCHEME_CUT)) SCHEME_CUT,
			       DECODE(GROUPING(E.DEPTID),1,'',MAX(D.TOTALSUM)) SHCEME_TOTAL,
			       DECODE(GROUPING(E.DEPTID),1,'',MAX(A.SEQ_NO)) SCHEME_NO,
			       DECODE(GROUPING(E.DEPTID),1,SUM(E.SCHEME_CUT * D.TOTALSUM),MAX((E.SCHEME_CUT * D.TOTALSUM))) TOTALPRICE
			  FROM GA_FESTIVAL_SCHEME A,
			       (SELECT B.SEQ_NO SEQ_NO, SUM(C.UNIT_PRICE * A.QUENTITY) TOTALSUM
			          FROM GA_FESTIVAL_SCHEME_DETAIL A,
			               GA_FESTIVAL_SCHEME        B,
			               GA_FESTIVAL_PRESENT       C
			         WHERE A.SCHEME_NO = B.SEQ_NO
			           AND A.PRESENT_NO = C.SEQ_NO
			           AND B.CPNY_ID = #cpnyId:VARCHAR#
			         GROUP BY B.SEQ_NO) D,
			       (SELECT R.DEPTID,
			               MAX(P.SCHEME_NO) SCHEME_NO,
			               COUNT(P.SCHEME_NO) SCHEME_CUT
			          FROM GA_FESTIVAL_PRESENT_APPLY P, HR_EMPLOYEE Q, HR_DEPARTMENT R
			         WHERE P.CONFIRM_FLAG = 1
			           AND P.PRESENT_OBJECT = Q.PERSON_ID
			           AND Q.DEPTID = R.DEPTID
			           AND Q.CPNY_ID = #cpnyId:VARCHAR#
	    ]]>
	    <isNotEmpty prepend="" property="SchemeStartDate">
			<isNotEmpty prepend="AND" property="SchemeEndDate">
				<![CDATA[		   
				 	P.CREATE_DATE BETWEEN TO_DATE(#SchemeStartDate#,'YYYY-MM-DD')-1 AND TO_DATE(#SchemeEndDate#,'YYYY-MM-DD')+1
				]]>	
			</isNotEmpty>
		</isNotEmpty>
		<![CDATA[
			         GROUP BY R.DEPTID) E
			 WHERE D.SEQ_NO = E.SCHEME_NO
			 AND   A.SEQ_NO = E.SCHEME_NO
			 AND   A.CPNY_ID = #cpnyId#
			 GROUP BY ROLLUP(E.DEPTID)
		]]>
	</select>
	
	<select id="getFestivalPresentQuentityReportList" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			SELECT B.SEQ_NO SCHEME_NO,
				   GET_DEPT_NAME(D.FOURTHDEPT) FOURDEPTNAME,
			       GET_DEPT_NAME(C.DEPTID) DPETNAME,
			       C.CHINESENAME CHINESENAME,
			       B.SCHEME_NAME SCHEMENAME
			FROM GA_FESTIVAL_PRESENT_APPLY A,
			     GA_FESTIVAL_SCHEME B,
			     HR_EMPLOYEE C,
			     HR_DEPARTMENT D
			WHERE A.CONFIRM_FLAG = 1
			AND   A.SCHEME_NO = B.SEQ_NO
			AND   A.PRESENT_OBJECT = C.PERSON_ID
			AND   C.DEPTID = D.DEPTID		
		]]>
		<isNotEmpty prepend="" property="SchemeStartDate">
			<isNotEmpty prepend="AND" property="SchemeEndDate">
				<![CDATA[		   
				 	A.CREATE_DATE BETWEEN TO_DATE(#QuentityStartDate#,'YYYY-MM-DD')-1 AND TO_DATE(#QuentityEndDate#,'YYYY-MM-DD')+1
				]]>	
			</isNotEmpty>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="schemeName">
			<![CDATA[
				B.SEQ_NO = #schemeName:VARCHAR#
			]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="cpnyId">
			<![CDATA[
				B.CPNY_ID = #cpnyId#
			]]>
		</isNotEmpty>
		<![CDATA[
			ORDER BY B.SCHEME_NAME
		]]>
	</select>
	
	<update id="updateSchemeActivity" parameterClass="SimpleMap">
		<![CDATA[
			UPDATE GA_FESTIVAL_SCHEME A
			SET A.ACTIVITY = #op:NUMERIC#
			WHERE A.SEQ_NO = #AseqNo:VARCHAR#			
		]]>
	</update>

</sqlMap>
