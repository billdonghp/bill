<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">

<sqlMap namespace="ess.common">


	<!-- LSFC要求打印同一时期加班申请报表进行线下决裁 -->
	<select id="retrieveApplyOTDetail" parameterClass="string" resultClass="SimpleMap">
		<![CDATA[	
			
		SELECT APPLY_OT_NO, EV.APPLY_GROUP_NO, EMPID, APPLYER, ENAPPLYER,
		       CHINESE_PINYIN, POST_CODE, DEPTID, DEPTNAME,
		       PARENTDEPTNAME, APPLY_OT_TYPE_CODE,
		       APPLY_OT_TYPE, APPLY_OT_EN_TYPE, APPLY_OT_LENGTH, APPLY_OT_DATE,
		       OT_FROM_TIME, OT_TO_TIME, APPLY_OT_REMARK,
		       TO_CHAR (CREATE_DATE, 'YYYY-MM-DD') CREATE_DATE, CREATED_BY,
		       REMARK APPLY_OT_REMARK, POST, ENGLISHPOST, KORPOST, POSITION,
		       ENGLISHPOSITION, KORPOSITION, TIME_AREA
		  FROM ESS_APPLY_OT_V EV,
		       (SELECT     APPLY_GROUP_NO,
		                   LTRIM
		                      (MAX (SYS_CONNECT_BY_PATH (CHINESENAME, ','))KEEP (DENSE_RANK LAST ORDER BY CURR),
		                       ','
		                      ) AS APPLYER,
		                   LTRIM
		                      (MAX (SYS_CONNECT_BY_PATH (CHINESE_PINYIN, ','))KEEP (DENSE_RANK LAST ORDER BY CURR),
		                       ','
		                      ) AS ENAPPLYER
		              FROM (SELECT CHINESENAME, CHINESE_PINYIN, APPLY_GROUP_NO,
		                           ROW_NUMBER () OVER (PARTITION BY A.APPLY_GROUP_NO ORDER BY A.EMPID) AS CURR,
		                           ROW_NUMBER () OVER (PARTITION BY A.APPLY_GROUP_NO ORDER BY A.EMPID)
		                           - 1 AS PREV
		                      FROM ESS_APPLY_OT A,
							   	   HR_EMPLOYEE B
		                     WHERE A.APPLY_GROUP_NO = (SELECT APPLY_GROUP_NO FROM ESS_APPLY_OT WHERE APPLY_OT_NO = #APPLY_OT_NO#)
							   AND A.EMPID = B.Person_Id)
		          GROUP BY APPLY_GROUP_NO
		        START WITH CURR = 1
		        CONNECT BY PREV = PRIOR CURR) AV
		 WHERE EV.APPLY_GROUP_NO = AV.APPLY_GROUP_NO AND APPLY_OT_NO =#APPLY_OT_NO#
       
		]]>
	</select>
	
	
		<select id="getLeaveReportType" parameterClass="string" resultClass="int">
		<![CDATA[	
		  SELECT COUNT(DISTINCT 
		      (
		  TO_CHAR(leave_from_time,'YYYY-MM-DD HH24:MI:SS')||'~~'||TO_CHAR(leave_to_time,'YYYY-MM-DD HH24:MI:SS'))
		 )MOUNT
		 FROM ess_leave_apply_v WHERE APPLY_GROUP_NO=
		            (SELECT APPLY_GROUP_NO FROM ess_leave_apply_v WHERE  leave_no=#LEAVE_NO#) 
			]]>                                                                                 
	</select>
	
	<select id="getReportType" parameterClass="string" resultClass="int">
		<![CDATA[	
			SELECT COUNT(DISTINCT TIME_AREA)MOUNT FROM ESS_APPLY_OT_V WHERE APPLY_GROUP_NO=
            (SELECT APPLY_GROUP_NO FROM ESS_APPLY_OT_V WHERE  APPLY_OT_NO=#APPLY_OT_NO#) 
		]]>
	</select>
	
	<select id="getOverTimeApplerList" parameterClass="string" resultClass="SimpleMap">
		<![CDATA[	
      select apply_group_no,TO_CHAR(EAO.create_date,'YYYY-MM-DD')create_date,
           parentdeptname,begintime,endtime, EAO.chinesename,EAO.apply_ot_type,
              apply_ot_remark content from ESS_APPLY_OT_V  EAO
                where apply_group_no=(select apply_group_no from ESS_APPLY_OT_V where  APPLY_OT_NO=#APPLY_OT_NO#)
		]]>
	</select>
	
	<select id="getLeaveApplerList" parameterClass="string" resultClass="SimpleMap">
		<![CDATA[	   
        
     select apply_group_no,TO_CHAR(EAO.create_date,'YYYY-MM-DD')create_date,
           parentdeptname,to_char(leave_from_time,'YYYY-MM-DD HH24:MI:SS')begintime,to_char(leave_to_time,'YYYY-MM-DD HH24:MI:SS')endtime, 
           EAO.chinesename,EAO.leave_type_name,
            leave_reason  from ess_leave_apply_v  EAO
           where apply_group_no=(select apply_group_no from ess_leave_apply_v where  leave_no=#LEAVE_NO#)
		]]>
	</select>
	
	<!-- retrieve apply overtime affirmor detail -->
	<select id="retrieveApplyOTAffirmor" parameterClass="string" resultClass="EssAffirmor">
		<![CDATA[		
			SELECT E.CHINESENAME affirmorName
			  FROM HR_EMPLOYEE E, ESS_AFFIRM A, ESS_APPLY_OT O
			 WHERE E.EMPID = A.AFFIRMOR_ID
			   AND O.APPLY_OT_NO = #APPLY_OT_NO#
			   AND O.APPLY_OT_NO = A.APPLY_NO
			   AND A.APPLY_TYPE = 'OtApply'
			 ORDER BY O.APPLY_OT_NO, A.AFFIRM_LEVEL
		]]>
	</select>
	
	<!-- retrieve apply leave/evection/training affirmor detail -->
	<select id="retrieveApplyAffirmor" parameterClass="SimpleMap" resultClass="EssAffirmor">
		<![CDATA[		
			 SELECT E.CHINESENAME affirmorName
			  FROM HR_EMPLOYEE E, ESS_AFFIRM A, ESS_LEAVE_APPLY_TB O
			 WHERE E.PERSON_ID = A.AFFIRMOR_ID
			   AND O.LEAVE_NO = A.APPLY_NO
				 AND O.LEAVE_NO = #LEAVE_NO#
			   AND A.APPLY_TYPE = #TYPE#
			 ORDER BY O.LEAVE_NO, A.AFFIRM_LEVEL
		]]>
	</select>
	
	<!-- retrieve apply leave detail -->
	<select id="retrieveApplyLeaveDetail" parameterClass="string" resultClass="SimpleMap">
		<![CDATA[	
			SELECT LEAVE_NO, 
			 		EMPID, 
			 	APPLYER, 
               ENAPPLYER,
					CHINESENAME, 
					CHINESE_PINYIN, 
			        ENDEPT,
			        LEAVE_TYPE_EN_NAME,
			        POSTENNAME,
			        POSITIONENNAME,  
					POST_CODE, 
			 		DEPTID, 
					DEPTNAME, 
					LEAVE_TYPE, 
			 		LEAVE_TYPE_NAME, 
			 		LEAVE_TYPE_EN_NAME,
					TO_CHAR(LEAVE_FROM_TIME,'YYYY-MM-DD HH24:MI') LEAVE_FROM_TIME, 
					TO_CHAR(LEAVE_TO_TIME,'YYYY-MM-DD HH24:MI') LEAVE_TO_TIME, 
					LEAVE_REASON, 
					TO_CHAR(CREATE_DATE,'YYYY-MM-DD') CREATE_DATE, 
			 		CREATED_BY, 
					REMARK, 
					POST, 
					POSITION,
                    positionEnName,
                    postEnName,
                    enDept,       
                    leave_type_en_name,
                    AV.APPLY_GROUP_NO
			   FROM ESS_LEAVE_APPLY_V EV,
              (
               SELECT  APPLY_GROUP_NO, LTRIM
               (MAX (SYS_CONNECT_BY_PATH (CHINESENAME, ','))KEEP (DENSE_RANK LAST ORDER BY curr),',') AS applyer,
                LTRIM(MAX (SYS_CONNECT_BY_PATH (CHINESE_PINYIN, ','))KEEP (DENSE_RANK LAST ORDER BY curr),',') AS enapplyer
               FROM (
               SELECT CHINESENAME,CHINESE_PINYIN ,APPLY_GROUP_NO,
               ROW_NUMBER () OVER (PARTITION BY A.APPLY_GROUP_NO ORDER BY A.empid) AS curr,
               ROW_NUMBER () OVER (PARTITION BY A.APPLY_GROUP_NO ORDER BY A.empid)- 1 AS prev
               FROM ESS_LEAVE_APPLY_V A
			  WHERE A.apply_group_no=(select apply_group_no from ESS_LEAVE_APPLY_V where LEAVE_NO=#LEAVE_NO#))
                  GROUP BY APPLY_GROUP_NO  START WITH curr = 1
                  CONNECT BY prev = PRIOR curr  ) AV
			  WHERE EV.apply_group_no=AV.APPLY_GROUP_NO 
              AND LEAVE_NO = #LEAVE_NO#
		]]>
	</select>
	<!-- - -->
	<select id="regularlySentMailInfoList" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[	
			
		SELECT APPLY.LEAVE_NO,
		       TO_CHAR(APPLY.CREATE_DATE, 'YYYY-MM-DD HH24:MI') APPLY_DATE,
		       TO_CHAR(APPLY.LEAVE_FROM_TIME, 'YYYY-MM-DD HH24:MI') FROM_DATE,
		       TO_CHAR(APPLY.LEAVE_TO_TIME, 'YYYY-MM-DD HH24:MI') TO_DATE,
		       APPLY.LEAVE_REASON,
		       SY.CODE_NAME APPLY_TYPE,
		       HR.EMPID APPLYOREMPID,
		       HR.CHINESENAME APPLYORNAME,
		       ESSAFFIRMINFO.CHINESENAME AFFIMORNAME,
		       ESSAFFIRMINFO.EMAIL AFFIMOREMAIL,
		       ESSAFFIRMINFO.EMPID AFFIMOREMPID,
		       ESSAFFIRMINFO.PERSON_ID AFFIMORPERSONID
		  FROM ESS_LEAVE_APPLY_TB APPLY,
		       HR_EMPLOYEE HR,
		       SY_CODE SY,
		       (SELECT AFFIRMINFO.APPLY_NO,
		               AFFIRMINFO.CHINESENAME,
		               AFFIRMINFO.EMAIL,
		               AFFIRMINFO.EMPID,
		               AFFIRMINFO.EMAIL,
		               AFFIRMINFO.PERSON_ID
		          FROM (SELECT AFFIRM.APPLY_NO,
		                       HH.CHINESENAME,
		                       HH.EMAIL,
		                       HH.EMPID,
		                       HH.PERSON_ID,
		                       HH.EMAIL,
		                       AFFIRM.AFFIRM_LEVEL
		                  FROM ESS_AFFIRM AFFIRM, HR_EMPLOYEE HH
		                 WHERE AFFIRM.AFFIRMOR_ID = HH.PERSON_ID
		                   AND AFFIRM.APPLY_TYPE = 'LeaveApply'
		                   AND AFFIRM.AFFIRM_FLAG = 0
		                   AND HH.CPNY_ID = '63000000') AFFIRMINFO,
		               (SELECT AFFIRM.APPLY_NO, MIN(AFFIRM.AFFIRM_LEVEL) AFFIRM_LEVEL
		                  FROM ESS_AFFIRM AFFIRM, HR_EMPLOYEE HH
		                 WHERE AFFIRM.AFFIRMOR_ID = HH.PERSON_ID
		                   AND AFFIRM.APPLY_TYPE = 'LeaveApply'
		                   AND AFFIRM.AFFIRM_FLAG = 0
		                   AND HH.CPNY_ID = '63000000'
		                 GROUP BY AFFIRM.APPLY_NO
		                
		                ) MINAFFIRMLEVEL
		         WHERE AFFIRMINFO.APPLY_NO = MINAFFIRMLEVEL.APPLY_NO
		           AND AFFIRMINFO.AFFIRM_LEVEL = MINAFFIRMLEVEL.AFFIRM_LEVEL		           
		        ) ESSAFFIRMINFO
		 WHERE APPLY.LEAVE_EMPID = HR.PERSON_ID
		   AND APPLY.LEAVE_TYPE = SY.CODE_ID
		   AND APPLY.ACTIVITY = 0
		   AND HR.CPNY_ID = '63000000'
		   AND APPLY.LEAVE_NO = ESSAFFIRMINFO.APPLY_NO
		   AND APPLY.CREATE_DATE+3 < SYSDATE
		   AND 1=2
			
		]]>
	</select>
	<update id="insertRegularlySentMailInfo" parameterClass="SimpleMap" >
	  INSERT INTO ESS_REGULARLYSENTMAIL_RECORD(
				  PKNO,
				  MAILSENDTO,
				  EMAIL,
				  COUNTS,
				  SENDTIME,
				  APPLYOR
	            )            
	 SELECT REGULARLYSENTMAIL_SEQ.NEXTVAL PKNO,
	       #AFFIMORPERSONID:VARCHAR# MAILSENDTO,
	       #AFFIMOREMAIL:VARCHAR# EMAIL,
	       0 COUNTS,
	       SYSDATE SENDTIME,
	       #APPLYOREMPID:VARCHAR# APPLYOR
	  FROM DUAL
	 WHERE NOT EXISTS (        
	        SELECT 1
	          FROM ESS_REGULARLYSENTMAIL_RECORD T
	         WHERE T.MAILSENDTO = #AFFIMORPERSONID:VARCHAR#
	           AND T.APPLYOR = #APPLYOREMPID:VARCHAR#)
	
	</update>	
	<update id="updateRegularlySentMailCounts" parameterClass="SimpleMap" >
	UPDATE ESS_REGULARLYSENTMAIL_RECORD T
	SET T.COUNTS=(T.COUNTS+1)
	WHERE T.MAILSENDTO = #AFFIMORPERSONID:VARCHAR#
           AND T.APPLYOR =#APPLYOREMPID:VARCHAR#		
	</update>
	
	
	<select id="regularlyUpdateOtAffirmorInfoList" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[		
		SELECT APPLY.APPLY_OT_NO,
             TO_CHAR(APPLY.APPLY_OT_DATE - OT_NIGHT_FLAG, 'YYYY-MM-DD') AS otDate,
             TO_CHAR(APPLY.APPLY_OT_DATE, 'YYYY-MM-DD ') ||
             APPLY.OT_FROM_TIME AS otFromTime,
             TO_CHAR(APPLY.APPLY_OT_DATE + APPLY.APPLY_OT_FLAG,
                  'YYYY-MM-DD ') || APPLY.OT_TO_TIME AS otToTime,
              CASE
            WHEN OT_LENGTH > 0 THEN
             OT_LENGTH
            ELSE
             (TO_DATE(TO_CHAR(APPLY.APPLY_OT_DATE +
                              APPLY.APPLY_OT_FLAG,
                              'YYYY-MM-DD ') || APPLY.OT_TO_TIME,
                      'YYYY-MM-DD HH24:MI') -
             TO_DATE(TO_CHAR(APPLY.APPLY_OT_DATE, 'YYYY-MM-DD ') ||
                      APPLY.OT_FROM_TIME,
                      'YYYY-MM-DD HH24:MI')) * 24 - APPLY.OT_DEDUCT_TIME
          END AS otLength,     
             SY.CODE_NAME APPLY_TYPE,
             HR.EMPID APPLYOREMPID,
             HR.CHINESENAME APPLYORNAME,
             ESSAFFIRMINFO.CHINESENAME AFFIMORNAME,
             ESSAFFIRMINFO.EMPID AFFIMOREMPID,
             ESSAFFIRMINFO.AFFIRM_LEVEL,
             ESSAFFIRMINFO.PERSON_ID AFFIMORPERSONID
        FROM ESS_APPLY_OT APPLY,
             HR_EMPLOYEE HR,
             SY_CODE SY,
             (SELECT AFFIRMINFO.APPLY_NO,
                     AFFIRMINFO.CHINESENAME,
                     AFFIRMINFO.EMPID,
                     AFFIRMINFO.PERSON_ID,
                     AFFIRMINFO.AFFIRM_LEVEL
                FROM (SELECT AFFIRM.APPLY_NO,
                             HH.CHINESENAME,
                             HH.EMPID,
                             HH.PERSON_ID,
                             AFFIRM.AFFIRM_LEVEL
                        FROM ESS_AFFIRM AFFIRM, HR_EMPLOYEE HH
                       WHERE AFFIRM.AFFIRMOR_ID = HH.PERSON_ID
                         AND AFFIRM.APPLY_TYPE = 'OtApply'
                         AND AFFIRM.AFFIRM_FLAG = 0
                         AND HH.CPNY_ID = '78000000') AFFIRMINFO,
                     (SELECT AFFIRM.APPLY_NO, MIN(AFFIRM.AFFIRM_LEVEL) AFFIRM_LEVEL
                        FROM ESS_AFFIRM AFFIRM, HR_EMPLOYEE HH
                       WHERE AFFIRM.AFFIRMOR_ID = HH.PERSON_ID
                         AND AFFIRM.APPLY_TYPE = 'OtApply'
                         AND AFFIRM.AFFIRM_FLAG = 0
                         AND HH.CPNY_ID = '78000000'
                       GROUP BY AFFIRM.APPLY_NO
                      
                      ) MINAFFIRMLEVEL
               WHERE AFFIRMINFO.APPLY_NO = MINAFFIRMLEVEL.APPLY_NO
                 AND AFFIRMINFO.AFFIRM_LEVEL = MINAFFIRMLEVEL.AFFIRM_LEVEL               
              ) ESSAFFIRMINFO
       WHERE APPLY.EMPID = HR.PERSON_ID

         AND APPLY.Apply_Ot_Type_Code = SY.CODE_ID
         AND APPLY.ACTIVITY = 0
         AND HR.CPNY_ID = '78000000'
         AND hr_get_level_deptid(HR.DEPTID, 4) IN ('780G1000','780G9000')
         AND APPLY.APPLY_OT_NO = ESSAFFIRMINFO.APPLY_NO
         AND APPLY.APPLY_OT_NO NOT IN (select DISTINCT APPLY_NO from ESS_REGULARLY_OT_RECORD)
         AND APPLY.CREATE_DATE > to_date(to_char(decode(to_char(sysdate, 'day'),
                              '星期六',
                               to_date('2999-12-31','YYYY-MM-DD'),
                              '星期日',
                               to_date('2999-12-31','YYYY-MM-DD'),
                               '星期一',
                              sysdate - 3,
                              sysdate - 1),
                       'yyyy-mm-dd'),
               'yyyy-mm-dd')
        AND APPLY.CREATE_DATE < to_date(to_char(sysdate,'yyyy-mm-dd'),'yyyy-mm-dd')    
				
		]]>
	</select>
	<!--211449  韩铁洙 -->
	<update id="updateRegularlyOtAffirmorInfo" parameterClass="SimpleMap" >
	<![CDATA[
           UPDATE ESS_AFFIRM T	
		      SET T.AFFIRMOR_ID = '211449',T.CREATE_DATE = SYSDATE 
		      WHERE T.APPLY_NO = #APPLY_OT_NO# 
		      AND T.AFFIRMOR_ID = #AFFIMORPERSONID#
		      AND AFFIRM_LEVEL = #AFFIRM_LEVEL# 
		      AND T.AFFIRM_FLAG = 0
	]]>	      
	</update>
	
	<delete id="deleteRegularlyOtAffirmorInfo" parameterClass="SimpleMap">
		<![CDATA[
			DELETE ESS_AFFIRM  
			WHERE APPLY_NO = #APPLY_OT_NO# 
			AND AFFIRM_FLAG = 0 
			AND AFFIRM_LEVEL > #AFFIRM_LEVEL#
		]]>
	</delete>
	
	<delete id="deleteRegularlyEvEmp" parameterClass="SimpleMap">
		<![CDATA[
			DELETE FROM　EV_HR_EMPLOYEE 
		]]>
	 </delete>
	<delete id="deleteRegularlyEvDep" parameterClass="SimpleMap">
		<![CDATA[
			DELETE FROM　EV_HR_DEPARTMENT 
		]]>
	 </delete>
	 <insert id="insertRegularlyEvEmp" parameterClass="SimpleMap">
		<![CDATA[
			INSERT INTO EV_HR_EMPLOYEE ( SELECT * FROM　HR_EMPLOYEE WHERE CPNY_ID in ('78000000','63000000') )
		]]>
	 </insert>
	 <insert id="insertRegularlyEvDep" parameterClass="SimpleMap">
		<![CDATA[
			INSERT INTO EV_HR_DEPARTMENT ( SELECT * FROM　HR_DEPARTMENT WHERE CPNY_ID in ('78000000','63000000') )
		]]>
	 </insert>
	 
	 
	 <insert id="insertEvEmpDeleteY" parameterClass="SimpleMap">
		<![CDATA[
			INSERT INTO EV_HR VALUES('delete','employee','Y',SYSDATE)
		]]>
	 </insert>
	 <insert id="insertEvDepDeleteY" parameterClass="SimpleMap">
		<![CDATA[
			INSERT INTO EV_HR VALUES('delete','department','Y',SYSDATE)
		]]>
	 </insert>
	 <insert id="insertEvEmpInsertY" parameterClass="SimpleMap">
		<![CDATA[
			INSERT INTO EV_HR VALUES('insert','employee','Y',SYSDATE)
		]]>
	 </insert>
	 <insert id="insertEvDepInsertY" >
		<![CDATA[
			INSERT INTO EV_HR VALUES('insert','department','Y',SYSDATE)
		]]>
	 </insert>
	
	
	<insert id="insertRegularlyOtAffirmorInfo" parameterClass="SimpleMap" >
     <![CDATA[
			 INSERT INTO ESS_REGULARLY_OT_RECORD
					  (ID,
					   ESS_AFFIRM_NO,
					   APPLY_NO,
					   AFFIRM_FLAG,
					   AFFIRM_LEVEL,
					   AFFIRMOR_ID,
					   CREATE_DATE,
					   CREATED_BY,
					   UPDATE_DATE,
					   UPDATED_BY,
					   ACTIVITY,
					   APPLY_TYPE,
					   AFFIRM_REMARKS,
					   AFFIRM_LEVEL_ORIGINAL,
					   INSERT_TIME)
					  (SELECT ESS_REGULARLY_OT_SEQ.NEXTVAL,
					          T.ESS_AFFIRM_NO,
					          T.APPLY_NO,
					          T.AFFIRM_FLAG,
					          T.AFFIRM_LEVEL,
					          T.AFFIRMOR_ID,
					          T.CREATE_DATE,
					          T.CREATED_BY,
					          T.UPDATE_DATE,
					          T.UPDATED_BY,
					          T.ACTIVITY,
					          T.APPLY_TYPE,
					          T.AFFIRM_REMARKS,
					          T.AFFIRM_LEVEL_ORIGINAL,
					          SYSDATE
					     FROM ESS_AFFIRM T
					    WHERE T.APPLY_NO = #APPLY_OT_NO#
				          AND T.AFFIRM_FLAG = 0
				          AND T.AFFIRM_LEVEL >= #AFFIRM_LEVEL#)
	  ]]>
	</insert>	
	
	<select id="regularly780SentOtEmpidInfoList" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[		
		SELECT  DISTINCT ESSAFFIRMINFO.PERSON_ID AFFIMORPERSONID,
                ESSAFFIRMINFO.CHINESENAME AFFIMORNAME,
		        ESSAFFIRMINFO.EMAIL AFFIMOREMAIL
	           FROM ESS_APPLY_OT APPLY,
	             HR_EMPLOYEE HR,
	             SY_CODE SY,
	             (SELECT AFFIRMINFO.APPLY_NO,
	                     AFFIRMINFO.CHINESENAME,
	                     AFFIRMINFO.EMPID,
	                     AFFIRMINFO.PERSON_ID,
	                     AFFIRMINFO.EMAIL,
	                     AFFIRMINFO.AFFIRM_LEVEL
	                FROM (SELECT AFFIRM.APPLY_NO,
	                             HH.CHINESENAME,
	                             HH.EMPID,
	                             HH.PERSON_ID,
	                             HH.EMAIL,
	                             AFFIRM.AFFIRM_LEVEL
	                        FROM ESS_AFFIRM AFFIRM, HR_EMPLOYEE HH
	                       WHERE AFFIRM.AFFIRMOR_ID = HH.PERSON_ID
	                         AND AFFIRM.APPLY_TYPE = 'OtApply'
	                         AND AFFIRM.AFFIRM_FLAG = 0
	                         AND HH.CPNY_ID = '78000000') AFFIRMINFO,
	                     (SELECT AFFIRM.APPLY_NO, MAX(AFFIRM.AFFIRM_LEVEL) AFFIRM_LEVEL
	                        FROM ESS_AFFIRM AFFIRM, HR_EMPLOYEE HH
	                       WHERE AFFIRM.AFFIRMOR_ID = HH.PERSON_ID
	                         AND AFFIRM.APPLY_TYPE = 'OtApply'
	                         AND AFFIRM.AFFIRM_FLAG = 0
	                         AND HH.CPNY_ID = '78000000'
	                       GROUP BY AFFIRM.APPLY_NO
	                      
	                      ) MAXAFFIRMLEVEL
	               WHERE AFFIRMINFO.APPLY_NO = MAXAFFIRMLEVEL.APPLY_NO
	                 AND AFFIRMINFO.AFFIRM_LEVEL = MAXAFFIRMLEVEL.AFFIRM_LEVEL               
	              ) ESSAFFIRMINFO
	       WHERE APPLY.EMPID = HR.PERSON_ID
	
	         AND APPLY.Apply_Ot_Type_Code = SY.CODE_ID
	         AND APPLY.ACTIVITY = 0
	         AND HR.CPNY_ID = '78000000'
	         AND hr_get_level_deptid(HR.DEPTID, 4) IN ('780G1000','780G9000')
	         AND APPLY.APPLY_OT_NO = ESSAFFIRMINFO.APPLY_NO
	         AND APPLY.CREATE_DATE > to_date(to_char(decode(to_char(sysdate, 'day'),
	                              '星期六',
	                               to_date('2999-12-31','YYYY-MM-DD'),
	                              '星期日',
	                               to_date('2999-12-31','YYYY-MM-DD'),
	                               '星期一',
	                              sysdate - 3,
	                              sysdate - 1),
	                       'yyyy-mm-dd'),
	               'yyyy-mm-dd')
	        AND APPLY.CREATE_DATE < to_date(to_char(sysdate,'yyyy-mm-dd'),'yyyy-mm-dd') 
	        AND(select COUNT(*) from ESS_REGULARLY_OT_RECORD t WHERE T.CPNY_ID = '78000000' AND t.ot_date = TO_CHAR (SYSDATE,'YYYY-MM-DD'))=0 
				
		]]>
	</select>
	
	<select id="regularly610SentOtEmpidInfoList" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[		
		SELECT  DISTINCT ESSAFFIRMINFO.PERSON_ID AFFIMORPERSONID,
                ESSAFFIRMINFO.CHINESENAME AFFIMORNAME,
	            ESSAFFIRMINFO.EMAIL AFFIMOREMAIL
	             FROM ESS_APPLY_OT APPLY,
	               HR_EMPLOYEE HR,
	               SY_CODE SY,
	               (SELECT AFFIRMINFO.APPLY_NO,
	                       AFFIRMINFO.CHINESENAME,
	                       AFFIRMINFO.EMPID,
	                       AFFIRMINFO.PERSON_ID,
	                       AFFIRMINFO.EMAIL,
	                       AFFIRMINFO.AFFIRM_LEVEL
	                  FROM (SELECT AFFIRM.APPLY_NO,
	                               HH.CHINESENAME,
	                               HH.EMPID,
	                               HH.PERSON_ID,
	                               HH.EMAIL,
	                               AFFIRM.AFFIRM_LEVEL
	                          FROM ESS_AFFIRM AFFIRM, HR_EMPLOYEE HH
	                         WHERE AFFIRM.AFFIRMOR_ID = HH.PERSON_ID
	                           AND AFFIRM.APPLY_TYPE = 'OtApply'
	                           AND AFFIRM.AFFIRM_FLAG = 0
	                           AND HH.CPNY_ID = '61000000') AFFIRMINFO,
	                       (SELECT AFFIRM.APPLY_NO, MAX(AFFIRM.AFFIRM_LEVEL) AFFIRM_LEVEL
	                          FROM ESS_AFFIRM AFFIRM, HR_EMPLOYEE HH
	                         WHERE AFFIRM.AFFIRMOR_ID = HH.PERSON_ID
	                           AND AFFIRM.APPLY_TYPE = 'OtApply'
	                           AND AFFIRM.AFFIRM_FLAG = 0
	                           AND HH.CPNY_ID = '61000000'
	                         GROUP BY AFFIRM.APPLY_NO
	                        
	                        ) MAXAFFIRMLEVEL
	                 WHERE AFFIRMINFO.APPLY_NO = MAXAFFIRMLEVEL.APPLY_NO
	                   AND AFFIRMINFO.AFFIRM_LEVEL = MAXAFFIRMLEVEL.AFFIRM_LEVEL               
	                ) ESSAFFIRMINFO
	         WHERE APPLY.EMPID = HR.PERSON_ID
	  
	           AND APPLY.Apply_Ot_Type_Code = SY.CODE_ID
	           AND APPLY.ACTIVITY = 0
	           AND HR.CPNY_ID = '61000000'
	           AND hr_get_level_deptid(HR.DEPTID, 4) IN ('610T3700','610C5000','610C6000','610G6000','610G5000')
	           AND APPLY.APPLY_OT_NO = ESSAFFIRMINFO.APPLY_NO
	           AND APPLY.CREATE_DATE > to_date(to_char(decode(to_char(sysdate, 'day'),
	                                '星期六',
	                                 to_date('2999-12-31','YYYY-MM-DD'),
	                                '星期日',
	                                 to_date('2999-12-31','YYYY-MM-DD'),
	                                 '星期一',
	                                sysdate - 3,
	                                sysdate - 1),
	                         'yyyy-mm-dd'),
	                 'yyyy-mm-dd')
	           AND APPLY.CREATE_DATE < to_date(to_char(sysdate,'yyyy-mm-dd'),'yyyy-mm-dd')     
	           AND(select COUNT(*) from ESS_REGULARLY_OT_RECORD t WHERE T.CPNY_ID = '61000000' AND t.ot_date = TO_CHAR (SYSDATE,'YYYY-MM-DD'))=0   
				
		]]>
	</select>
	
	
	
	<select id="regularly780SentOtInfoList" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[		
		
		  SELECT APPLY.APPLY_OT_NO,
	             HR.EMPID APPLYOREMPID,
	             HR.CHINESENAME APPLYORNAME,
	             hr_get_level_deptname(HR.DEPTID, 4)||'  '||get_dept_name(HR.DEPTID) DEPTFULLNAME,
	             APPLY.CREATE_DATE,
	             TO_CHAR(APPLY.APPLY_OT_DATE - OT_NIGHT_FLAG, 'YYYY-MM-DD') AS otDate,
	             TO_CHAR(APPLY.APPLY_OT_DATE, 'YYYY-MM-DD ') ||
	             APPLY.OT_FROM_TIME AS otFromTime,
	             TO_CHAR(APPLY.APPLY_OT_DATE + APPLY.APPLY_OT_FLAG,
	                  'YYYY-MM-DD ') || APPLY.OT_TO_TIME AS otToTime,
	              CASE
	            WHEN OT_LENGTH > 0 THEN
	             OT_LENGTH
	            ELSE
	             (TO_DATE(TO_CHAR(APPLY.APPLY_OT_DATE +
	                              APPLY.APPLY_OT_FLAG,
	                              'YYYY-MM-DD ') || APPLY.OT_TO_TIME,
	                      'YYYY-MM-DD HH24:MI') -
	             TO_DATE(TO_CHAR(APPLY.APPLY_OT_DATE, 'YYYY-MM-DD ') ||
	                      APPLY.OT_FROM_TIME,
	                      'YYYY-MM-DD HH24:MI')) * 24 - APPLY.OT_DEDUCT_TIME
	          END AS otLength,     
	             SY.CODE_NAME APPLY_TYPE,
	             
	             ESSAFFIRMINFO.CHINESENAME AFFIMORNAME,
	             ESSAFFIRMINFO.EMPID AFFIMOREMPID,
	             ESSAFFIRMINFO.AFFIRM_LEVEL,
	             ESSAFFIRMINFO.PERSON_ID AFFIMORPERSONID
             
	           FROM ESS_APPLY_OT APPLY,
	             HR_EMPLOYEE HR,
	             SY_CODE SY,
	             (SELECT AFFIRMINFO.APPLY_NO,
	                     AFFIRMINFO.CHINESENAME,
	                     AFFIRMINFO.EMPID,
	                     AFFIRMINFO.PERSON_ID,
	                     AFFIRMINFO.AFFIRM_LEVEL
	                FROM (SELECT AFFIRM.APPLY_NO,
	                             HH.CHINESENAME,
	                             HH.EMPID,
	                             HH.PERSON_ID,
	                             AFFIRM.AFFIRM_LEVEL
	                        FROM ESS_AFFIRM AFFIRM, HR_EMPLOYEE HH
	                       WHERE AFFIRM.AFFIRMOR_ID = HH.PERSON_ID
                           AND AFFIRM.APPLY_TYPE = 'OtApply'
                           AND AFFIRM.AFFIRM_FLAG = 0
                           AND HH.CPNY_ID = '78000000') AFFIRMINFO,
                       (SELECT AFFIRM.APPLY_NO, MAX(AFFIRM.AFFIRM_LEVEL) AFFIRM_LEVEL
                          FROM ESS_AFFIRM AFFIRM, HR_EMPLOYEE HH
                         WHERE AFFIRM.AFFIRMOR_ID = HH.PERSON_ID
                           AND AFFIRM.APPLY_TYPE = 'OtApply'
                           AND AFFIRM.AFFIRM_FLAG = 0
                           AND HH.CPNY_ID = '78000000'
                         GROUP BY AFFIRM.APPLY_NO
                        
                        ) MAXAFFIRMLEVEL
                 WHERE AFFIRMINFO.APPLY_NO = MAXAFFIRMLEVEL.APPLY_NO
                   AND AFFIRMINFO.AFFIRM_LEVEL = MAXAFFIRMLEVEL.AFFIRM_LEVEL               
                ) ESSAFFIRMINFO
         WHERE APPLY.EMPID = HR.PERSON_ID
  
           AND APPLY.Apply_Ot_Type_Code = SY.CODE_ID
           AND APPLY.ACTIVITY = 0
           AND HR.CPNY_ID = '78000000'
           AND hr_get_level_deptid(HR.DEPTID, 4) IN ('780G1000','780G9000')
           AND APPLY.APPLY_OT_NO = ESSAFFIRMINFO.APPLY_NO
           AND APPLY.CREATE_DATE > to_date(to_char(decode(to_char(sysdate, 'day'),
                                '星期六',
                                 to_date('2999-12-31','YYYY-MM-DD'),
                                '星期日',
                                 to_date('2999-12-31','YYYY-MM-DD'),
                                 '星期一',
                                sysdate - 3,
                                sysdate - 1),
                         'yyyy-mm-dd'),
                 'yyyy-mm-dd')
          AND APPLY.CREATE_DATE < to_date(to_char(sysdate,'yyyy-mm-dd'),'yyyy-mm-dd')
          AND(select COUNT(*) from ESS_REGULARLY_OT_RECORD t where T.CPNY_ID = '78000000' AND t.ot_date = TO_CHAR (SYSDATE,'YYYY-MM-DD'))=0

        ]]>  
        <isNotEmpty prepend="AND" property="AFFIMORPERSONID">
			<![CDATA[
			          ESSAFFIRMINFO.PERSON_ID = #AFFIMORPERSONID:VARCHAR#
				]]>
		</isNotEmpty>   
		<![CDATA[	
		 ORDER BY HR.DEPTID
		]]>  		
	</select>
	
	
	<select id="regularly610SentOtInfoList" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[		
		
		  SELECT APPLY.APPLY_OT_NO,
	             HR.EMPID APPLYOREMPID,
	             HR.CHINESENAME APPLYORNAME,
	             hr_get_level_deptname(HR.DEPTID, 4)||'  '||get_dept_name(HR.DEPTID) DEPTFULLNAME,
	             APPLY.CREATE_DATE,
	             TO_CHAR(APPLY.APPLY_OT_DATE - OT_NIGHT_FLAG, 'YYYY-MM-DD') AS otDate,
	             TO_CHAR(APPLY.APPLY_OT_DATE, 'YYYY-MM-DD ') ||
	             APPLY.OT_FROM_TIME AS otFromTime,
	             TO_CHAR(APPLY.APPLY_OT_DATE + APPLY.APPLY_OT_FLAG,
	                  'YYYY-MM-DD ') || APPLY.OT_TO_TIME AS otToTime,
	              CASE
	            WHEN OT_LENGTH > 0 THEN
	             OT_LENGTH
	            ELSE
	             (TO_DATE(TO_CHAR(APPLY.APPLY_OT_DATE +
	                              APPLY.APPLY_OT_FLAG,
	                              'YYYY-MM-DD ') || APPLY.OT_TO_TIME,
	                      'YYYY-MM-DD HH24:MI') -
	             TO_DATE(TO_CHAR(APPLY.APPLY_OT_DATE, 'YYYY-MM-DD ') ||
	                      APPLY.OT_FROM_TIME,
	                      'YYYY-MM-DD HH24:MI')) * 24 - APPLY.OT_DEDUCT_TIME
	          END AS otLength,     
	             SY.CODE_NAME APPLY_TYPE,
	             
	             ESSAFFIRMINFO.CHINESENAME AFFIMORNAME,
	             ESSAFFIRMINFO.EMPID AFFIMOREMPID,
	             ESSAFFIRMINFO.AFFIRM_LEVEL,
	             ESSAFFIRMINFO.PERSON_ID AFFIMORPERSONID
             
	           FROM ESS_APPLY_OT APPLY,
	             HR_EMPLOYEE HR,
	             SY_CODE SY,
	             (SELECT AFFIRMINFO.APPLY_NO,
	                     AFFIRMINFO.CHINESENAME,
	                     AFFIRMINFO.EMPID,
	                     AFFIRMINFO.PERSON_ID,
	                     AFFIRMINFO.AFFIRM_LEVEL
	                FROM (SELECT AFFIRM.APPLY_NO,
	                             HH.CHINESENAME,
	                             HH.EMPID,
	                             HH.PERSON_ID,
	                             AFFIRM.AFFIRM_LEVEL
	                        FROM ESS_AFFIRM AFFIRM, HR_EMPLOYEE HH
	                       WHERE AFFIRM.AFFIRMOR_ID = HH.PERSON_ID
                           AND AFFIRM.APPLY_TYPE = 'OtApply'
                           AND AFFIRM.AFFIRM_FLAG = 0
                           AND HH.CPNY_ID = '61000000') AFFIRMINFO,
                       (SELECT AFFIRM.APPLY_NO, MAX(AFFIRM.AFFIRM_LEVEL) AFFIRM_LEVEL
                          FROM ESS_AFFIRM AFFIRM, HR_EMPLOYEE HH
                         WHERE AFFIRM.AFFIRMOR_ID = HH.PERSON_ID
                           AND AFFIRM.APPLY_TYPE = 'OtApply'
                           AND AFFIRM.AFFIRM_FLAG = 0
                           AND HH.CPNY_ID = '61000000'
                         GROUP BY AFFIRM.APPLY_NO
                        
                        ) MAXAFFIRMLEVEL
                 WHERE AFFIRMINFO.APPLY_NO = MAXAFFIRMLEVEL.APPLY_NO
                   AND AFFIRMINFO.AFFIRM_LEVEL = MAXAFFIRMLEVEL.AFFIRM_LEVEL               
                ) ESSAFFIRMINFO
         WHERE APPLY.EMPID = HR.PERSON_ID
  
           AND APPLY.Apply_Ot_Type_Code = SY.CODE_ID
           AND APPLY.ACTIVITY = 0
           AND HR.CPNY_ID = '61000000'
           AND hr_get_level_deptid(HR.DEPTID, 4) IN ('610T3700','610C5000','610C6000','610G6000','610G5000')
           AND APPLY.APPLY_OT_NO = ESSAFFIRMINFO.APPLY_NO
           AND APPLY.CREATE_DATE > to_date(to_char(decode(to_char(sysdate, 'day'),
                                '星期六',
                                 to_date('2999-12-31','YYYY-MM-DD'),
                                '星期日',
                                 to_date('2999-12-31','YYYY-MM-DD'),
                                 '星期一',
                                sysdate - 3,
                                sysdate - 1),
                         'yyyy-mm-dd'),
                 'yyyy-mm-dd')
          AND APPLY.CREATE_DATE < to_date(to_char(sysdate,'yyyy-mm-dd'),'yyyy-mm-dd') 
          AND(select COUNT(*) from ESS_REGULARLY_OT_RECORD t where T.CPNY_ID = '61000000' AND t.ot_date = TO_CHAR (SYSDATE,'YYYY-MM-DD'))=0

        ]]>  
        <isNotEmpty prepend="AND" property="AFFIMORPERSONID">
			<![CDATA[
			          ESSAFFIRMINFO.PERSON_ID = #AFFIMORPERSONID:VARCHAR#
				]]>
		</isNotEmpty>   
		<![CDATA[	
		 ORDER BY HR.DEPTID
		]]>  		
	</select>
	
	
	
	<insert id="insertRegularlySentOtInfoRecords" parameterClass="SimpleMap" >
     <![CDATA[
			 INSERT INTO ESS_REGULARLY_OT_RECORD
					  (ID,
					   OT_DATE,
					   SEND_MAIL_TIME,
					   CPNY_ID)
					  (SELECT ESS_REGULARLY_OT_SEQ.NEXTVAL,
					          TO_CHAR(SYSDATE,'YYYY-MM-DD'),
					          SYSDATE,
					          #cpnyId:VARCHAR#
					     FROM DUAL
					   )
	  ]]>
	</insert>	
	
	<select id="regularlySentArModifyEmpidInfoList" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[		
		SELECT  DISTINCT ESSAFFIRMINFO.PERSON_ID AFFIMORPERSONID,
                ESSAFFIRMINFO.CHINESENAME AFFIMORNAME,
                ESSAFFIRMINFO.EMAIL AFFIMOREMAIL
             FROM AR_DETAIL APPLY,
               HR_EMPLOYEE HR,
               (SELECT AFFIRMINFO.APPLY_NO,
                       AFFIRMINFO.CHINESENAME,
                       AFFIRMINFO.EMPID,
                       AFFIRMINFO.PERSON_ID,
                       AFFIRMINFO.EMAIL,
                       AFFIRMINFO.AFFIRM_LEVEL
                  FROM (SELECT AFFIRM.AR_DETAIL_NO APPLY_NO,
                               HH.CHINESENAME,
                               HH.EMPID,
                               HH.PERSON_ID,
                               HH.EMAIL,
                               AFFIRM.AFFIRM_LEVEL
                          FROM AR_DETAIL_AFFIRM AFFIRM, HR_EMPLOYEE HH
                         WHERE AFFIRM.AFFIRMOR_ID = HH.PERSON_ID
                           AND AFFIRM.AFFIRM_FLAG = 0
                           AND HH.CPNY_ID = '78000000') AFFIRMINFO,
                       (SELECT AFFIRM.AR_DETAIL_NO APPLY_NO, MIN(AFFIRM.AFFIRM_LEVEL) AFFIRM_LEVEL
                          FROM AR_DETAIL_AFFIRM AFFIRM, HR_EMPLOYEE HH
                         WHERE AFFIRM.AFFIRMOR_ID = HH.PERSON_ID
                           AND AFFIRM.AFFIRM_FLAG = 0
                           AND HH.CPNY_ID = '78000000'
                         GROUP BY AFFIRM.AR_DETAIL_NO
                        
                        ) MINAFFIRMLEVEL
                 WHERE AFFIRMINFO.APPLY_NO = MINAFFIRMLEVEL.APPLY_NO
                   AND AFFIRMINFO.AFFIRM_LEVEL = MINAFFIRMLEVEL.AFFIRM_LEVEL               
                ) ESSAFFIRMINFO
         WHERE APPLY.EMPID = HR.PERSON_ID
           AND APPLY.FLAG = 0
           AND HR.CPNY_ID = '78000000'
           AND APPLY.PK_NO = ESSAFFIRMINFO.APPLY_NO
           AND TO_CHAR(APPLY.MOD_DATE,'yyyy-mm-dd') = to_char(SYSDATE-1,'yyyy-mm-dd')
           AND(select COUNT(*) from AR_MODIFY_MAIL_RECORD t where t.type = 'ArModify' and t.ot_date = TO_CHAR (SYSDATE,'YYYY-MM-DD'))=0
    
		]]>
	</select>
	
	<select id="regularlySentArModifyInfoList" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[		
		SELECT AR_DETAIL_BACK.AR_PK_NO AS pkNo1,
		       h.empid,
		       H.CHINESENAME AS CHINESENAME,
		       GET_DEPT_NAME(H.DEPTID) DEPTNAME,
		       NVL(AR_DETAIL_AFFIRM.UP_AFFIRM_FLAG, 1) AS up_flag,
		       NVL(AR_DETAIL_AFFIRM.NEXT_AFFIRM_FLAG, 0) AS next_flag,
		       NVL(AR_DETAIL_AFFIRM.MAX_LEVEL_FLAG, 0) AS maxLevel_flag,
		       MAX_AFFIRMOR_FLAG.AFFIRM_FLAG AS max_affirm_flag,
		       AR_DETAIL_BACK.FROM_TIME FROM_TIME1,
		       AR_DETAIL_BACK.TO_TIME TO_TIME1,
		       AR_DETAIL_BACK.AR_DATE_STR AR_DATE_STR1,
		       AR_DETAIL_BACK.AR_MONTH_STR AR_MONTH_STR1,
		       AR_DETAIL_BACK.QUANTITY QUANTITY1,
		       AR_DETAIL_BACK.UNIT UNIT1,
		       AR_DETAIL_BACK.LOCK_YN LOCK_YN1,
		       AR_ITEM1.ITEM_NAME AS ITEMNAME1,
		       SY_CODE.CODE_NAME UNITNAME1,
		       TO_CHAR(AR_DETAIL_BACK.CREATE_DATE, 'YYYY-MM-DD HH:SS') CREATEDATE1
		  FROM AR_DETAIL_BACK,
		       AR_ITEM AR_ITEM1,
		       SY_CODE,
		       HR_EMPLOYEE H,
		       (SELECT AR_DETAIL_AFFIRM.*,
		               UP_AFFIRM.AFFIRM_FLAG AS UP_AFFIRM_FLAG,
		               UP_AFFIRM.AFFIRMOR_ID AS UP_AFFIRMOR_ID,
		               NEXT_AFFIRM.AFFIRM_FLAG AS NEXT_AFFIRM_FLAG,
		               (CASE
		                 WHEN AR_DETAIL_AFFIRM.AFFIRM_LEVEL =
		                      ESS_AFFIRM_MAX_LEVEL.MAXLEVEL THEN
		                  1
		                 ELSE
		                  0
		               END) MAX_LEVEL_FLAG
		          FROM (SELECT AR_DETAIL_AFFIRM.*,
		                       AR_DETAIL_AFFIRM.AFFIRM_LEVEL - 1 AS UP_LEVEL,
		                       AR_DETAIL_AFFIRM.AFFIRM_LEVEL + 1 AS NEXT_LEVEL
		                  FROM AR_DETAIL_AFFIRM) AR_DETAIL_AFFIRM,
		               (SELECT T.AR_DETAIL_NO, MAX(T.AFFIRM_LEVEL) MAXLEVEL
		                  FROM AR_DETAIL_AFFIRM T
		                 GROUP BY T.AR_DETAIL_NO) ESS_AFFIRM_MAX_LEVEL,
		               (SELECT T.AR_DETAIL_NO,
		                       T.AFFIRM_LEVEL,
		                       T.AFFIRMOR_ID,
		                       T.AFFIRM_FLAG
		                  FROM AR_DETAIL_AFFIRM T) UP_AFFIRM,
		               (SELECT A.AR_DETAIL_NO, MAX(A.AFFIRM_FLAG) AS AFFIRM_FLAG
		                  FROM AR_DETAIL_AFFIRM A,
		                       (SELECT T.AR_DETAIL_NO, T.AFFIRMOR_ID, T.AFFIRM_LEVEL
		                          FROM AR_DETAIL_AFFIRM T
		                         WHERE T.AFFIRMOR_ID = #AFFIMORPERSONID:VARCHAR#) B
		                 WHERE A.AR_DETAIL_NO = B.AR_DETAIL_NO
		                   AND A.AFFIRM_LEVEL > B.AFFIRM_LEVEL
		                 GROUP BY A.AR_DETAIL_NO) NEXT_AFFIRM
		         WHERE AR_DETAIL_AFFIRM.AR_DETAIL_NO = UP_AFFIRM.AR_DETAIL_NO(+)
		           AND AR_DETAIL_AFFIRM.UP_LEVEL = UP_AFFIRM.AFFIRM_LEVEL(+)
		           AND AR_DETAIL_AFFIRM.AR_DETAIL_NO = NEXT_AFFIRM.AR_DETAIL_NO(+)
		           AND AR_DETAIL_AFFIRM.AR_DETAIL_NO =
		               ESS_AFFIRM_MAX_LEVEL.AR_DETAIL_NO(+)) AR_DETAIL_AFFIRM,
		       (SELECT AR_DETAIL_AFFIRM.AFFIRM_FLAG, AR_DETAIL_AFFIRM.AR_DETAIL_NO
		          FROM AR_DETAIL_AFFIRM,
		               (SELECT MAX(AR_DETAIL_AFFIRM.AFFIRM_LEVEL),
		                       MAX(AR_DETAIL_AFFIRM.AR_DETAIL_AFFIRM_NO) AR_DETAIL_AFFIRM_NO
		                  FROM AR_DETAIL_AFFIRM
		                 GROUP BY AR_DETAIL_AFFIRM.AR_DETAIL_NO) HH
		         WHERE AR_DETAIL_AFFIRM.AR_DETAIL_AFFIRM_NO = HH.AR_DETAIL_AFFIRM_NO) MAX_AFFIRMOR_FLAG
		 WHERE AR_DETAIL_BACK.OPERATION = 'UPDATE'
		   AND AR_DETAIL_BACK.AR_ITEM_NO = AR_ITEM1.ITEM_NO(+)
		   AND AR_DETAIL_BACK.AR_PK_NO = MAX_AFFIRMOR_FLAG.AR_DETAIL_NO(+)
		   AND AR_DETAIL_BACK.EMPID = H.person_id
		   AND AR_DETAIL_BACK.AR_PK_NO = AR_DETAIL_AFFIRM.AR_DETAIL_NO
		   AND NVL(AR_DETAIL_AFFIRM.UP_AFFIRM_FLAG, 1) = 1
		   AND AR_DETAIL_AFFIRM.AFFIRMOR_ID = #AFFIMORPERSONID:VARCHAR#
		   AND AR_DETAIL_BACK.UNIT = SY_CODE.CODE_ID(+)
		   AND AR_DETAIL_AFFIRM.affirm_flag = 0
		   AND TO_CHAR(AR_DETAIL_BACK.Create_Date, 'yyyy-mm-dd') =
		       to_char(SYSDATE - 1, 'yyyy-mm-dd')
		 ORDER BY AR_DETAIL_AFFIRM.AFFIRM_FLAG,
		          AR_DETAIL_BACK.AR_DATE_STR,
		          AR_DETAIL_BACK.EMPID	          
		
        ]]>  
        
	</select>
	
	<insert id="insertRegularlySentArModifyInfoRecords" parameterClass="SimpleMap" >
     <![CDATA[
			 INSERT INTO AR_MODIFY_MAIL_RECORD
					  (ID,
					   OT_DATE,
					   SEND_MAIL_TIME,
					   TYPE)
					  (SELECT AR_MODIFY_MAIL_RECORD_SEQ.NEXTVAL,
					          TO_CHAR(SYSDATE,'YYYY-MM-DD'),
					          SYSDATE,
					          'ArModify'
					     FROM DUAL
					   )
	  ]]>
	</insert>	
	
	
	<select id="regularlySentArAbnormalEmpidInfoList" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[		
			SELECT DISTINCT ARAFFIRMINFO.PERSON_ID   AFFIMORPERSONID,
	                ARAFFIRMINFO.CHINESENAME AFFIMORNAME,
	                ARAFFIRMINFO.EMAIL       AFFIMOREMAIL
			  FROM AR_DETAIL AR,
			       HR_EMPLOYEE HR,
			       (SELECT AFFIRMINFO.AFFIRM_OBJECT,
			               AFFIRMINFO.AFFIRMOR_ID,
			               AFFIRMINFO.AFFIRM_LEVEL,
			               AFFIRMINFO.CHINESENAME,
			               AFFIRMINFO.EMPID,
			               AFFIRMINFO.PERSON_ID,
			               AFFIRMINFO.EMAIL
			          FROM (select S.AFFIRM_OBJECT, MAX(S.AFFIRM_LEVEL) AFFIRM_LEVEL
			                  from SY_AFFIRM_RELATION_TB S
			                 WHERE S.AFFIRM_TYPE_ID = 'ArModifyApply'
			                 group by S.AFFIRM_OBJECT) MAXAFFIRMLEVEL,
			               (select SA.AFFIRM_OBJECT,
			                       SA.AFFIRMOR_ID,
			                       SA.AFFIRM_LEVEL,
			                       HH.CHINESENAME,
			                       HH.EMPID,
			                       HH.PERSON_ID,
			                       HH.EMAIL
			                  from SY_AFFIRM_RELATION_TB SA, HR_EMPLOYEE HH
			                 WHERE SA.AFFIRM_TYPE_ID = 'ArModifyApply'
			                   AND SA.AFFIRMOR_ID = HH.PERSON_ID) AFFIRMINFO
			         WHERE AFFIRMINFO.AFFIRM_OBJECT = MAXAFFIRMLEVEL.AFFIRM_OBJECT
			           AND AFFIRMINFO.AFFIRM_LEVEL = MAXAFFIRMLEVEL.AFFIRM_LEVEL) ARAFFIRMINFO
			 WHERE AR.EMPID = HR.PERSON_ID
			   AND HR.DEPTID = ARAFFIRMINFO.AFFIRM_OBJECT
			   AND HR.CPNY_ID = '78000000'
			   AND AR.AR_ITEM_NO IN ('1', '2', '4', '25')
               AND(select COUNT(*) from AR_MODIFY_MAIL_RECORD t where t.type = 'ArAbnormal' and t.ot_date = TO_CHAR (SYSDATE,'YYYY-MM-DD'))=0
               AND AR.AR_DATE_STR > = to_char(decode(to_char(sysdate, 'day'),
                                '星期六',
                                 to_date('2999-12-31','yyyy/mm/dd'),
                                '星期日',
                                 to_date('2999-12-31','yyyy/mm/dd'),
                                 '星期一',
                                sysdate - 3,
                                sysdate - 1),
                         'yyyy/mm/dd') 
               AND AR.AR_DATE_STR < to_char(sysdate,'yyyy/mm/dd')
		]]>
	</select>
	
	
	<select id="regularlySentArAbnormalInfoList" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[		
		SELECT  HR.EMPID,HR.CHINESENAME,
				GET_DEPT_NAME(HR.DEPTID) DEPTNAME,
				AR.AR_DATE_STR,
				AI.ITEM_NAME,
				AR.QUANTITY,
				SC.CODE_NAME UNIT
		  FROM AR_DETAIL AR,
		       AR_ITEM AI,
		       HR_EMPLOYEE HR,
		       SY_CODE SC,
		       (SELECT AFFIRMINFO.AFFIRM_OBJECT,
		               AFFIRMINFO.AFFIRMOR_ID,
		               AFFIRMINFO.AFFIRM_LEVEL,
		               AFFIRMINFO.CHINESENAME,
		               AFFIRMINFO.EMPID,
		               AFFIRMINFO.PERSON_ID,
		               AFFIRMINFO.EMAIL
		          FROM (select S.AFFIRM_OBJECT, MAX(S.AFFIRM_LEVEL) AFFIRM_LEVEL
		                  from SY_AFFIRM_RELATION_TB S
		                 WHERE S.AFFIRM_TYPE_ID = 'ArModifyApply'
		                 group by S.AFFIRM_OBJECT) MAXAFFIRMLEVEL,
		               (select SA.AFFIRM_OBJECT,
		                       SA.AFFIRMOR_ID,
		                       SA.AFFIRM_LEVEL,
		                       HH.CHINESENAME,
		                       HH.EMPID,
		                       HH.PERSON_ID,
		                       HH.EMAIL
		                  from SY_AFFIRM_RELATION_TB SA, HR_EMPLOYEE HH
		                 WHERE SA.AFFIRM_TYPE_ID = 'ArModifyApply'
		                   AND SA.AFFIRMOR_ID = HH.PERSON_ID) AFFIRMINFO
		         WHERE AFFIRMINFO.AFFIRM_OBJECT = MAXAFFIRMLEVEL.AFFIRM_OBJECT
		           AND AFFIRMINFO.AFFIRM_LEVEL = MAXAFFIRMLEVEL.AFFIRM_LEVEL) ARAFFIRMINFO
		 WHERE AR.EMPID = HR.PERSON_ID
		   AND HR.DEPTID = ARAFFIRMINFO.AFFIRM_OBJECT
		   AND AR.AR_ITEM_NO = AI.ITEM_NO
		   AND AR.UNIT = SC.CODE_ID
		   AND HR.CPNY_ID = '78000000'
		   AND AR.AR_ITEM_NO IN ('1', '2', '4', '25')
		   AND ARAFFIRMINFO.PERSON_ID = #AFFIMORPERSONID:VARCHAR#
		   AND AR.AR_DATE_STR > = to_char(decode(to_char(sysdate, 'day'),
                                '星期六',
                                 to_date('2999-12-31','yyyy/mm/dd'),
                                '星期日',
                                 to_date('2999-12-31','yyyy/mm/dd'),
                                 '星期一',
                                sysdate - 3,
                                sysdate - 1),
                         'yyyy/mm/dd')           
           AND AR.AR_DATE_STR < to_char(sysdate,'yyyy/mm/dd')
          
		
        ]]>  
        
	</select>
	
	<insert id="insertRegularlySentArAbnormalInfoRecords" parameterClass="SimpleMap" >
     <![CDATA[
			 INSERT INTO AR_MODIFY_MAIL_RECORD
					  (ID,
					   OT_DATE,
					   SEND_MAIL_TIME,
					   TYPE)
					  (SELECT AR_MODIFY_MAIL_RECORD_SEQ.NEXTVAL,
					          TO_CHAR(SYSDATE,'YYYY-MM-DD'),
					          SYSDATE,
					          'ArAbnormal'
					     FROM DUAL
					   )
	  ]]>
	</insert>	
	
</sqlMap>