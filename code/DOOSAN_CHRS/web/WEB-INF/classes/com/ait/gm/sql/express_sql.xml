<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="gm.express">
 <select id="expressConfirmInfoListNumber" resultClass="int">
		<![CDATA[			
		select count(*) as s from ( select distinct  * from 
		ga_express_apply t,
		hr_employee hr		
		where  hr.PERSON_ID(+)=t.sendperson
		  and t.active='1'
		  AND EXISTS (SELECT SAD.ADMIN_DEPTID
              FROM SY_ADMIN_DEPTID SAD, SY_ADMIN SA
             WHERE SAD.ADMIN_NO = SA.ADMINNO
  	           AND SA.ADMINID = #adminid:VARCHAR#
         AND SAD.ADMIN_DEPTID = hr.deptid)
		]]>
		<isNotEmpty prepend="AND" property="postNumber">
			<![CDATA[
		 		(t.postnumber like '%' || #postNumber:VARCHAR# || '%')
			]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="deptID">
			<![CDATA[
		 		(t.deptid = #deptID:VARCHAR#)
			]]>
	    </isNotEmpty>
	    
	    <isNotEmpty prepend="AND" property="cpnyId">
		<![CDATA[		   
		 (hr.cpny_id=#cpnyId:VARCHAR#)
		]]>	
	</isNotEmpty>
	    
	<isNotEmpty prepend="AND" property="startDate">
		<![CDATA[		   
		 to_date(to_char(T.applydate,'YYYY-MM-DD'),'YYYY-MM-DD') >= TO_DATE(#startDate:VARCHAR#,'YYYY-MM-DD')
		]]>	
	</isNotEmpty>
	<isNotEmpty prepend="AND" property="endDate">
		<![CDATA[		   
		 to_date(to_char(T.applydate,'YYYY-MM-DD'),'YYYY-MM-DD') <= TO_DATE(#endDate:VARCHAR#,'YYYY-MM-DD')
		]]>	
	</isNotEmpty>	
	       <isEqual prepend="AND" property="qryType" compareValue="0"> <!-- 未确认过的 -->
		<![CDATA[
				 t.ISCONFIRM=0
	]]>
	</isEqual>
	<isEqual prepend="AND" property="qryType" compareValue="1"> <!-- 确认通过的 -->
		<![CDATA[
				 t.ISCONFIRM =1
	]]>
	</isEqual>
	    <isNotEmpty prepend="AND" property="sendPerson">
			<![CDATA[
		 		(t.sendperson like '%'||#sendPerson:VARCHAR#||'%' or hr.chinesename like '%'||#sendPerson:VARCHAR#||'%' or hr.empid like '%'||#sendPerson:VARCHAR#||'%')
			]]>
		</isNotEmpty>
		<![CDATA[
		) temp

		]]>
</select>

 <select id="expressConfirmInfoList" resultClass="SimpleMap">
		<![CDATA[			
		select distinct
				T.APPLY_NO,
				   T.APPLYOR_ID,
				   T.SENDPERSON,
				   T.DEPTID,
				   T.CITYSENDTO,
				   T.POSTADDRESS,
				   T.EXPRESSTYPE,
				   T.APPLYDATE,
				   T.ISSEND,
				   T.POSTNUMBER,
				   T.SENDTOPERSON,
				   T.ISCONFIRM,
				   T.SENTDATE,
				   T.CONFIRMDATE,
				   T.NOTE,
				   T.ACTIVE,
				   T.POSTDESCRIPTION,
				   T.CONFIRORANDSENDOR,
				   T.COSTS,
				   T.CITYARRIVE,
				   T.CAUSE,
				   T.CONFIRMIDEA,
				   T.ISOVER_KG,
				   T.CITYSENDTO_S,
				   T.CITYSENDTO_Q,
				   T.CITYSENDTO_D,
				   T.CITYARRIVE_S,
				   T.CITYARRIVE_Q,
				   T.CITYARRIVE_D,
				   T.MOBILE_S,
				   T.MOBILE_A,
				   T.POST_CODE_S,
				   T.POST_CODE_A,
				   GET_CODE_NAME(T.EXP_TYPE) EXP_TYPE,
				   TO_CHAR(T.APPLYDATE ,'YYYY-MM-DD HH24:MI') APPLY_DATE,
			   v.deptname,hr.chinesename AS SENDPERSONNAME,
			   code.code_name, 
		       APPLYEMP.CHINESENAME AS APPLYEMPNAME,
		       APPLYEMP.EMAIL AS APPLYEMPEMAIL,
		       hr.empid as empid1,
       		   APPLYEMP.empid as empid2
	      from 
				ga_express_apply t,
				ga_express_affirm a,
				hr_department v,
				hr_employee       hr1,
				hr_employee hr,
				HR_EMPLOYEE       APPLYEMP,
				sy_code code
		  where t.apply_no=a.apply_no
		    AND T.APPLYOR_ID = APPLYEMP.person_id(+)
			and t.active='1'
			and v.deptid(+)=t.deptid
			and hr.person_id(+)=t.sendperson
			and code.code_id(+)=t.expresstype
			 and t.APPLYOR_ID = hr1.person_id
			AND EXISTS (SELECT SAD.ADMIN_DEPTID
          FROM SY_ADMIN_DEPTID SAD, SY_ADMIN SA
         WHERE SAD.ADMIN_NO = SA.ADMINNO
           AND SA.ADMINID = #adminid:VARCHAR#
           AND SAD.ADMIN_DEPTID = hr1.deptid)
		]]>
		<isNotEmpty prepend="AND" property="startDate">
		<![CDATA[		   
		 to_date(to_char(T.applydate,'YYYY-MM-DD'),'YYYY-MM-DD') >= TO_DATE(#startDate:VARCHAR#,'YYYY-MM-DD')
		]]>	
	</isNotEmpty>
	<isNotEmpty prepend="AND" property="endDate">
		<![CDATA[		   
		 to_date(to_char(T.applydate,'YYYY-MM-DD'),'YYYY-MM-DD') <= TO_DATE(#endDate:VARCHAR#,'YYYY-MM-DD')
		]]>	
	</isNotEmpty>	
	 <isEqual prepend="AND" property="qryType" compareValue="0"> <!-- 未确认过的 -->
		<![CDATA[
				 t.ISCONFIRM=0
	]]>
	</isEqual>
	<isEqual prepend="AND" property="qryType" compareValue="1"> <!-- 确认通过的 -->
		<![CDATA[
				 t.ISCONFIRM =1
	]]>
	</isEqual>
		<isNotEmpty prepend="AND" property="postNumber">
			<![CDATA[
		 		(t.postnumber like '%' || #postNumber:VARCHAR# || '%')
			]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="deptID">
			<![CDATA[
		 		(t.deptid = #deptID:VARCHAR#)
			]]>
	    </isNotEmpty>

<isNotEmpty prepend="AND" property="cpnyId">
		<![CDATA[		   
		 (hr.cpny_id=#cpnyId:VARCHAR#)
		]]>	
	</isNotEmpty>
	    
	    <isNotEmpty prepend="AND" property="sendPerson">
			<![CDATA[
		 		(t.sendperson like '%'||#sendPerson:VARCHAR#||'%' or hr.chinesename like '%'||#sendPerson:VARCHAR#||'%'  or hr.empid like '%'||#sendPerson:VARCHAR#||'%')
			]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="applyno">
			<![CDATA[
		 		T.APPLY_NO = #applyno:NUMERIC#
			]]>
	    </isNotEmpty>
		<![CDATA[	
	    order by t.applydate desc
		]]>
</select>

<update id="oingConfirm" parameterClass="SimpleMap">
<![CDATA[
  update ga_express_apply t
  set t.isconfirm=#flag:NUMERIC#,
  t.confirorandsendor=#applerId:VARCHAR#,
  t.confirmdate=SYSDATE,
  t.CONFIRMIDEA=#affirmorIdea:varchar#
  where t.apply_no=#applynoAr:NUMERIC# 
	
	]]>		
</update>

<select id="expressSendListNumber" resultClass="int">
		<![CDATA[			
		select count(*) as s from ( select distinct  * from 
		ga_express_apply t,
		ga_express_affirm a,
		hr_employee hr	,hr_employee hr1		
		where t.apply_no=a.apply_no
		and hr.person_id(+)=t.sendperson
		and t.active='1'
		and t.isconfirm='1'
		and a.affirm_flag='1' 
		and t.issend='0'
		and hr1.person_id = t.applyor_id
		AND EXISTS (SELECT SAD.ADMIN_DEPTID
              FROM SY_ADMIN_DEPTID SAD, SY_ADMIN SA
             WHERE SAD.ADMIN_NO = SA.ADMINNO
  	           AND SA.ADMINID = #applerId:VARCHAR#
         AND SAD.ADMIN_DEPTID = hr1.deptid)
		]]>
		
		<isNotEmpty prepend="AND" property="postNumber">
			<![CDATA[
		 		(t.postnumber like '%' || #postNumber:VARCHAR# || '%')
			]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="deptID">
			<![CDATA[
		 		(t.deptid = #deptID:VARCHAR#)
			]]>
	    </isNotEmpty>
	    
	     <isNotEmpty prepend="AND" property="cpnyId">
		<![CDATA[		   
		 (hr.cpny_id=#cpnyId:VARCHAR#)
		]]>	
	</isNotEmpty>	
	    
	    <isNotEmpty prepend="AND" property="sendPerson">
			<![CDATA[
		 		(t.sendperson like '%'||#sendPerson:VARCHAR#||'%' or hr.chinesename like '%'||#sendPerson:VARCHAR#||'%' or hr.EMPID like '%'||#sendPerson:VARCHAR#||'%')
			]]>
		</isNotEmpty>
			
		<![CDATA[
		) temp

		]]>
</select>

<select id="expressSendList" resultClass="SimpleMap">
		<![CDATA[			
		select distinct  T.APPLY_NO,
				   T.APPLYOR_ID,
				   T.SENDPERSON,
				   T.DEPTID,
				   T.CITYSENDTO,
				   T.POSTADDRESS,
				   T.EXPRESSTYPE,
				   T.APPLYDATE,
				   T.ISSEND,
				   T.POSTNUMBER,
				   T.SENDTOPERSON,
				   T.ISCONFIRM,
				   T.SENTDATE,
				   T.CONFIRMDATE,
				   T.NOTE,
				   T.ACTIVE,
				   T.POSTDESCRIPTION,
				   T.CONFIRORANDSENDOR,
				   T.COSTS,
				   T.CITYARRIVE,
				   T.CAUSE,
				   T.CONFIRMIDEA,
				   T.ISOVER_KG,
				   T.CITYSENDTO_S,
				   T.CITYSENDTO_Q,
				   T.CITYSENDTO_D,
				   T.CITYARRIVE_S,
				   T.CITYARRIVE_Q,
				   T.CITYARRIVE_D,
				   T.MOBILE_S,
				   T.MOBILE_A,
				   T.POST_CODE_S,
				   T.POST_CODE_A,
				   GET_CODE_NAME(T.EXP_TYPE) EXP_TYPE,
				   TO_CHAR(T.APPLYDATE ,'YYYY-MM-DD HH24:MI') APPLY_DATE,
		 v.deptname,hr.chinesename AS SENDPERSONNAME,hr.empid as SENDPERSONEMPID,code.code_name,APPLYEMP.CHINESENAME AS APPLYEMPNAME ,APPLYEMP.empid AS APPLYEMPEMPID
		  from 
			   ga_express_apply t,
			   ga_express_affirm a,
			   hr_department v,
			   hr_employee hr,
			   hr_employee hr1,
			   HR_EMPLOYEE APPLYEMP,
			   sy_code code
		where t.apply_no=a.apply_no
		  AND T.APPLYOR_ID = APPLYEMP.person_id(+)
		  and t.active='1'
		  and t.isconfirm='1'
		  and t.issend='0'
		  and a.affirm_flag='1'
		  and v.deptid(+)=t.deptid
		  and hr1.person_id = t.applyor_id
		  and hr.person_id(+)=t.sendperson
		  and code.code_id(+)=t.expresstype
		  AND EXISTS (SELECT SAD.ADMIN_DEPTID
              FROM SY_ADMIN_DEPTID SAD, SY_ADMIN SA
             WHERE SAD.ADMIN_NO = SA.ADMINNO
  	           AND SA.ADMINID = #applerId:VARCHAR#
         AND SAD.ADMIN_DEPTID = hr1.deptid)
     ]]>
	<isNotEmpty prepend="AND" property="postNumber">
		<![CDATA[
	 		(t.postnumber like '%' || #postNumber:VARCHAR# || '%')
		]]>
	</isNotEmpty>
	<isNotEmpty prepend="AND" property="deptID">
		<![CDATA[
	 		(t.deptid = #deptID:VARCHAR#)
		]]>
    </isNotEmpty>
    
     <isNotEmpty prepend="AND" property="cpnyId">
		<![CDATA[		   
		 (hr.cpny_id=#cpnyId:VARCHAR#)
		]]>	
	</isNotEmpty>	
    
    <isNotEmpty prepend="AND" property="sendPerson">
		<![CDATA[
	 		(t.sendperson like '%'||#sendPerson:VARCHAR#||'%' or hr.chinesename like '%'||#sendPerson:VARCHAR#||'%' or hr.EMPID like '%'||#sendPerson:VARCHAR#||'%')
		]]>
	</isNotEmpty>
	<![CDATA[	
	 order by t.applydate desc
	]]>
</select>

<update id="ingSend" parameterClass="SimpleMap">
<![CDATA[
  update ga_express_apply t
  set t.issend=1,
  t.confirorandsendor=#applerId:VARCHAR#,
  t.sentdate=SYSDATE
  where t.apply_no=#selectApplno:NUMERIC# 
	
	]]>		
</update>

<select id="expressViewList" resultClass="SimpleMap">
		<![CDATA[			
		select distinct  t.* , v.deptname,hr.chinesename ,hr1.chinesename as applyor,code.code_name ,
		to_char(t.sentdate,'yyyy-mm-dd hh24')||'点' as mydate,
		TO_CHAR(T.APPLYDATE,'YYYY-MM-DD') as myapplydate,
		nvl(t.costs,'') as costs from 
		ga_express_apply t,
		ga_express_affirm a,
		hr_department v,
		hr_employee hr,
		hr_employee hr1,
		sy_code code
		where t.apply_no=a.apply_no
		and t.active='1'
		and t.isconfirm='1'
		and t.issend='1'
		and a.affirm_flag='1'
		and v.deptid(+)=t.deptid
		and hr1.person_id(+)=t.APPLYOR_ID
		and hr.person_id=t.sendperson
		AND EXISTS (SELECT SAD.ADMIN_DEPTID
              FROM SY_ADMIN_DEPTID SAD, SY_ADMIN SA
             WHERE SAD.ADMIN_NO = SA.ADMINNO
  	           AND SA.ADMINID = #applerId:VARCHAR#
         AND SAD.ADMIN_DEPTID = hr.deptid)
		and code.code_id(+)=t.expresstype
				]]>
<isNotEmpty prepend="AND" property="postNumber">
			<![CDATA[
		 		(t.postnumber like '%' || #postNumber:VARCHAR# || '%')
			]]>
</isNotEmpty>
<isNotEmpty prepend="AND" property="StartDate">
			<![CDATA[
		 		(to_date(to_char(t.sentdate, 'yyyy-mm-dd'),'yyyy-mm-dd') >= to_date(#StartDate:VARCHAR#,'yyyy-mm-dd') )
			]]>
</isNotEmpty>
<isNotEmpty prepend="AND" property="EndDate">
			<![CDATA[
		 		(to_date(to_char(t.sentdate, 'yyyy-mm-dd'),'yyyy-mm-dd') <= to_date(#EndDate:VARCHAR#,'yyyy-mm-dd') )
			]]>
</isNotEmpty>
<isNotEmpty prepend="AND" property="sendPerson">
			<![CDATA[
		 		(t.sendperson like '%'||#sendPerson:VARCHAR#||'%' or hr.chinesename like '%'||#sendPerson:VARCHAR#||'%')
			]]>
</isNotEmpty>
<isNotEmpty prepend="AND" property="citysendto">
			<![CDATA[
		 		(t.citysendto like '%'||#citysendto:VARCHAR#||'%')
			]]>
</isNotEmpty>
<isNotEmpty prepend="AND" property="deptID">
			<![CDATA[
		 		(t.deptid = #deptID:VARCHAR#)
			]]>
</isNotEmpty>
		<![CDATA[			
		order by mydate desc
		]]>
</select>

<select id="expressViewListNumber" resultClass="int">
		<![CDATA[			
		select count(*) as s from ( select distinct t.*,hr.chinesename  from 
		ga_express_apply t,
		ga_express_affirm a,
		hr_employee hr		
		where t.apply_no=a.apply_no
		and t.active='1'
		and t.isconfirm='1'
		and a.affirm_flag='1' 
		and t.issend='1'
		and hr.PERSON_ID=t.sendperson
		AND EXISTS (SELECT SAD.ADMIN_DEPTID
              FROM SY_ADMIN_DEPTID SAD, SY_ADMIN SA
             WHERE SAD.ADMIN_NO = SA.ADMINNO
  	           AND SA.ADMINID = #applerId:VARCHAR#
         AND SAD.ADMIN_DEPTID = hr.deptid)
			]]>
<isNotEmpty prepend="AND" property="postNumber">
			<![CDATA[
		 		(t.postnumber like '%' || #postNumber:VARCHAR# || '%')
			]]>
</isNotEmpty>
<isNotEmpty prepend="AND" property="StartDate">
			<![CDATA[
		 		(to_date(to_char(t.sentdate, 'yyyy-mm-dd'),'yyyy-mm-dd') >= to_date(#StartDate:VARCHAR#,'yyyy-mm-dd') )
			]]>
</isNotEmpty>
<isNotEmpty prepend="AND" property="EndDate">
			<![CDATA[
		 		(to_date(to_char(t.sentdate, 'yyyy-mm-dd'),'yyyy-mm-dd') <= to_date(#EndDate:VARCHAR#,'yyyy-mm-dd') )
			]]>
</isNotEmpty>
<isNotEmpty prepend="AND" property="sendPerson">
			<![CDATA[
		 		(t.sendperson like '%'||#sendPerson:VARCHAR#||'%' or hr.chinesename like '%'||#sendPerson:VARCHAR#||'%')
			]]>
</isNotEmpty>
<isNotEmpty prepend="AND" property="citysendto">
			<![CDATA[
		 		(t.citysendto like '%'||#citysendto:VARCHAR#||'%')
			]]>
</isNotEmpty>
<isNotEmpty prepend="AND" property="deptID">
			<![CDATA[
		 		(t.deptid = #deptID:VARCHAR#)
			]]>
</isNotEmpty>
<![CDATA[
		) temp
		]]>
</select>

<select id="costNumber" resultClass="int">
		<![CDATA[			
		select Nvl(sum(temp.costs),0) as s from ( select t.costs  from 
		ga_express_apply t,
		hr_employee hr
		where t.active='1'
		and t.isconfirm='1'
		and hr.person_id = t.SENDPERSON
		and t.issend='1'
		AND EXISTS (SELECT SAD.ADMIN_DEPTID
              FROM SY_ADMIN_DEPTID SAD, SY_ADMIN SA
             WHERE SAD.ADMIN_NO = SA.ADMINNO
               AND SA.ADMINID = #applerId:VARCHAR#
         AND SAD.ADMIN_DEPTID = hr.deptid)
			]]>
<isNotEmpty prepend="AND" property="postNumber">
			<![CDATA[
		 		(t.postnumber like '%' || #postNumber:VARCHAR# || '%')
			]]>
</isNotEmpty>
<isNotEmpty prepend="AND" property="StartDate">
			<![CDATA[
		 		(to_date(to_char(t.sentdate, 'yyyy-mm-dd'),'yyyy-mm-dd') >= to_date(#StartDate:VARCHAR#,'yyyy-mm-dd') )
			]]>
</isNotEmpty>
<isNotEmpty prepend="AND" property="EndDate">
			<![CDATA[
		 		(to_date(to_char(t.sentdate, 'yyyy-mm-dd'),'yyyy-mm-dd') <= to_date(#EndDate:VARCHAR#,'yyyy-mm-dd') )
			]]>
</isNotEmpty>
<isNotEmpty prepend="AND" property="sendPerson">
			<![CDATA[
		 		(t.sendperson like '%'||#sendPerson:VARCHAR#||'%' or hr.chinesename like '%'||#sendPerson:VARCHAR#||'%')
			]]>
</isNotEmpty>
<isNotEmpty prepend="AND" property="citysendto">
			<![CDATA[
		 		(t.citysendto like '%'||#citysendto:VARCHAR#||'%')
			]]>
</isNotEmpty>
<isNotEmpty prepend="AND" property="deptID">
			<![CDATA[
		 		(t.deptid = #deptID:VARCHAR#)
			]]>
</isNotEmpty>
<![CDATA[
		) temp
		]]>
</select>

<update id="confirmCosts" parameterClass="SimpleMap">
<![CDATA[
  update ga_express_apply t
  set t.costs=#Costs:NUMERIC# 
  where t.apply_no=#applyno:NUMERIC# 	
	]]>		
</update>

<insert id="saveCarManager" parameterClass="SimpleMap">
<![CDATA[
  insert INTO GM_MANAGER t (T.ID,
  					T.CAR_NAME,
  					T.MODEL_NUMBER,
  					T.OUT_DATE,
  					T.CAR_NUM,
  					T.SIT_BUM,
  					T.KILOMETER,
  					T.CAR_USEFLAG,
  					T.CAR_FLAG,
  					T.CREATED_BY,
  					T.CREATE_DATE,
  					T.ACTIVE,
  					T.CPNY_ID )
  					VALUES(
  					GM_CARMANAGER_SEQ.NEXTVAL,
  					#CAR_NAME:VARCHAR#,
  					#MODEL_NUMBER:VARCHAR#,
  					TO_DATE(#OUT_DATE#,'YYYY-MM-DD'),
  					#CAR_NUM:VARCHAR#,
  					#SIT_BUM:VARCHAR#,
  					#KILOMETER:NUMBER#,
  					#CAR_USEFLAG:VARCHAR#,
  					#CAR_FLAG:VARCHAR#,
  					#ADMINID:VARCHAR#,
  					SYSDATE,
  					'1',
  					#cpny_id:VARCHAR#
  					)	
	]]>	
</insert>
<update id="updateCarManager" parameterClass="SimpleMap">
<![CDATA[
  update GM_MANAGER t
  set t.CAR_NAME=#CAR_NAME:VARCHAR# ,
  	  T.MODEL_NUMBER=#MODEL_NUMBER:VARCHAR#,
  	  T.OUT_DATE=TO_DATE(#OUT_DATE#,'YYYY-MM-DD'),
  	  T.CAR_NUM = #CAR_NUM:VARCHAR#,
  	  T.SIT_BUM= #SIT_BUM:VARCHAR#,
  	  T.KILOMETER = #KILOMETER:NUMBER#,
  	  T.CAR_USEFLAG = #CAR_USEFLAG:VARCHAR#,
  	  T.CAR_FLAG = #CAR_FLAG:VARCHAR#
  where t.ID=#ID:VARCHAR# 	
	]]>		
</update>

<select id="EMSDetailsExcel" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
select distinct to_char(t.sentdate, 'yyyy-mm-dd hh24') || '点' as mydate,
                v.deptname,
                t.citysendto,
                t.postaddress,
                code.code_name,
                hr.chinesename,
                hr1.chinesename as applyor,
                t.sendtoperson,
                t.postnumber,
                t.postdescription, 
                              
                to_char(t.costs) as costs,
               to_char(round((to_number(#inputdata1:VARCHAR#) /
               (select count(*)
                  from ga_express_apply t,hr_employee e
                 where to_char(t.sentdate, 'yyyy-mm-dd') between #excelStartDate2:VARCHAR# and #excelEndDate2:VARCHAR# and t.applyor_id = e.person_id and e.cpny_id=#cpny_id:varchar#)),
              2)) Costsharing,
               to_char((t.costs +
               (round((to_number(#inputdata1:VARCHAR#) /
                       (select count(*)
                           from ga_express_apply t,hr_employee e
                          where to_char(t.sentdate, 'yyyy-mm-dd') between #excelStartDate2:VARCHAR# and #excelEndDate2:VARCHAR# and t.applyor_id = e.person_id and e.cpny_id=#cpny_id:varchar#)),
                       2)))) sumcosts,
                       t.note
from ga_express_apply  t,
       ga_express_affirm a,
       hr_department     v,
       hr_employee       hr,
       hr_employee       hr1,
       sy_code           code
where t.apply_no = a.apply_no
   and t.active = '1'
   and t.isconfirm = '1'
   and t.issend = '1'
   and a.affirm_flag = '1'
   and v.deptid(+) = t.deptid
   and hr1.person_id(+) = t.APPLYOR_ID
   and t.applyor_id = hr1.person_id and hr1.cpny_id=#cpny_id:varchar#
   and hr.person_id(+) = t.sendperson
   and code.code_id(+) = t.expresstype
   and to_char(t.sentdate, 'yyyy-mm-dd') between #excelStartDate2:VARCHAR# and #excelEndDate2:VARCHAR#
union all
select '总计','','','','','','','','','',to_char(sum(t.costs)),#inputdata1:VARCHAR#,to_char(sum(t.costs)+to_number(#inputdata1:VARCHAR#)),'' from ga_express_apply t,hr_employee e	
where  to_char(t.sentdate, 'yyyy-mm-dd') between #excelStartDate2:VARCHAR# and #excelEndDate2:VARCHAR#	 and t.applyor_id = e.person_id and e.cpny_id=#cpny_id:varchar#	


		]]>
</select>

<select id="EMSTotalExcelList" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
select de.deptname,
       to_char(count(*)) Shares,
       to_char(sum(temp.costs)) costs,
       to_char(round((to_number(#inputdata2:VARCHAR#)/
              (select count(*)
                  from ga_express_apply t,HR_EMPLOYEE E
                 where to_char(t.sentdate, 'yyyy-mm-dd') between #excelStartDate2:VARCHAR# and #excelEndDate2:VARCHAR# 
                 and t.active = '1'
           and t.isconfirm = '1'
           AND E.PERSON_ID = T.APPLYOR_ID AND E.CPNY_ID=#CPNY_ID:VARCHAR#
           and t.issend = '1')),
              2) * count(*)) Costsharing,
       to_char((sum(temp.sumcosts) +(round((to_number(#inputdata2:VARCHAR#)/
              (select count(*)
                  from ga_express_apply t,HR_EMPLOYEE E
                 where to_char(t.sentdate, 'yyyy-mm-dd') between #excelStartDate2:VARCHAR# and #excelEndDate2:VARCHAR# 
                 and t.active = '1'
           and t.isconfirm = '1'
           AND E.PERSON_ID = T.APPLYOR_ID AND E.CPNY_ID=#CPNY_ID:VARCHAR#
           and t.issend = '1')),
              2) * count(*)))) sumcosts
from(
   select distinct t.apply_no, hr_get_level_deptid(t.deptid,'4') as deptid, nvl(t.costs, '') as costs,nvl(t.costs, '') as sumcosts
   from ga_express_apply  t,
   ga_express_affirm a        ,HR_EMPLOYEE E
where t.apply_no = a.apply_no
   and t.active = '1'
   and t.isconfirm = '1'
   and t.issend = '1'
   AND E.PERSON_ID = T.APPLYOR_ID AND E.CPNY_ID=#CPNY_ID:VARCHAR#
   and a.affirm_flag = '1' 
   and a.affirm_level='1' 
   and to_char(t.sentdate, 'yyyy-mm-dd') between #excelStartDate2:VARCHAR# and #excelEndDate2:VARCHAR# 
   ]]>
   <isNotEmpty prepend="AND" property="expenses_type">
			<![CDATA[
		 		t.EXPRESSTYPE = #expenses_type:VARCHAR#
			]]>
		</isNotEmpty>
   <![CDATA[
   ) temp,hr_department de
where temp.deptid=de.deptid(+)
group by de.deptname

union  all

select '总计',TO_CHAR(COUNT(*)) AS Shares,TO_CHAR(SUM(T.costs)), to_CHAR(#inputdata2:VARCHAR#) AS Costsharing,to_char(sum(t.costs)+#inputdata2:NUMERIC#) sumcosts  from ga_express_apply t ,HR_EMPLOYEE E
where  to_char(t.sentdate, 'yyyy-mm-dd') between #excelStartDate2:VARCHAR# and #excelEndDate2:VARCHAR#		
and t.isconfirm = '1'
           and t.issend = '1'
           AND T.APPLYOR_ID = E.PERSON_ID AND E.CPNY_ID=#CPNY_ID:VARCHAR#
           ]]>
   <isNotEmpty prepend="AND" property="expenses_type">
			<![CDATA[
		 		t.EXPRESSTYPE = #expenses_type:VARCHAR#
			]]>
		</isNotEmpty>
   <![CDATA[

		]]>
</select>


<select id="EMSStatisticsExcel" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
select hr.deptname,
       nvl(temp1.counts, 0) counts1,
       nvl(temp1.costs, 0) costs1,
       nvl(temp2.counts, 0) counts2,
       nvl(temp2.costs, 0) costs2,
       nvl(temp3.counts, 0) counts3,
       nvl(temp3.costs, 0) costs3,
      nvl(temp4.counts, 0) counts4,
       nvl(temp4.costs, 0) costs4,
      nvl(temp5.counts, 0) counts5,
       nvl(temp5.costs, 0) costs5,
       nvl(temp6.counts, 0) counts6,
       nvl(temp6.costs, 0) costs6,
       nvl(temp7.counts, 0) counts7,
       nvl(temp7.costs, 0) costs7,
       nvl(temp8.counts, 0) counts8,
       nvl(temp8.costs, 0) costs8,
       nvl(temp9.counts, 0) counts9,
       nvl(temp9.costs, 0) costs9,
       nvl(temp10.counts, 0) counts10,
       nvl(temp10.costs, 0) costs10,
       nvl(temp11.counts, 0) counts11,
       nvl(temp11.costs, 0) costs11,
       nvl(temp12.counts, 0) counts12,
       nvl(temp12.costs, 0) costs12,
       (nvl(temp1.costs, 0) + nvl(temp2.costs, 0) +
       nvl(temp3.costs, 0) + nvl(temp4.costs, 0) +
       nvl(temp5.costs, 0) + nvl(temp6.costs, 0) +
       nvl(temp7.costs, 0) + nvl(temp8.costs, 0) +
       nvl(temp9.costs, 0) + nvl(temp10.costs, 0) +
       nvl(temp11.costs, 0) + nvl(temp12.costs, 0)) sumcosts,
       (nvl(temp1.counts, 0) + nvl(temp2.counts, 0) +
       nvl(temp3.counts, 0) + nvl(temp4.counts, 0) +
       nvl(temp5.counts, 0) + nvl(temp6.counts, 0) +
       nvl(temp7.counts, 0) + nvl(temp8.counts, 0) +
       nvl(temp9.counts, 0) + nvl(temp10.counts, 0) +
       nvl(temp11.counts, 0) + nvl(temp12.counts, 0)) sumcounts
  from  (select count(A.apply_no) counts, sum(A.costs) costs, A.deptid from
        (select t.apply_no,
                t.costs,
                hr_get_level_deptid(t.deptid, '4') deptid
           from ga_express_apply t, HR_EMPLOYEE E
          where t.issend = '1'
        and t.applydate between add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),0) and
            add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),1)
            and t.isconfirm = '1'
           AND E.PERSON_ID = T.APPLYOR_ID AND E.CPNY_ID=#CPNY_ID:VARCHAR#
           and t.issend = '1') A
         group by A.deptid) temp1,
        (select count(A.apply_no) counts, sum(A.costs) costs, A.deptid from
        (select t.apply_no,
                t.costs,
                hr_get_level_deptid(t.deptid, '4') deptid
           from ga_express_apply t, HR_EMPLOYEE E
          where t.issend = '1'
         and t.applydate between add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),1) and
             add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),2)
             and t.isconfirm = '1'
           AND E.PERSON_ID = T.APPLYOR_ID AND E.CPNY_ID=#CPNY_ID:VARCHAR#
           and t.issend = '1') A
         group by A.deptid) temp2,
        (select count(A.apply_no) counts, sum(A.costs) costs, A.deptid from
        (select t.apply_no,
                t.costs,
                hr_get_level_deptid(t.deptid, '4') deptid
           from ga_express_apply t, HR_EMPLOYEE E
          where t.issend = '1'
         and t.applydate between add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),2) and
             add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),3)
             and t.isconfirm = '1'
           AND E.PERSON_ID = T.APPLYOR_ID AND E.CPNY_ID=#CPNY_ID:VARCHAR#
           and t.issend = '1') A
         group by A.deptid) temp3,
        (select count(A.apply_no) counts, sum(A.costs) costs, A.deptid from
        (select t.apply_no,
                t.costs,
                hr_get_level_deptid(t.deptid, '4') deptid
           from ga_express_apply t, HR_EMPLOYEE E
          where t.issend = '1'
         and t.applydate between add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),3) and
             add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),4)
             and t.isconfirm = '1'
           AND E.PERSON_ID = T.APPLYOR_ID AND E.CPNY_ID=#CPNY_ID:VARCHAR#
           and t.issend = '1') A
         group by A.deptid) temp4,
         (select count(A.apply_no) counts, sum(A.costs) costs, A.deptid from
        (select t.apply_no,
                t.costs,
                hr_get_level_deptid(t.deptid, '4') deptid
           from ga_express_apply t, HR_EMPLOYEE E
          where t.issend = '1'
         and t.applydate between add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),4) and
             add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),5)
             and t.isconfirm = '1'
           AND E.PERSON_ID = T.APPLYOR_ID AND E.CPNY_ID=#CPNY_ID:VARCHAR#
           and t.issend = '1') A
         group by A.deptid) temp5,
         (select count(A.apply_no) counts, sum(A.costs) costs, A.deptid from
        (select t.apply_no,
                t.costs,
                hr_get_level_deptid(t.deptid, '4') deptid
           from ga_express_apply t, HR_EMPLOYEE E
          where t.issend = '1'
         and t.applydate between add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),5) and
             add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),6)
             and t.isconfirm = '1'
           AND E.PERSON_ID = T.APPLYOR_ID AND E.CPNY_ID=#CPNY_ID:VARCHAR#
           and t.issend = '1') A
         group by A.deptid) temp6,
        (select count(A.apply_no) counts, sum(A.costs) costs, A.deptid from
        (select t.apply_no,
                t.costs,
                hr_get_level_deptid(t.deptid, '4') deptid
           from ga_express_apply t, HR_EMPLOYEE E
          where t.issend = '1'
         and t.applydate between add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),6) and
             add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),7)
             and t.isconfirm = '1'
           AND E.PERSON_ID = T.APPLYOR_ID AND E.CPNY_ID=#CPNY_ID:VARCHAR#
           and t.issend = '1') A
         group by A.deptid) temp7,
       (select count(A.apply_no) counts, sum(A.costs) costs, A.deptid from
        (select t.apply_no,
                t.costs,
                hr_get_level_deptid(t.deptid, '4') deptid
           from ga_express_apply t, HR_EMPLOYEE E
          where t.issend = '1'
         and t.applydate between add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),7) and
             add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),8)
             and t.isconfirm = '1'
           AND E.PERSON_ID = T.APPLYOR_ID AND E.CPNY_ID=#CPNY_ID:VARCHAR#
           and t.issend = '1') A
         group by A.deptid) temp8,     
       (select count(A.apply_no) counts, sum(A.costs) costs, A.deptid from
        (select t.apply_no,
                t.costs,
                hr_get_level_deptid(t.deptid, '4') deptid
           from ga_express_apply t, HR_EMPLOYEE E
          where t.issend = '1'
        and t.applydate between add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),8) and
           add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),9)
           and t.isconfirm = '1'
           AND E.PERSON_ID = T.APPLYOR_ID AND E.CPNY_ID=#CPNY_ID:VARCHAR#
           and t.issend = '1') A
         group by A.deptid) temp9,
       (select count(A.apply_no) counts, sum(A.costs) costs, A.deptid from
        (select t.apply_no,
                t.costs,
                hr_get_level_deptid(t.deptid, '4') deptid
           from ga_express_apply t, HR_EMPLOYEE E
          where t.issend = '1'
         and t.applydate between add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),9) and
             add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),10)
             and t.isconfirm = '1'
           AND E.PERSON_ID = T.APPLYOR_ID AND E.CPNY_ID=#CPNY_ID:VARCHAR#
           and t.issend = '1') A
         group by A.deptid) temp10,
       (select count(A.apply_no) counts, sum(A.costs) costs, A.deptid from
        (select t.apply_no,
                t.costs,
                hr_get_level_deptid(t.deptid, '4') deptid
           from ga_express_apply t, HR_EMPLOYEE E
          where t.issend = '1'
         and t.applydate between add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),10) and
             add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),11)
             and t.isconfirm = '1'
           AND E.PERSON_ID = T.APPLYOR_ID AND E.CPNY_ID=#CPNY_ID:VARCHAR#
           and t.issend = '1') A
         group by A.deptid) temp11,
       (select count(A.apply_no) counts, sum(A.costs) costs, A.deptid from
        (select t.apply_no,
                t.costs,
                hr_get_level_deptid(t.deptid, '4') deptid
           from ga_express_apply t, HR_EMPLOYEE E
          where t.issend = '1'
         and t.applydate between add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),11) and
             add_months(to_date(#sysyear:VARCHAR#,'yyyy-mm-dd'),12)
             and t.isconfirm = '1'
           AND E.PERSON_ID = T.APPLYOR_ID AND E.CPNY_ID=#CPNY_ID:VARCHAR#
           and t.issend = '1') A
         group by A.deptid) temp12,
         hr_dept_tree_v hr
 where hr.deptid= temp6.deptid(+)
 and hr.deptid=temp1.deptid(+)
 and hr.deptid=temp2.deptid(+)
  and hr.deptid=temp3.deptid(+)
 and hr.deptid=temp4.deptid(+)
  and hr.deptid=temp5.deptid(+)
 and hr.deptid=temp6.deptid(+)
  and hr.deptid=temp7.deptid(+)
 and hr.deptid=temp8.deptid(+)
  and hr.deptid=temp9.deptid(+)
 and hr.deptid=temp10.deptid(+)
  and hr.deptid=temp11.deptid(+)
 and hr.deptid=temp12.deptid(+)
 and hr.dept_level='4'
 AND EXISTS (SELECT SAD.ADMIN_DEPTID
              FROM SY_ADMIN_DEPTID SAD, SY_ADMIN SA
             WHERE SAD.ADMIN_NO = SA.ADMINNO
  	           AND SA.ADMINID = #applerId:VARCHAR#
         AND SAD.ADMIN_DEPTID = hr.deptid)


		]]>
</select>

<select id="getQueryCarManager" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
		select  t.ID,t.CAR_NAME,t.MODEL_NUMBER,to_char(t.OUT_DATE,'YYYY-MM-DD') as OUT_DATE,
		t.CAR_NUM,SIT_BUM,KILOMETER,CAR_USEFLAG,CAR_FLAG,c.code_name AS CAR_FLAG_NAME
		 from GM_MANAGER t,sy_code c where t.car_flag=c.code_id and t.cpny_id=#cpny_id:varchar#
				]]>
</select>

<select id="getQueryCarManagerInt" resultClass="int" parameterClass="SimpleMap">
		<![CDATA[
		select count(*) from GM_MANAGER t where t.cpny_id=#cpny_id:varchar#
				]]>
</select>

<insert id="expressInstallSave" parameterClass="SimpleMap">
<![CDATA[
  insert INTO GM_EXCRESSINSTALL t (T.ID,
  					t.ORDERNUM,
  					t.GIVE_CITY,
  					t.ARRIVE_CITY,
  					t.email_expenses,
  					t.expenses_type,
  					CREATE_DATE,
  					CREATED_BY,
  					 CPNY_ID)
  					VALUES(
  					GM_EXCRESSINSTALL_SEQ.NEXTVAL,
  					#number:VARCHAR#,
  					#give_city:VARCHAR#,
  					#arrive_city:VARCHAR#,
  					#email_expenses:number#,
  					#expenses_type:VARCHAR#,
  					sysdate,
  					#applerId:VARCHAR#,
  					#cpny_id:VARCHAR#
  					)	
	]]>	
</insert>

<update id="expressInstallUpdate" parameterClass="SimpleMap">
<![CDATA[
  update GM_EXCRESSINSTALL t
  set t.ORDERNUM=#number:VARCHAR#,
  	  T.give_city=#give_city:VARCHAR#,
  	  T.arrive_city=#arrive_city:VARCHAR#,
  	  T.email_expenses = #email_expenses:number#,
  	  T.expenses_type= #expenses_type:VARCHAR#,
  	  T.UPDATE_DATE = sysdate,
  	  T.UPDATED_BY = #applerId:VARCHAR#
  where t.ID=#id:VARCHAR# 	
	]]>		
</update>

<select id="getExpressInstall" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
		select  t.ID,t.ORDERNUM,t.give_city,t.arrive_city,
		t.email_expenses,t.expenses_type,c.code_name AS expenses_type_name
		 from GM_EXCRESSINSTALL t,sy_code c where t.expenses_type=c.code_id and (t.cpny_id=#cpny_id:varchar# or t.cpny_id is null) order by t.ORDERNUM asc
				]]>
</select>
<select id="ViewexpressInstallUpdate" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
		select  t.ID,t.ORDERNUM,t.give_city,t.arrive_city,
		t.email_expenses,t.expenses_type,c.code_name AS expenses_type_name
		 from GM_EXCRESSINSTALL t,sy_code c where t.expenses_type=c.code_id  and (t.id=#id:varchar# or t.cpny_id is null)
				]]>
</select>

<delete id="expressInstallDel" parameterClass="SimpleMap">
		<![CDATA[
		DELETE GM_EXCRESSINSTALL T WHERE T.ID = #id:NUMERIC#
	]]>
	</delete>

<select id="getExpress" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
		select  t.ID,t.give_city,t.arrive_city,
		t.email_expenses,t.expenses_type,c.code_name AS expenses_type_name
		 from GM_EXCRESSINSTALL t,sy_code c where t.expenses_type=c.code_id and (t.cpny_id=#cpny_id:varchar# or t.cpny_id is null)
		 ]]>
		 <isNotEmpty prepend="AND" property="citySent">
			<![CDATA[
		 		t.GIVE_CITY = #citySent:VARCHAR#
			]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="cityarrive">
			<![CDATA[
		 		t.ARRIVE_CITY = #cityarrive:VARCHAR#
			]]>
		</isNotEmpty>
		 <![CDATA[
		  order by t.EMAIL_EXPENSES asc
				]]>
</select>
<select id="getExpress1" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
		select distinct t.give_city
		 from GM_EXCRESSINSTALL t where t.cpny_id=#cpny_id:varchar# or t.cpny_id is null
				]]>
</select>
<select id="getExpress2" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
		select distinct t.arrive_city
		 from GM_EXCRESSINSTALL t where t.cpny_id=#cpny_id:varchar# or t.cpny_id is null
				]]>
</select>
<select id="gaReportList" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
		    SELECT A.MENU_CODE,A.MENU_INTRO,A.MENU_URL,A.MENU_PARENT_CODE,A.MENU_EN_INTRO
				  FROM SY_MENU A, SY_SCREEN_GRANT B
				 WHERE A.MENU_PARENT_CODE = 'report0300'
				   AND A.MENU_CODE = B.SCREEN_CODE
				   AND B.SCREEN_GRANT_NO IN ($screenGrantNo$)
				ORDER BY A.ORDERNO
				]]>
</select>
<select id="getCompany" parameterClass="SimpleMap" resultClass="SimpleMap">
		 <![CDATA[
				SELECT * FROM HR_COMPANY H WHERE H.ACTIVITY = 1 
		 ]]>
		 <![CDATA[
		       ORDER BY ORDERNO
		 ]]>
</select>
</sqlMap>