<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="gm.waste">
	<!-- retrieve overtime plan list -->
	<select id="wasteView" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			select t.waste_id,
			       t.waste_no,
			       s.code_name as Waste_Type,
			       get_code_name(t.waste_units) waste_units,
			       t.waste_unitprice,
			       t.waste_number,
			       t.waste_total,
			       s1.code_name as company_customers,
			       to_char(t.create_date,'yyyy-MM-dd hh24:mi') as create_date,
			       he.chinesename as create_by,
			       t.remark,
			       s2.code_name as REVENUE_APPROACH,
			       t.OUT_STAFF,
			       t.CAR_NO,
			       s3.code_name CITEREASONS,
			       t.COMPANY_OTHER
			  from gm_waste t, sy_code s, hr_employee he, sy_code s1, sy_code s2,sy_code s3
			 where t.waste_type = s.code_id
			   and he.person_id(+) = t.create_by
			   and s1.code_id(+) = t.company_customers
			   and s2.code_id(+) = t.REVENUE_APPROACH
			   and s3.code_id(+) = t.CITEREASONS and t.cpny_id=#cpny_id:varchar# and s.parent_code like '%'||#type:varchar#||'%'
		]]>
		<isNotEmpty prepend="AND" property="wasteType">
			<![CDATA[
		 		(s.code_name = #wasteType:VARCHAR#)
			]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="StartTime">
			<![CDATA[
		 		(to_char(t.CREATE_DATE,'yyyy-MM-dd') >= #StartTime:VARCHAR#)
			]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="EndTime">
			<![CDATA[
		 		(to_char(t.CREATE_DATE,'yyyy-MM-dd') <= #EndTime:VARCHAR#)
			]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="NO">
			<![CDATA[
		 		t.waste_no like '%' || #NO:VARCHAR# || '%'
			]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="Company_Customers">
			<![CDATA[
		 		(s1.code_id = #Company_Customers:VARCHAR#)
			]]>
		</isNotEmpty>
		<![CDATA[
		 		order by t.waste_id desc
		]]>
	</select>
	
	<select id="allWasteInformationCount" parameterClass="SimpleMap" resultClass="int">
		<![CDATA[
			select count(*)
			  from gm_waste    t,
       sy_code     s,
       hr_employee he,
       sy_code     s1
			 where t.waste_type = s.code_id
			   and he.person_id = t.create_by and t.cpny_id=#cpny_id:varchar# and s.parent_code like '%'||#type:varchar#||'%' and s1.code_id(+) = t.company_customers
		]]>
		<isNotEmpty prepend="AND" property="wasteType">
			<![CDATA[
		 		(s.code_name = #wasteType:VARCHAR#)
			]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="StartTime">
			<![CDATA[
		 		(to_char(t.CREATE_DATE,'yyyy-MM-dd') >= #StartTime:VARCHAR#)
			]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="EndTime">
			<![CDATA[
		 		(to_char(t.CREATE_DATE,'yyyy-MM-dd') <= #EndTime:VARCHAR#)
			]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="NO">
			<![CDATA[
		 		t.waste_no like '%' || #NO:VARCHAR# || '%'
			]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="Company_Customers">
			<![CDATA[
		 		(s1.code_id = #Company_Customers:VARCHAR#)
			]]>
		</isNotEmpty>
	</select>
	
	<select id="wasteType" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			select * from sy_code t where t.parent_code like '%'||#type:varchar#||'%' and (t.cpny_id=#cpny_id:varchar# or t.cpny_id is null)
		]]>
	</select>
	
	<insert id="addWaste" parameterClass="SimpleMap">
		<![CDATA[
			insert into gm_waste t
			  (t.waste_id,
			   t.waste_no,
			   t.waste_type,
			   t.WASTE_UNITS,
               t.waste_unitprice,
               t.waste_number,
			   t.waste_total,
			   t.COMPANY_CUSTOMERS,
			   t.remark,
		       t.create_date,
		       t.create_by,
		       t.REVENUE_APPROACH,
		       t.OUT_STAFF,
		       t.CAR_NO,
		       t.CITEREASONS,
		       t.COMPANY_OTHER,
		       t.cpny_id)
			values
			  (
		  	   gm_waste_seq.nextval,
		  	   #NUMBERS:VARCHAR#,
		  	   #wasteType:VARCHAR#,
		  	   #Units:VARCHAR#,
		  	   #wasteUnitPrice:NUMERIC#,
		  	   #wasteNumber:NUMERIC#,
		  	   #total:NUMERIC#,
		  	   #Company_Customers:VARCHAR#,
		  	   #remarks:VARCHAR#,
		  	   sysdate,
		  	   #supervisor:VARCHAR#,
		  	   #revenue_approach:VARCHAR#,
		  	   #OUT_STAFF:VARCHAR#,
		  	   #CAR_NO:VARCHAR#,
		  	   #citeReasons:VARCHAR#,
		  	   #Company_other:varchar#,
		  	   #cpny_id:varchar#
			  )
		]]>
	</insert>
	
	<update id="updateWaste" parameterClass="SimpleMap">
		<![CDATA[
			update gm_waste t 
			   set t.waste_type = #wasteType:VARCHAR#,
			       t.waste_units = #Units:VARCHAR#,
			       t.waste_unitprice = #unitPrice:NUMERIC#,
			       t.waste_number = #wasteNumber:NUMERIC#,
			       t.waste_total = #total:NUMERIC#,
			       t.company_customers = #Company_Customers:VARCHAR#,
			       t.remark = #remarks:VARCHAR#,
			       t.update_date = sysdate,
			       t.update_by = #supervisor:VARCHAR#,
				  t.REVENUE_APPROACH = #revenue_approach:VARCHAR#,
				  t.OUT_STAFF = #OUT_STAFF:VARCHAR#,
				  t.CAR_NO = #CAR_NO:VARCHAR#,
				  t.CITEREASONS = #citeReasons:VARCHAR#,
				  t.COMPANY_OTHER =#COMPANY_OTHER:varchar#
			 where t.waste_id = #wasteId:NUMERIC#
		]]>
	</update>
	
	<select id="allUpdateWasteInformation" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			select t.waste_id,
			       t.waste_no,
			       s.code_name as Waste_Type_Name,
			       t.waste_type,
			       get_code_name(t.waste_units) waste_units,
			       t.waste_unitprice,
			       t.waste_number,
			       t.waste_total,
			       s1.code_name as company_customers,
			       s1.code_id as company_customers_id,
			       to_char(t.create_date,'yyyy-MM-dd hh24:mi') as create_date,
			       he.chinesename as create_by,
			       t.remark,
			       s2.code_name as REVENUE_APPROACH_NAME,
			       t.REVENUE_APPROACH as REVENUE_APPROACH_ID,
			       t.OUT_STAFF,
			       t.CAR_NO,
			       t.CITEREASONS,
			       t.COMPANY_OTHER
			  from gm_waste t, sy_code s, hr_employee he, sy_code s1, sy_code s2
			 where t.waste_type = s.code_id
			   and he.person_id(+) = t.create_by
			   and s1.code_id(+) = t.company_customers
			   and s2.code_id = t.REVENUE_APPROACH
			    and t.waste_id = #wasteId:NUMERIC#
		]]>
	</select>
	
	<delete id="deleteWaste" parameterClass="SimpleMap">
		<![CDATA[
			delete gm_waste_set t where t.waste_set_id = #wasteId:NUMERIC#
		]]>
	</delete>
	
    <delete id="deleteWasteBasicInformation" parameterClass="SimpleMap">
		<![CDATA[
			delete gm_waste t where t.waste_id = #wasteId:NUMERIC#
		]]>
	</delete>
	
	<select id="atpresentUnitPrice" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			select distinct nvl(t.waste_unitprice, '0') as waste_unitprice,
                t.waste_type , s.code_name
			  from gm_waste t , sy_code s
			 where t.waste_type = #wasteId:VARCHAR#
		]]>
	</select>
	
	<select id="getUnitPrice" parameterClass="SimpleMap" resultClass="float">
		<![CDATA[
		 select tt.WASTE_SET_UNITPRICE from (select  WASTE.* ,rownum cc from (SELECT T.WASTE_SET_UNITPRICE
          FROM GM_WASTE_SET T
         WHERE T.WASTE_SET_NAME_ID = #TypeId:VARCHAR#
        ORDER BY T.WASTE_SET_UPDATE_DATE desc ) WASTE ) tt
        where tt.cc=1			
		]]>
	</select>
	
	<select id="getUnits" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
		SELECT TT.WASTE_SET_UNITS, TT.WASTE_SET_UNITS_NAME
		  FROM (SELECT WASTE.*, ROWNUM CC
		          FROM (SELECT T.WASTE_SET_UNITS,
		                       SY.CODE_NAME AS WASTE_SET_UNITS_NAME
		                  FROM GM_WASTE_SET T, SY_CODE SY
		                 WHERE T.WASTE_SET_UNITS = SY.CODE_ID(+)
		                   AND T.WASTE_SET_NAME_ID = #TypeId:VARCHAR#
		                 ORDER BY T.WASTE_SET_UPDATE_DATE DESC) WASTE) TT
		 WHERE TT.CC = 1
		]]>
	</select>
	
	<update id="updateUnitPrice" parameterClass="SimpleMap">
		<![CDATA[
			update gm_waste t set t.waste_unitprice = #unitPrice:NUMERIC# where t.waste_type = #wasteId:VARCHAR#
		]]>
	</update>
	
	<update id="changeActive" parameterClass="SimpleMap">
		<![CDATA[
			UPDATE GM_WASTE_SET T
			   SET T.UNITPRICE_FLAG = '1'
			 WHERE T.WASTE_SET_APPLICABLE_DATE = #applicableDate:VARCHAR#
		]]>
	</update>
	
	<select id="searchActive" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			select active , nvl(okdate_active,'0') as okdate_active from ga_wasteunitprice_apply 
		]]>
	</select>
	
	<select id="WASTE_SET_APPLICABLE_DATE" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			 SELECT T.WASTE_SET_APPLICABLE_DATE FROM GM_WASTE_SET T
		]]>
	</select>
	
	<select id="time" parameterClass="SimpleMap" resultClass="string">
		<![CDATA[
			  SELECT A.WASTE_SET_APPLICABLE_DATE FROM (
					 SELECT * FROM GM_WASTE_SET T
					  WHERE T.WASTE_SET_APPLICABLE_DATE IN ($tempDate$)
					  ORDER BY T.WASTE_SET_APPLICABLE_DATE
					  ) A WHERE ROWNUM = 1
		]]>
	</select>
	
	<select id="allgmmonthClearingSearchCount" parameterClass="SimpleMap" resultClass="int">
		<![CDATA[
			select count(*)
			  from gm_waste g, sy_code s
			 where g.waste_type = s.code_id
		]]>
		<isNotEmpty prepend="AND" property="StartTime">
			<![CDATA[
		 		(to_char(g.waste_date,'yyyy-MM-dd') >= #StartTime:VARCHAR#)
			]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="EndTime">
			<![CDATA[
		 		(to_char(g.waste_date,'yyyy-MM-dd') <= #EndTime:VARCHAR#)
			]]>
		</isNotEmpty>
	</select>
	
	<select id="allmonthClearingSearch" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			select s.code_name as wasteName,
			       nvl(g.waste_unitprice, '0') as unitPrice,
			       nvl(g.waste_kg, '0') as Kg,
			       nvl(g.waste_number, '0') as waste_number,
			       nvl((g.waste_number * g.waste_kg), '0') as TotalPriceKG,
			       nvl((g.waste_number * g.waste_unitprice), '0') as TotalPriceUNITPRICE,
			       g.waste_cal_type
			  from gm_waste g, sy_code s
			 where g.waste_type = s.code_id
		]]>
		<isNotEmpty prepend="AND" property="StartTime">
			<![CDATA[
		 		(to_char(g.waste_date,'yyyy-MM-dd') >= #StartTime:VARCHAR#)
			]]>
		</isNotEmpty>
		<isNotEmpty prepend="AND" property="EndTime">
			<![CDATA[
		 		(to_char(g.waste_date,'yyyy-MM-dd') <= #EndTime:VARCHAR#)
			]]>
		</isNotEmpty>
	</select>
 	<select id="alltotal" parameterClass="SimpleMap" resultClass="int">
		<![CDATA[
			 
			  select sum(TotalPrice)
			   from (select s.code_name as wasteName,
			       nvl(g.waste_unitprice, '0') as unitPrice,
			       nvl(g.waste_kg, '0') as Kg,
			       nvl(g.waste_number, '0') as waste_number,
			       nvl((g.waste_number * g.waste_kg), '0') as TotalPriceKG,
			       nvl((g.waste_number * g.waste_unitprice), '0') as TotalPriceUNITPRICE,
			       g.waste_cal_type,
			       g.waste_total as TotalPrice,
			       g.waste_date
			  from gm_waste g, sy_code s
			 where g.waste_type = s.code_id) a
		]]>
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="StartTime">
				<![CDATA[
			 		(to_char(a.waste_date,'yyyy-MM-dd') >= #StartTime:VARCHAR#)
				]]>
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="EndTime">
				<![CDATA[
			 		(to_char(a.waste_date,'yyyy-MM-dd') <= #EndTime:VARCHAR#)
				]]>
			</isNotEmpty>
		</dynamic>
	</select>
	
	<select id="getBasicInformationInt" parameterClass="SimpleMap" resultClass="int">
		<![CDATA[
			 select count(*)
			  from gm_waste_set t,sy_code s
			 where  t.cpny_id=#cpny_id:varchar# and s.code_id = t.waste_set_name_id and s.parent_code=#type:varchar#
		]]>
			<isNotEmpty prepend="AND" property="StartTime">
				<![CDATA[
					t.waste_set_applicable_date >= #StartTime:VARCHAR#
				]]>
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="EndTime">
				<![CDATA[
					t.waste_set_applicable_date <= #EndTime:VARCHAR#
				]]>
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="waste_name">
				<![CDATA[
					s.code_name = #waste_name:VARCHAR#
				]]>
			</isNotEmpty>
	</select>
	
	<select id="getBasicInformation" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			 select t.waste_set_id,
			       s.code_name as waste_set_name,
			       t.waste_set_name_id,
			       get_code_name(t.waste_set_units) waste_set_units,
			       t.waste_set_unitprice,
			       t.waste_set_applicable_date,
			       t.waste_set_qi_an_according_no,
			       to_char(t.waste_set_registration_date,'yyyy-mm-dd hh24:mi') as waste_set_registration_date,
			       he.chinesename as waste_set_by,
			       t.waste_set_update_date,
			       t.waste_set_update_by
			  from gm_waste_set t, sy_code s, hr_employee he
			
			 where s.code_id = t.waste_set_name_id and t.cpny_id=#cpny_id:varchar#
			   and he.person_id = t.waste_set_by and s.parent_code=#type:varchar#
		]]>
			<isNotEmpty prepend="AND" property="StartTime">
				<![CDATA[
					t.waste_set_applicable_date >= #StartTime:VARCHAR#
				]]>
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="EndTime">
				<![CDATA[
					t.waste_set_applicable_date <= #EndTime:VARCHAR#
				]]>
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="waste_name">
				<![CDATA[
					s.code_name = #waste_name:VARCHAR#
				]]>
			</isNotEmpty>
				<![CDATA[
					ORDER BY t.waste_set_id DESC
				]]>
	</select>
	
	<insert id="addWasteBasicInformation" parameterClass="SimpleMap">
		<![CDATA[
			insert into gm_waste_set t
				  (t.waste_set_id,
				   t.waste_set_name_id,
				   t.waste_set_units,
				   t.waste_set_unitprice,
				   t.waste_set_applicable_date,
				   t.waste_set_qi_an_according_no,
				   t.waste_set_registration_date,
				   t.waste_set_by,
				   t.UNITPRICE_FLAG,
				   cpny_id)
				values
				  (gm_waste_set_seq.nextval,
				  #wasteName:VARCHAR#,
				  #CalType:VARCHAR#,
				  #UnitPrice:VARCHAR#,
				  #WASTE_SET_APPLICABLE_DATE:VARCHAR#,
				  #WASTE_SET_QI_AN_ACCORDING_NO:VARCHAR#,
				  sysdate,
				  #supervisor:VARCHAR#,
				  '0',
				  #cpny_id:varchar#)
		]]>
	</insert>
	
	<select id="wasteTypeSingle" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			 select * from gm_waste_set t
		]]>
		<dynamic prepend="WHERE">
			<isNotEmpty prepend="AND" property="wasteId">
				<![CDATA[
					  t.waste_set_id = #wasteId:NUMERIC#
				]]>
			</isNotEmpty>
		</dynamic>
	</select>
	
	<update id="updateWasteBasicInformation" parameterClass="SimpleMap">
		<![CDATA[
			update gm_waste_set t set
				  t.waste_set_name_id = #wasteName:VARCHAR#,
				  t.waste_set_units = #CalType:VARCHAR#,
				  t.waste_set_unitprice = #UnitPrice:VARCHAR#,
				  t.waste_set_applicable_date = #WASTE_SET_APPLICABLE_DATE:VARCHAR#,
				  t.waste_set_qi_an_according_no = #WASTE_SET_QI_AN_ACCORDING_NO:VARCHAR#,
				  t.waste_set_update_date = sysdate,
				  t.waste_set_update_by = #supervisor:VARCHAR#
				where  t.waste_set_id = #wasteId:NUMERIC#
			]]>
	</update>
	
	<select id="allCompanyCustomers" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			 select * from sy_code s where s.parent_code = 'Company_Customers'
		]]>
	</select>
	
	<select id="getRevenue_approach" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			 select * from sy_code t where t.parent_code = 'REVENUE_APPROACH'
		]]>
	</select>
	
	
	<select id="getNo" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			 select * from gm_waste
		]]>
	</select>
	
	<select id="getEndNo" parameterClass="SimpleMap" resultClass="string">
		<![CDATA[
			select temp.waste_no from (select * from gm_waste t order by substr(t.waste_no,9,10) desc) temp where rownum = 1
		]]>
	</select>
	
	<select id="allInformation" parameterClass="SimpleMap" resultClass="SimpleMap">
		<![CDATA[
			 select s.code_name as waste_type,
				      get_code_name(g.waste_units) waste_units,
				      g.waste_unitprice,
				      g.waste_number,
				      g.waste_total,
       				  nvl(s1.code_name,g.company_other)  as COMPANY_CUSTOMERS1,
       				  to_char(g.CREATE_DATE,'YYYY-MM-DD HH24:mi:ss') as CREATE_DATE
				 from gm_waste g, sy_code s,sy_code s1
				where s.code_id = g.waste_type
				and g.cpny_id=#cpny_id:varchar# and s.parent_code=#type:varchar#
				and s1.code_id=g.company_customers
		]]>
			<isNotEmpty prepend="AND" property="StartTime">
				<![CDATA[
					  to_char(g.create_date,'yyyy-MM-dd') >= #StartTime:VARCHAR#
				]]>
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="EndTime">
				<![CDATA[
					  to_char(g.create_date,'yyyy-MM-dd') <= #EndTime:VARCHAR#
				]]>
			</isNotEmpty>
			<isNotEmpty prepend="AND" property="wasteType">
				<![CDATA[
					  g.WASTE_TYPE = #wasteType:varchar#
				]]>
			</isNotEmpty>
	</select>
	
	<select id="getSeq" parameterClass="SimpleMap" resultClass="int">
		<![CDATA[
			SELECT GM_WASTE_SEQ.NEXTVAL FROM DUAL
		]]>
	</select>
</sqlMap>