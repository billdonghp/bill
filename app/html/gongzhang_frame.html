<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>人事管理</title>
    <link href="../css/PublicStyle.css" rel="stylesheet" />
    <link href="../css/wkd_main_wap.css" rel="stylesheet" />
</head>

<body>
    <div class="rs_titleTag">
        <a href="#" class="act" sType="2">等待裁决</a>
        <a href="#" sType="1">裁决完成</a>
    </div>
    <div class="rs_search">
        <span id="srBtn"></span><input type="search" placeholder="请输入姓名" id="keyWord" />
    </div>
    <section id="list">

    </section>
    <script type="text/template" id="template">
        {{ for(var i = 0; i
        < it.data.list.length;i++) { }} <div class="rs_mainBox {{=i > 0? 'pt0': ''}}">
            <div class="rsBoxMsg p0">
                <div class="rs_jbBox">
                    <div class="rs_jbTitel" onclick="chkItems(this);" tapmode AFFIRMNO="{{=it.data.list[i].AFFIRM_NO}}">
                        <h1>{{=it.data.list[i].CHINESENAME}}</h1>
                        <span>是否外借：{{=it.data.list[i].ISLEND}}</span>
                    </div>
                    <div class="rs_jbMsg">
                        <div class="rs_jsMsgL open-win" win="gongzhang_Details" login="true" param='{"DOCUMENTNO":"{{=it.data.list[i].DOCUMENTNO}}"}'>
                            <h1><span class="zm">{{=it.data.list[i].CODE_NAME}}</span></h1>
                            <h2>
                              <p>部门：{{=it.data.list[i].APPLYDEPTNAME}}</p>
                              <p>使用日期：{{=it.data.list[i].USEDATE}}</p>
				                  		<p>接收单位：{{=it.data.list[i].DEPTNAME}}</p>
                            </h2>
                            <p>{{=it.data.list[i].USEINFORMATION}}</p>
                        </div>

                        <div class="rs_jbMsgR">
                            {{? it.data.list[i].AFFIRM_FLAG == 0 && sType == 2 }}
                            <a href="javascript:void(0)" tapmode onclick="fnPostAffirm(1,this,0);" AFFIRMNO="{{=it.data.list[i].AFFIRM_NO}}">通过</a>
                            <a href="javascript:void(0)" class="red" tapmode onclick="fnPostAffirm(2,this,0);" AFFIRMNO="{{=it.data.list[i].AFFIRM_NO}}">否决</a> {{?? it.data.list[i].ACTIVE == 1}}
                            <div class="rs_cjwcz"></div>
                            {{?? it.data.list[i].ACTIVE == 2}}
                            <div class="rs_cjyfj"></div>
                            {{?? it.data.list[i].ACTIVE == 0}}
                            <div class="rs_cjspz"></div>
                            {{?}}
                        </div>
                    </div>
                </div>
            </div>
            </div>
            {{ } }}
    </script>
    <div class="rs_cjBtn plbtnD none">
        <button class="red plbtn" tapmode onclick="fnPostAffirm(2,this,1);">批量否决</button>
        <button class="plbtn" tapmode onclick="fnPostAffirm(1,this,1);">批量通过</button>
    </div>
    <div class="rs_mainBox pt50 bottomLoading" id="loading"></div>
</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/jquery-3.1.1.js"></script>
<script type="text/javascript" src="../script/common.js"></script>
<script type="text/javascript" src="../script/remotedb.js"></script>
<script type="text/javascript" src="../script/doT.min.js"></script>
<script type="text/javascript">
    var pageindex = 0,
        sType = 2;
    apiready = function() {
        loginState();
        pageInit();
        getJBList();
        domOprate();
    }

    function pageInit() {
        $("#list,#loading").html("");
        pageindex = 0;
        //上拉
        upPull();

        //下拉
        api.setCustomRefreshHeaderInfo({
            bgColor: '#f0f0f0'
        }, function() {
            $("#list,#loading").html("");
            $(".rs_cjBtn").addClass("none")
            pageindex = 0;
            upPull();
            getJBList();
        });

        //手动下拉
        api.addEventListener({
            name: 'headerLoading'
        }, function(ret, err) {
            api.refreshHeaderLoading();
        });

        api.addEventListener({
            name: 'plopration'
        }, function(ret, err) {
            var hs = $(".rs_jbTitel h1");
            var plbtn = $(".rs_cjBtn");
            (hs.hasClass("radio") || hs.hasClass("radioAct")) ? hs.removeClass(): hs.addClass("radio");
            (hs.hasClass("radio") || hs.hasClass("radioAct")) ? plbtn.removeClass("none"): plbtn.addClass("none");
        });
    }

    function upPull() {
        //上拉加载
        api.addEventListener({
            name: 'scrolltobottom',
            extra: {
                threshold: 10 // 距离底部还有多少触发scrolltobottom事件
            }
        }, function(ret, err) {
            pageindex += 1;
            getJBList();
        });
    }

    function domOprate() {
        $(".rs_titleTag a").click(function() {
            if (!$(this).hasClass("act")) {
                $(".rs_titleTag a").removeClass("act");
                $(this).addClass("act");
                sType = $(this).attr("sType");
                pageInit();
                getJBList();
                visbtnPL();
            }
        });

        $("#srBtn").click(function() {
            pageInit();
            getJBList();
        });

        $("#keyWord").on('keypress', function(e) {
            var keycode = e.which || e.keyCode
            if (keycode === 13) {
                e.preventDefault()
                pageInit();
                getJBList();
            }
        });
    }

    function visbtnPL() {
        var jsfun = 'cgPl();';
        api.execScript({
            name: 'gongzhang',
            script: jsfun
        });
    }

    function chkItems(obj) {
        var _this = $(obj).find("h1");
        _this.hasClass("radioAct") ? _this.removeClass().addClass("radio") : (_this.hasClass("radio") ? _this.addClass("radioAct") : "")
    }

    function getJBList() {
        fnPost('affirmInfo', {
            body: JSON.stringify({
                content: lisType.sealAffirm,
                currentPage: pageindex,
                key: $api.byId('keyWord').value,
                qryType: sType
            })
        }, true, function(ret, err) {
            if (ret && ret.resultCode == 200) {
                pageindex == 0 ? api.refreshHeaderLoadDone() : "";
                if (ret.data && ret.data.list && ret.data.list.length > 0) {
                    jbList(ret, pageindex);
                } else {
                    $api.html($api.byId('loading'), "没有数据啦");
                    api.removeEventListener({
                        name: 'scrolltobottom'
                    });
                }
            } else {
                api.toast({
                    msg: '网络不佳，请重试',
                    duration: 2000,
                    location: 'bottom'
                });
            }
        });
    }

    function jbList(data_, index_) {
        var list = $api.byId('list');
        var tempFn = doT.template($api.byId('template').innerHTML);
        var resultHTML = tempFn(data_);
        index_ == 0 ? $api.html(list, resultHTML) : $api.append(list, resultHTML);
        api.parseTapmode();
        fnReadyOpenWin();
    }

    //手动刷新
    function fnRefreshHeaderLoading() {
        api.refreshHeaderLoading();
    };

    function fnPostAffirm(fg, obj, ispl) {
        if (ispl == 1) {
            var hs = $(".rs_jbTitel h1");
            var affirmNoStr = "";

            $.each(hs, function(index, model) {
                if ($(model).hasClass("radioAct")) {
                    affirmNoStr += $(model).parent().attr("AFFIRMNO") + ",";
                }
            });
            if (affirmNoStr == "") {
                api.toast({
                    msg: '请选择要审批的项',
                    duration: 2000,
                    location: 'bottom'
                });
                return;
            } else {
                affirmNoStr = affirmNoStr.substr(0, affirmNoStr.length - 1);
            }
        } else {
            affirmNoStr = $(obj).attr("AFFIRMNO");
        }

        postAffirm(affirmNoStr, fg);
    }

    function postAffirm(affirmNoStr, fg) {
        fnPost('affirm', {
            body: JSON.stringify({
                affirmNo: affirmNoStr,
                affirmRemark: "",
                content: lisType.sealAffirm,
                flag: fg
            })
        }, true, function(ret, err) {
            if (ret && ret.resultCode == 200) {
                api.alert({
                    title: '审批成功',
                    msg: '审批-' + (fg == 1 ? "通过" : "否决"),
                }, function(ret, err) {
                    window.scrollTo('0', '0');
                    api.sendEvent({
                        name: 'headerLoading'
                    });
                });
            } else {
                api.toast({
                    msg: '网络不佳，请重试',
                    duration: 2000,
                    location: 'bottom'
                });
            }
        });
    }
</script>

</html>
