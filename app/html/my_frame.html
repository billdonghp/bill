<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>我的</title>
    <link href="../css/PublicStyle.css" rel="stylesheet" />
    <link href="../css/wkd_main_wap.css" rel="stylesheet" />
</head>

<body>
    <section id="list">

    </section>
    <script type="text/template" id="template">
        <div class="rs_myBgBox">
            <img src="../image/logo.png">
            <h1>{{=it.data.CHINESENAME}}</h1>
            <a href="javascript:void(0)" id="frobj" onclick="chagFrr(this);" tapmode></a>
        </div>
        <div class="rs_zwlist">
            <ul>
                <li><span>部门</span>
                    <p>{{=it.data.DEPT_NAME}}</p>
                </li>
                <li><span>职务</span>
                    <p>{{=it.data.POST_CODE_NAME}}</p>
                </li>
            </ul>
        </div>
        <div class="rs_mainBox">
            <div class="rsBoxMsg p0 bg" style="margin-top:45px;">
                <div class="rs_sqlistBtn">
                    {{? it.data.IS_AD == 0}}
                    <a href="javascript:void(0)" onclick="openMi();" tapmode>
                        <img src="../image/menu_btn15.png">
                        <p>修改密码</p>
                    </a>
                    {{?}}
                    <a href="javascript:void(0)" class="open-win" win="version" login="true">
                        <img src="../image/menu_btn16.png">
                        <p>版本检测</p>
                    </a>
                </div>
            </div>
            <div class="rs_inpItem margintop35">
                <button tapmode onclick="fnLoginOut();">退出登录</button>
            </div>
        </div>


    </script>

</body>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/jquery-3.1.1.js"></script>
<script type="text/javascript" src="../script/common.js"></script>
<script type="text/javascript" src="../script/remotedb.js"></script>
<script type="text/javascript" src="../script/doT.min.js"></script>
<script type="text/javascript">
    var frList, showpage = false;
    apiready = function() {
        loginState();
        initPage();
        postFR();
    };

    function openMi() {
        var user = $api.getStorage('currUser');
        if (user && user.data.IS_AD == 0) {
            api.openWin({
                name: 'mima',
                url: 'widget://html/mima.html'
            });
        } else {
            toast('AD用户不可修改密码');
        }
    }

    function initPage() {
        $("#list").html("");
        api.setCustomRefreshHeaderInfo({
            bgColor: '#f0f0f0'
        }, function() {
            $("#list").html("");
            postFR();
        });

        api.addEventListener({
            name: 'headerLoading'
        }, function(ret, err) {
            api.refreshHeaderLoading();
        });
    }

    function postFR() {
        fnPost('codeInfo/getCpnyList?parentCode=1', {
            parentCode: 1
        }, true, function(ret, err) {
            if (ret && ret.resultCode == 200) {
                if (ret.data && ret.data.list && ret.data.list.length > 0) {
                    frList = ret.data.list;
                    postPerson(ret.data.list[0].CPNY_ID);
                } else {
                    pageError();
                }
            } else {
                api.toast({
                    msg: '网络不佳，请重试',
                    duration: 2000,
                    location: 'bottom'
                });
            }
        }, true);
    }

    function postPerson(cpnyId) {
        fnPost('userInfo?cpnyId=' + cpnyId, {
            cpnyId: cpnyId
        }, true, function(ret, err) {
            api.refreshHeaderLoadDone();
            if (ret && ret.resultCode == 200) {
                var currFr = frList.filter(function(e) {
                    return e.CPNY_ID == cpnyId;
                });
                $api.setStorage('currUser', ret);
                $api.setStorage('currFr', currFr);
                if (ret.data) {
                    jbList(ret, currFr);
                } else {
                    pageError();
                }
            } else {
                api.toast({
                    msg: '网络不佳，请重试',
                    duration: 2000,
                    location: 'bottom'
                });
            }
        });
    }

    function jbList(data_, currFr) {
        var list = $api.byId('list');
        var tempFn = doT.template($api.byId('template').innerHTML);
        var resultHTML = tempFn(data_);
        $api.html(list, resultHTML);
        $("#frobj").html(currFr[0].CODE_NAME);
        fnReadyOpenWin();
        api.parseTapmode();
    }


    function chagFrr(obj) {
        var _this = $(obj);
        actMenu("请选择法人", JSON.parse(JSON.stringify(frList).replace(/CODE_NAME/g, "text")), function(ret, err) {
            if (ret && ret.items && ret.items.length > 0) {
                postPerson(ret.items[0].CPNY_ID);
            }
        });
    }

    function fnLoginOut() {
        fnPost('logout', {}, true, function(ret, err) {
            if (ret && ret.resultCode == 200) {
                api.removePrefs({
                    key: 'tokenKey'
                });
                locatDouApp("退出登录");

            } else {
                api.toast({
                    msg: '网络不佳，请重试',
                    duration: 2000,
                    location: 'bottom'
                });
            }
        });
    }
</script>

</html>
