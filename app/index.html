<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,initial-scale=1.0,width=device-width" />
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>Hello APP</title>
    <link rel="stylesheet" type="text/css" href="./css/api.css" />
    <link rel="stylesheet" type="text/css" href="./css/wkd_main_wap.css" />
    <style>
        header {
            background-color: #7885F8;
        }

        h1 {
            height: 50px;
            line-height: 50px;
            color: #ffffff;
            font-size: 20px;
            text-align: center;
            font-weight: normal;
        }

        .header-item {
            display: none;
        }

        .header-item-act {
            display: block;
        }

        footer {
            display: -webkit-box;
            display: -webkit-flex;
            display: flex;
            -webkit-box-orient: horizontal;
            -webkit-flex-flow: row;
            flex-flow: row;
            width: 100%;
            height: 50px;
            background-color: #000;
            border-top: 1px solid #d1d1d1;
        }
    </style>
</head>

<body>
    <header id="header">
        <div class="header-item header-item-act">
            <h1>申请列表</h1></div>
        <div class="header-item">
            <h1>信息查看</h1></div>
        <div class="header-item">
            <h1>待裁决列表</h1></div>
        <div class="header-item">
            <h1>我的</h1></div>
    </header>
    <section id="section">
        <div class="errd loading">
            <span>网络出现异常，请点击重新加载</span>
            <div class="rs_cjBtn">
                <button class="plbtn" tapmode onclick="reload();">重新加载</button>
            </div>
        </div>
    </section>
    <footer id="footer" class="foot_buttom">
        <div class="home act" tapmode="active" onclick="fnChange(0)"><span>申请</span></div>
        <div class="ck" tapmode="active" onclick="fnChange(1)"><span>查看</span></div>
        <div class="sp" tapmode="active" onclick="fnChange(2)"><span>审批</span></div>
        <div class="my" tapmode="active" onclick="fnChange(3)"><span>我的</span></div>
    </footer>

</body>
<script type="text/javascript" src="./script/remotedb.js"></script>
<script type="text/javascript" src="./script/api.js"></script>
<script type="text/javascript" src="./script/common.js"></script>

<script type="text/javascript">
    var appParam;
    apiready = function() {
        dousPost();
        fnInitListener();
        fnInit();
        appParam = api.appParam;
        if (appParam) {
            if (api.systemType == 'ios') {
                loadInfo(appParam);
            }
        } else {
            loginToast(function(islogin) {
                if (islogin) {
                    fnChange(2);
                }
            }, "index");
        }
    };

    function reload() {
        appParam = api.appParam;
        if (appParam) {
            loadInfo(appParam)
        }
    }

    function dousPost() {
        api.addEventListener({
            name: 'appintent'
        }, function(ret, err) {
            appParam = ret.appParam;
            loadInfo(appParam);
        });
    }

    function loadInfo(Param) {
        if (Param) {
            try {
                // var username = CryptoJS.enc.Base64.parse(appParam.username).toString(CryptoJS.enc.Utf8);
                // var password = CryptoJS.enc.Base64.parse(appParam.password).toString(CryptoJS.enc.Utf8);
                // postLogin(username, password);
                if (api.systemType == 'ios') {
                    Param = JSON.parse(Param);
                }
            } catch (e) {}

            postLogin(Param.username.replace(/[\r\n]/g, ""), Param.password.replace(/[\r\n]/g, ""));
        }
    }

    function postLogin(username, pwd) {
        fnPost('login', {
            body: JSON.stringify({
                username: username,
                password: pwd
            })
        }, false, function(ret, err) {
            if (ret && ret.resultCode == 200) {
                api.setPrefs({
                    key: 'tokenKey',
                    value: ret.authorization
                });
                $api.rmStorage('currUser');
                fnChange(2);

                $api.setStorage('username', username);
                api.sendEvent({
                    name: 'headerLoading'
                });
            } else {
                api.alert({
                    title: '提示',
                    msg: '用户名或密码错误',
                }, function(ret, err) {
                    locatDouApp("跳转-用户名密码错误");
                });
            }
        });
    }



    var headers, footers, headerHeight, footerHeight;

    function fnInit() {
        var header = $api.byId('header');
        var footer = $api.byId('footer');

        headers = $api.domAll(header, '.header-item');
        footers = $api.domAll(footer, 'div');

        for (var i = 0; i < headers.length; i++) {
            $api.fixIos7Bar(headers[i]);
        }

        headerHeight = $api.offset(header).h;
        footerHeight = $api.offset(footer).h;
    };

    var frames = ['shenqing_frame', 'chakan_frame', 'main_frame', 'my_frame'];

    function fnChange(index) {
        $api.html($api.byId('section'), '');
        for (var i = 0; i < headers.length; i++) {
            if (index == i) {
                $api.addCls(headers[i], 'header-item-act');
                $api.addCls(footers[i], 'act');

                api.openFrame({
                    name: frames[i],
                    url: './html/' + frames[i] + '.html',
                    bounces: true,
                    bgColor: '#e9f2f9',
                    customRefreshHeader: 'UIPullRefresh',
                    vScrollBarEnabled: false,
                    hScrollBarEnabled: false,
                    rect: {
                        x: 0,
                        y: headerHeight,
                        w: 'auto',
                        h: api.frameHeight - headerHeight - footerHeight
                    }
                });
            } else {
                $api.removeCls(headers[i], 'header-item-act');
                $api.removeCls(footers[i], 'act');

                api.setFrameAttr({
                    name: frames[i],
                    hidden: true
                });
            }
        }
    };


    function fnInitListener() {
        var flag = false;
        api.addEventListener({
            name: 'keyback'
        }, function(ret, err) {
            if (false == flag) {
                api.toast({
                    msg: '再按一次退出',
                    duration: 2000,
                    location: 'bottom'
                });
                flag = true;
                setTimeout(function() {
                    flag = false;
                }, 2000);
            } else {
                api.closeWidget({
                    silent: true
                });
            }
        });
    };
</script>

</html>
